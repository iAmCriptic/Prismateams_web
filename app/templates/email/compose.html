{% extends "base.html" %}

{% block title %}{{ _('email.compose.page_title') }}{% endblock %}

{% block extra_css %}
<!-- Quill Editor CSS -->
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<style>
    /* Mobile Full-Screen Mode */
    @media (max-width: 767.98px) {
        .email-composer {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 1050;
            border-radius: 0;
            margin: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .email-composer-header {
            border-radius: 0;
            flex-shrink: 0;
        }
        
        .email-composer-toolbar {
            flex-shrink: 0;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .email-composer-toolbar .ql-toolbar {
            min-width: max-content;
            white-space: nowrap;
        }
        
        .email-composer-body {
            flex: 1;
            overflow: hidden;
            display: flex;
        }
        
        .quill-editor-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        #editor {
            flex: 1;
            min-height: auto;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .email-composer-footer {
            flex-shrink: 0;
            border-radius: 0;
        }
        
        /* Ensure inputs don't zoom on focus (iOS) */
        .email-composer input[type="text"],
        .email-composer input[type="email"] {
            font-size: 16px;
        }
        
        /* Full-screen wrapper */
        .email-compose-wrapper {
            position: relative;
        }
    }
    
    /* Desktop styles */
    .email-composer {
        background: var(--bs-body-bg);
        border-radius: 0.375rem;
    }
    
    .email-composer-header {
        background: var(--bs-secondary-bg);
        border-bottom: 1px solid var(--bs-border-color);
        padding: 0.5rem 1rem;
        border-radius: 0.375rem 0.375rem 0 0;
    }
    
    .email-composer-toolbar {
        background: var(--bs-secondary-bg);
        border-bottom: 1px solid var(--bs-border-color);
        padding: 0.5rem;
    }
    
    .email-composer-body {
        background: #ffffff;
        min-height: 400px;
    }
    
    [data-bs-theme="dark"] .email-composer-body {
        background: #1a202c;
    }
    
    .quill-editor-container {
        position: relative;
    }
    
    #editor {
        min-height: 350px;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        font-size: 14px;
        color: #333333;
    }
    
    [data-bs-theme="dark"] #editor {
        color: #e2e8f0;
    }
    
    .ql-container {
        font-family: inherit;
        font-size: inherit;
    }
    
    [data-bs-theme="dark"] .ql-editor {
        color: #e2e8f0;
    }
    
    [data-bs-theme="dark"] .ql-snow {
        border-color: #4a5568;
        background: #2d3748;
    }
    
    [data-bs-theme="dark"] .ql-toolbar {
        background: #2d3748;
        border-color: #4a5568;
    }
    
    [data-bs-theme="dark"] .ql-stroke {
        stroke: #e2e8f0;
    }
    
    [data-bs-theme="dark"] .ql-fill {
        fill: #e2e8f0;
    }
    
    [data-bs-theme="dark"] .ql-picker-label {
        color: #e2e8f0;
    }
    
    .email-preview-wrapper {
        background: var(--bs-body-bg);
        border-top: 1px solid var(--bs-border-color);
    }
    
    .email-preview-wrapper.collapsed .email-preview-body {
        display: none;
    }
    
    .email-preview-header {
        padding: 0.75rem 1rem;
        background: var(--bs-secondary-bg);
        border-bottom: 1px solid var(--bs-border-color);
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 0.5rem;
    }
    
    .email-preview-toggle {
        border: none;
        background: none;
        color: var(--bs-link-color);
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        font-weight: 600;
        cursor: pointer;
        padding: 0;
    }
    
    .email-preview-toggle .chevron {
        transition: transform 0.2s ease;
    }
    
    .email-preview-wrapper:not(.collapsed) .email-preview-toggle .chevron {
        transform: rotate(90deg);
    }
    
    .email-preview-body {
        padding: 1.5rem;
        background: var(--bs-body-bg);
    }
    
    .email-preview-content {
        background: #f4f6f8;
        border-radius: 0.75rem;
        border: 1px solid #e2e8f0;
        overflow: hidden;
        min-height: 260px;
        position: relative;
    }
    
    [data-bs-theme="dark"] .email-preview-content {
        background: #111827;
        border-color: #1f2937;
    }
    
    .email-preview-placeholder {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        padding: 3rem 1rem;
        color: #64748b;
        font-size: 0.95rem;
        text-align: center;
    }
    
    [data-bs-theme="dark"] .email-preview-placeholder {
        color: #94a3b8;
    }
    
    .email-preview-spinner {
        position: absolute;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(255, 255, 255, 0.7);
    }
    
    [data-bs-theme="dark"] .email-preview-spinner {
        background: rgba(15, 23, 42, 0.7);
    }
    
    .email-composer-footer {
        background: var(--bs-secondary-bg);
        border-top: 1px solid var(--bs-border-color);
        padding: 1rem;
        border-radius: 0 0 0.375rem 0.375rem;
    }
    
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-10 mx-auto">
        <nav aria-label="breadcrumb" class="d-none d-md-block">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{{ url_for('email.index') }}">{{ _('email.compose.breadcrumb.index') }}</a></li>
                <li class="breadcrumb-item active">{{ _('email.compose.breadcrumb.current') }}</li>
            </ol>
        </nav>
        
        <div class="email-compose-wrapper">
        <div class="card email-composer">
            <div class="email-composer-header">
                <h4 class="mb-0"><i class="bi bi-pencil-square me-2"></i>{{ _('email.compose.card_title') }}</h4>
            </div>
            <div class="card-body p-0">
                <form method="POST" action="{{ url_for('email.compose') }}" enctype="multipart/form-data" id="emailComposeForm">
                    <!-- Hidden fields for reply/forward metadata -->
                    <input type="hidden" name="in_reply_to" value="{{ in_reply_to|default('') }}">
                    <input type="hidden" name="references" value="{{ references|default('') }}">
                    <input type="hidden" name="forward_attachment_ids" value="{{ forward_attachment_ids|default('') }}">
                    <input type="hidden" name="original_attachment_ids" id="originalAttachmentIds" value="{{ original_attachment_ids|default('') }}">
                    <input type="hidden" name="body" id="bodyHtml" value="">
                    
                    <div class="p-3 border-bottom">
                        <div class="mb-3">
                            <label for="to" class="form-label fw-bold">{{ _('email.compose.form.to') }}</label>
                            <input type="text" class="form-control" id="to" name="to" placeholder="{{ _('email.compose.form.to_placeholder') }}" value="{{ to|default('') }}" required>
                            <div class="form-text">{{ _('email.compose.form.to_help') }}</div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="cc" class="form-label fw-bold">{{ _('email.compose.form.cc') }}</label>
                            <input type="text" class="form-control" id="cc" name="cc" placeholder="{{ _('email.compose.form.cc_placeholder') }}" value="{{ cc|default('') }}">
                        </div>
                        
                        <div class="mb-3">
                            <label for="subject" class="form-label fw-bold">{{ _('email.compose.form.subject') }}</label>
                            <input type="text" class="form-control" id="subject" name="subject" value="{{ subject|default('') }}" required>
                        </div>
                    </div>
                    
                    <!-- Rich Text Editor -->
                    <div class="email-composer-toolbar">
                        <div id="toolbar-container"></div>
                    </div>
                    <div class="email-composer-body">
                        <div class="quill-editor-container">
                            <div id="editor"></div>
                        </div>
                    </div>
                    <div class="email-preview-wrapper collapsed" id="emailPreviewWrapper">
                        <div class="email-preview-header">
                            <button type="button" class="email-preview-toggle" id="emailPreviewToggle" aria-expanded="false">
                                <span class="chevron"><i class="bi bi-chevron-right"></i></span>
                                <span>{{ _('email.compose.preview.toggle') }}</span>
                            </button>
                            <span class="text-muted small" id="emailPreviewStatus">{{ _('email.compose.preview.status_hidden') }}</span>
                        </div>
                        <div class="email-preview-body">
                            <div class="email-preview-content" id="emailPreviewContent">
                                <div class="email-preview-placeholder">
                                    <i class="bi bi-envelope-paper"></i>
                                    <span>{{ _('email.compose.preview.placeholder') }}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="email-composer-footer">
                        <div class="mb-3">
                            <label for="attachments" class="form-label fw-bold">
                                <i class="bi bi-paperclip me-1"></i>{{ _('email.compose.attachments.label') }}
                            </label>
                            <input type="file" class="form-control" id="attachments" name="attachments" multiple>
                            <div class="form-text">{{ _('email.compose.attachments.help') }}</div>
                        </div>
                        <div class="form-text mb-3">{{ _('email.compose.attachments.footer_note') }}</div>
                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-accent">
                                <i class="bi bi-send me-1"></i> {{ _('email.compose.buttons.send') }}
                            </button>
                            <a href="{{ url_for('email.index') }}" class="btn btn-outline-secondary">
                                <i class="bi bi-x me-1"></i> {{ _('email.compose.buttons.cancel') }}
                            </a>
                        </div>
                    </div>
                </form>
            </div>
        </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Quill Editor JS -->
<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
<script>
const EMAIL_COMPOSE = {{ current_translations.get('email', {}).get('compose', {})|tojson }};
const EDITOR_I18N = EMAIL_COMPOSE.editor || {};
const PREVIEW_I18N = EMAIL_COMPOSE.preview || {};
const COMPOSE_MESSAGES = EMAIL_COMPOSE.messages || {};

document.addEventListener('DOMContentLoaded', function() {
    // Check if mobile
    var isMobile = window.matchMedia('(max-width: 767.98px)').matches;
    var previewUrl = "{{ url_for('email.preview_custom_email') }}";
    
    // Mobile-optimized toolbar (fewer options, horizontal scroll)
    var mobileToolbarOptions = [
        ['bold', 'italic', 'underline'],
        [{ 'color': [] }, { 'background': [] }],
        [{ 'size': ['small', false, 'large'] }],
        [{ 'list': 'ordered'}, { 'list': 'bullet' }],
        ['link'],
        ['clean']
    ];
    
    // Desktop full toolbar
    var desktopToolbarOptions = [
        [{ 'header': [1, 2, 3, 4, 5, 6, false] }],
        [{ 'font': [] }],
        [{ 'size': ['small', false, 'large', 'huge'] }],
        ['bold', 'italic', 'underline', 'strike'],
        [{ 'color': [] }, { 'background': [] }],
        [{ 'script': 'sub'}, { 'script': 'super' }],
        [{ 'list': 'ordered'}, { 'list': 'bullet' }],
        [{ 'indent': '-1'}, { 'indent': '+1' }],
        [{ 'align': [] }],
        ['blockquote', 'code-block'],
        ['link', 'image'],
        ['clean']
    ];
    
    var toolbarOptions = isMobile ? mobileToolbarOptions : desktopToolbarOptions;
    
    var quill = new Quill('#editor', {
        theme: 'snow',
        modules: {
            toolbar: toolbarOptions
        },
        placeholder: EDITOR_I18N.placeholder || ''
    });
    var previewContent = document.getElementById('emailPreviewContent');
    var previewStatus = document.getElementById('emailPreviewStatus');
    var subjectInput = document.getElementById('subject');
    var previewSpinner = null;
    var previewDebounce;
    var previewRequestId = 0;
    var previewWrapper = document.getElementById('emailPreviewWrapper');
    var previewToggle = document.getElementById('emailPreviewToggle');
    var previewOpen = false;
    
    // Mobile: Focus management for keyboard
    if (isMobile) {
        var toInput = document.getElementById('to');
        var ccInput = document.getElementById('cc');
        
        // Auto-focus first empty field
        if (toInput && !toInput.value) {
            setTimeout(function() {
                toInput.focus();
            }, 300);
        } else if (subjectInput && !subjectInput.value) {
            setTimeout(function() {
                subjectInput.focus();
            }, 300);
        }
        
        // Handle input focus for smooth keyboard
        [toInput, ccInput, subjectInput].forEach(function(input) {
            if (input) {
                input.addEventListener('focus', function() {
                    // Scroll to input on mobile
                    setTimeout(function() {
                        input.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }, 300);
                });
            }
        });
    }
    
    function setPreviewPlaceholder() {
        if (previewSpinner) {
            previewSpinner.remove();
            previewSpinner = null;
        }
        previewContent.innerHTML = '<div class="email-preview-placeholder"><i class="bi bi-envelope-paper"></i><span>' + (PREVIEW_I18N.placeholder || '') + '</span></div>';
        previewStatus.textContent = PREVIEW_I18N.status_hidden || '';
    }
    
    function setPreviewLoading() {
        if (previewSpinner) {
            previewSpinner.remove();
        }
        previewSpinner = document.createElement('div');
        previewSpinner.className = 'email-preview-spinner';
        const loadingLabel = PREVIEW_I18N.loading_label || '';
        previewSpinner.innerHTML = '<div class="spinner-border text-primary" role="status"><span class="visually-hidden">' + loadingLabel + '</span></div>';
        previewContent.appendChild(previewSpinner);
        previewStatus.textContent = PREVIEW_I18N.status_loading || '';
    }
    
    function setPreviewError(message) {
        if (previewSpinner) {
            previewSpinner.remove();
            previewSpinner = null;
        }
        const errorMessage = message || PREVIEW_I18N.error_loading || '';
        previewContent.innerHTML = '<div class="email-preview-placeholder text-danger"><i class="bi bi-exclamation-triangle"></i><span>' + errorMessage + '</span></div>';
        previewStatus.textContent = PREVIEW_I18N.error_title || '';
    }
    
    function applyPreview(html) {
        if (previewSpinner) {
            previewSpinner.remove();
            previewSpinner = null;
        }
        previewContent.innerHTML = html;
        previewStatus.textContent = PREVIEW_I18N.status_ready || '';
    }
    
    function updatePreview() {
        if (!previewOpen) {
            return;
        }
        var textContent = quill.getText().trim();
        if (!textContent) {
            setPreviewPlaceholder();
            return;
        }
        var htmlContent = quill.root.innerHTML;
        setPreviewLoading();
        var body = {
            subject: subjectInput ? subjectInput.value : '',
            body: htmlContent
        };
        var requestId = ++previewRequestId;
        fetch(previewUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            credentials: 'same-origin',
            body: JSON.stringify(body)
        }).then(function(response) {
            if (!response.ok) {
                const template = COMPOSE_MESSAGES.server_error || '';
                const message = template.includes('{status}') ? template.replace('{status}', response.status) : template || ('Server error ' + response.status);
                throw new Error(message);
            }
            return response.json();
        }).then(function(data) {
            if (requestId !== previewRequestId) {
                return;
            }
            if (data && data.html) {
                applyPreview(data.html);
            } else if (data && data.error) {
                setPreviewError(data.error);
            } else {
                setPreviewError(PREVIEW_I18N.unknown_response || '');
            }
        }).catch(function(error) {
            console.error(error);
            if (requestId === previewRequestId) {
                setPreviewError(error.message || PREVIEW_I18N.error_loading || '');
            }
        });
    }
    
    function schedulePreview() {
        clearTimeout(previewDebounce);
        previewDebounce = setTimeout(updatePreview, 350);
    }
    
    function togglePreview() {
        previewOpen = !previewOpen;
        previewWrapper.classList.toggle('collapsed', !previewOpen);
        previewToggle.setAttribute('aria-expanded', previewOpen ? 'true' : 'false');
        previewStatus.textContent = previewOpen ? (PREVIEW_I18N.status_loading || '') : (PREVIEW_I18N.status_hidden || '');
        if (previewOpen) {
            updatePreview();
        }
    }
    
    if (previewToggle) {
        previewToggle.addEventListener('click', togglePreview);
    }
    
    // Set initial content if body exists
    {% if body is defined and body %}
    var initialContent = {{ body|tojson|safe }};
    if (initialContent) {
        // Try to parse as HTML first
        try {
            quill.clipboard.dangerouslyPasteHTML(initialContent);
        } catch (e) {
            quill.setText(initialContent);
        }
    }
    {% endif %}
    
    // Original E-Mail einfach am Ende einfügen
    {% if is_reply and original_email %}
    (function() {
        setTimeout(function() {
            try {
                // Einfacher Header
                var headerText = '{{ _('email.view.header.from') }} ' + {{ original_email.sender|decode_email_header|tojson|safe }} + '\n';
                headerText += '{{ _('email.view.header.to') }} ' + {{ original_email.recipients|decode_email_header|tojson|safe }} + '\n';
                {% if original_email.cc %}
                headerText += '{{ _('email.view.header.cc') }} ' + {{ original_email.cc|decode_email_header|tojson|safe }} + '\n';
                {% endif %}
                headerText += '{{ _('email.view.header.date') }} {{ original_email.received_at.strftime('%d.%m.%Y %H:%M') if original_email.received_at else original_email.sent_at.strftime('%d.%m.%Y %H:%M') }}\n';
                headerText += '{{ _('email.view.header.subject') }} ' + {{ original_email.subject|decode_email_header|tojson|safe }} + '\n\n';
                
                // Trennlinie
                var separator = '\n##- Bitte geben Sie Ihre Antwort über dieser Zeile ein. -##\n\n';
                
                // Original-E-Mail Text
                var originalText = '';
                {% if original_email.body_text %}
                originalText = {{ original_email.body_text|tojson|safe }};
                {% elif original_html %}
                // HTML zu Text konvertieren (einfach)
                var htmlContent = {{ original_html|tojson|safe }};
                var tempDiv = document.createElement('div');
                tempDiv.innerHTML = htmlContent;
                originalText = tempDiv.textContent || tempDiv.innerText || '';
                {% endif %}
                
                // Alles zusammenfügen: Header + Trennlinie + Original-Text
                var fullText = headerText + separator + originalText;
                
                // Am Ende des Editors einfügen
                var length = quill.getLength();
                quill.insertText(length - 1, fullText, 'user');
                
                // Cursor an den Anfang setzen (vor dem Header)
                quill.setSelection(0);
            } catch (e) {
                console.error('Fehler beim Einfügen der Original-E-Mail:', e);
            }
        }, 300);
    })();
    {% endif %}
    
    // Update hidden field before form submission
    document.getElementById('emailComposeForm').addEventListener('submit', function(e) {
        var htmlContent = quill.root.innerHTML;
        var textContent = quill.getText();
        
        // If only whitespace, show error
        if (!textContent.trim()) {
            e.preventDefault();
            alert(COMPOSE_MESSAGES.validation_error || '');
            return false;
        }
        
        // Set HTML content to hidden field
        document.getElementById('bodyHtml').value = htmlContent;
    });
    
    quill.on('text-change', schedulePreview);
    if (subjectInput) {
        subjectInput.addEventListener('input', schedulePreview);
    }
    
});
</script>
{% endblock %}



