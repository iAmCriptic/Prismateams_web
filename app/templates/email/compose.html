{% extends "base.html" %}

{% block title %}Neue E-Mail - Team Portal{% endblock %}

{% block extra_css %}
<!-- Quill Editor CSS -->
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<style>
    /* Mobile Full-Screen Mode */
    @media (max-width: 767.98px) {
        .email-composer {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 1050;
            border-radius: 0;
            margin: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .email-composer-header {
            border-radius: 0;
            flex-shrink: 0;
        }
        
        .email-composer-toolbar {
            flex-shrink: 0;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .email-composer-toolbar .ql-toolbar {
            min-width: max-content;
            white-space: nowrap;
        }
        
        .email-composer-body {
            flex: 1;
            overflow: hidden;
            display: flex;
        }
        
        .quill-editor-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        #editor {
            flex: 1;
            min-height: auto;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .email-composer-footer {
            flex-shrink: 0;
            border-radius: 0;
        }
        
        /* Ensure inputs don't zoom on focus (iOS) */
        .email-composer input[type="text"],
        .email-composer input[type="email"] {
            font-size: 16px;
        }
        
        /* Full-screen wrapper */
        .email-compose-wrapper {
            position: relative;
        }
    }
    
    /* Desktop styles */
    .email-composer {
        background: var(--bs-body-bg);
        border-radius: 0.375rem;
    }
    
    .email-composer-header {
        background: var(--bs-secondary-bg);
        border-bottom: 1px solid var(--bs-border-color);
        padding: 0.5rem 1rem;
        border-radius: 0.375rem 0.375rem 0 0;
    }
    
    .email-composer-toolbar {
        background: var(--bs-secondary-bg);
        border-bottom: 1px solid var(--bs-border-color);
        padding: 0.5rem;
    }
    
    .email-composer-body {
        background: #ffffff;
        min-height: 400px;
    }
    
    [data-bs-theme="dark"] .email-composer-body {
        background: #1a202c;
    }
    
    .quill-editor-container {
        position: relative;
    }
    
    #editor {
        min-height: 350px;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        font-size: 14px;
        color: #333333;
    }
    
    [data-bs-theme="dark"] #editor {
        color: #e2e8f0;
    }
    
    .ql-container {
        font-family: inherit;
        font-size: inherit;
    }
    
    [data-bs-theme="dark"] .ql-editor {
        color: #e2e8f0;
    }
    
    [data-bs-theme="dark"] .ql-snow {
        border-color: #4a5568;
        background: #2d3748;
    }
    
    [data-bs-theme="dark"] .ql-toolbar {
        background: #2d3748;
        border-color: #4a5568;
    }
    
    [data-bs-theme="dark"] .ql-stroke {
        stroke: #e2e8f0;
    }
    
    [data-bs-theme="dark"] .ql-fill {
        fill: #e2e8f0;
    }
    
    [data-bs-theme="dark"] .ql-picker-label {
        color: #e2e8f0;
    }
    
    .email-composer-footer {
        background: var(--bs-secondary-bg);
        border-top: 1px solid var(--bs-border-color);
        padding: 1rem;
        border-radius: 0 0 0.375rem 0.375rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-10 mx-auto">
        <nav aria-label="breadcrumb" class="d-none d-md-block">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{{ url_for('email.index') }}">E-Mail</a></li>
                <li class="breadcrumb-item active">Neue E-Mail</li>
            </ol>
        </nav>
        
        <div class="email-compose-wrapper">
        <div class="card email-composer">
            <div class="email-composer-header">
                <h4 class="mb-0"><i class="bi bi-pencil-square me-2"></i>Neue E-Mail verfassen</h4>
            </div>
            <div class="card-body p-0">
                <form method="POST" action="{{ url_for('email.compose') }}" enctype="multipart/form-data" id="emailComposeForm">
                    <!-- Hidden fields for reply/forward metadata -->
                    <input type="hidden" name="in_reply_to" value="{{ in_reply_to|default('') }}">
                    <input type="hidden" name="references" value="{{ references|default('') }}">
                    <input type="hidden" name="forward_attachment_ids" value="{{ forward_attachment_ids|default('') }}">
                    <input type="hidden" name="body" id="bodyHtml" value="">
                    
                    <div class="p-3 border-bottom">
                        <div class="mb-3">
                            <label for="to" class="form-label fw-bold">An</label>
                            <input type="text" class="form-control" id="to" name="to" placeholder="empfaenger@example.com" value="{{ to|default('') }}" required>
                            <div class="form-text">Mehrere Empfänger mit Komma trennen</div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="cc" class="form-label fw-bold">CC (optional)</label>
                            <input type="text" class="form-control" id="cc" name="cc" placeholder="cc@example.com" value="{{ cc|default('') }}">
                        </div>
                        
                        <div class="mb-3">
                            <label for="subject" class="form-label fw-bold">Betreff</label>
                            <input type="text" class="form-control" id="subject" name="subject" value="{{ subject|default('') }}" required>
                        </div>
                    </div>
                    
                    <!-- Rich Text Editor -->
                    <div class="email-composer-toolbar">
                        <div id="toolbar-container"></div>
                    </div>
                    <div class="email-composer-body">
                        <div class="quill-editor-container">
                            <div id="editor"></div>
                        </div>
                    </div>
                    <div class="email-composer-footer">
                        <div class="mb-3">
                            <label for="attachments" class="form-label fw-bold">
                                <i class="bi bi-paperclip me-1"></i>Anhänge (optional)
                            </label>
                            <input type="file" class="form-control" id="attachments" name="attachments" multiple>
                            <div class="form-text">Mehrere Dateien auswählen möglich</div>
                        </div>
                        <div class="form-text mb-3">Der E-Mail-Footer wird automatisch hinzugefügt.</div>
                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-accent">
                                <i class="bi bi-send me-1"></i> Senden
                            </button>
                            <a href="{{ url_for('email.index') }}" class="btn btn-outline-secondary">
                                <i class="bi bi-x me-1"></i> Abbrechen
                            </a>
                        </div>
                    </div>
                </form>
            </div>
        </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Quill Editor JS -->
<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Check if mobile
    var isMobile = window.matchMedia('(max-width: 767.98px)').matches;
    
    // Mobile-optimized toolbar (fewer options, horizontal scroll)
    var mobileToolbarOptions = [
        ['bold', 'italic', 'underline'],
        [{ 'color': [] }, { 'background': [] }],
        [{ 'size': ['small', false, 'large'] }],
        [{ 'list': 'ordered'}, { 'list': 'bullet' }],
        ['link'],
        ['clean']
    ];
    
    // Desktop full toolbar
    var desktopToolbarOptions = [
        [{ 'header': [1, 2, 3, 4, 5, 6, false] }],
        [{ 'font': [] }],
        [{ 'size': ['small', false, 'large', 'huge'] }],
        ['bold', 'italic', 'underline', 'strike'],
        [{ 'color': [] }, { 'background': [] }],
        [{ 'script': 'sub'}, { 'script': 'super' }],
        [{ 'list': 'ordered'}, { 'list': 'bullet' }],
        [{ 'indent': '-1'}, { 'indent': '+1' }],
        [{ 'align': [] }],
        ['blockquote', 'code-block'],
        ['link', 'image'],
        ['clean']
    ];
    
    var toolbarOptions = isMobile ? mobileToolbarOptions : desktopToolbarOptions;
    
    var quill = new Quill('#editor', {
        theme: 'snow',
        modules: {
            toolbar: toolbarOptions
        },
        placeholder: 'Schreiben Sie hier Ihre E-Mail...'
    });
    
    // Mobile: Focus management for keyboard
    if (isMobile) {
        var toInput = document.getElementById('to');
        var ccInput = document.getElementById('cc');
        var subjectInput = document.getElementById('subject');
        
        // Auto-focus first empty field
        if (toInput && !toInput.value) {
            setTimeout(function() {
                toInput.focus();
            }, 300);
        } else if (subjectInput && !subjectInput.value) {
            setTimeout(function() {
                subjectInput.focus();
            }, 300);
        }
        
        // Handle input focus for smooth keyboard
        [toInput, ccInput, subjectInput].forEach(function(input) {
            if (input) {
                input.addEventListener('focus', function() {
                    // Scroll to input on mobile
                    setTimeout(function() {
                        input.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }, 300);
                });
            }
        });
    }
    
    // Set initial content if body exists
    {% if body is defined and body %}
    var initialContent = {{ body|tojson|safe }};
    if (initialContent) {
        // Try to parse as HTML first
        try {
            quill.clipboard.dangerouslyPasteHTML(initialContent);
        } catch (e) {
            quill.setText(initialContent);
        }
    }
    {% endif %}
    
    // Update hidden field before form submission
    document.getElementById('emailComposeForm').addEventListener('submit', function(e) {
        var htmlContent = quill.root.innerHTML;
        var textContent = quill.getText();
        
        // If only whitespace, show error
        if (!textContent.trim()) {
            e.preventDefault();
            alert('Bitte geben Sie eine Nachricht ein.');
            return false;
        }
        
        // Set HTML content to hidden field
        document.getElementById('bodyHtml').value = htmlContent;
    });
});
</script>
{% endblock %}



