{% extends "base.html" %}

{% block title %}{{ _('email.compose.page_title') }}{% endblock %}

{% block extra_css %}
<!-- Contacts CSS -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/contacts.css') }}">
<!-- Quill Editor CSS -->
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<style>
    /* Avatar-Kreise für Kontakte verwenden Akzentfarbe */
    .chip-avatar,
    .autocomplete-avatar {
        background: var(--accent-style, var(--accent-color, #0d6efd)) !important;
        color: white !important;
    }
</style>
<style>
    /* Mobile Full-Screen Mode */
    @media (max-width: 767.98px) {
        .email-composer {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 1050;
            border-radius: 0;
            margin: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .email-composer-header {
            border-radius: 0;
            flex-shrink: 0;
            position: relative;
            z-index: 1;
        }
        
        .email-composer-toolbar {
            flex-shrink: 0;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            position: relative;
            z-index: 1;
        }
        
        .email-composer-toolbar .ql-toolbar {
            min-width: max-content;
            white-space: nowrap;
        }
        
        .email-composer-body {
            flex: 1;
            overflow: hidden;
            display: flex;
            min-height: 0;
        }
        
        .quill-editor-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            min-height: 0;
        }
        
        #editor {
            flex: 1;
            min-height: auto;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .email-composer-footer {
            flex-shrink: 0;
            border-radius: 0;
            position: sticky;
            bottom: 0;
            background: var(--bs-secondary-bg);
            z-index: 10;
            padding: 1rem !important;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
        }
        
        [data-bs-theme="dark"] .email-composer-footer {
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.3);
        }
        
        /* Ensure inputs don't zoom on focus (iOS) */
        .email-composer input[type="text"],
        .email-composer input[type="email"] {
            font-size: 16px;
        }
        
        /* Full-screen wrapper */
        .email-compose-wrapper {
            position: relative;
        }
        
        /* Ensure buttons are always visible and accessible */
        .email-composer-footer .d-flex {
            gap: 0.75rem;
        }
        
        .email-composer-footer button,
        .email-composer-footer a {
            min-height: 44px;
            padding: 0.625rem 1.25rem;
            font-size: 1rem;
            flex: 1;
        }
        
        #sendEmailButton {
            flex: 1.5;
            font-weight: 600;
        }
    }
    
    /* Desktop styles */
    .email-composer {
        background: var(--bs-body-bg);
        border-radius: 0.375rem;
    }
    
    .email-composer-header {
        background: var(--bs-secondary-bg);
        border-bottom: 1px solid var(--bs-border-color);
        padding: 0.5rem 1rem;
        border-radius: 0.375rem 0.375rem 0 0;
    }
    
    .email-composer-toolbar {
        background: var(--bs-secondary-bg);
        border-bottom: 1px solid var(--bs-border-color);
        padding: 0.5rem;
    }
    
    .email-composer-body {
        background: #ffffff;
        min-height: 400px;
    }
    
    [data-bs-theme="dark"] .email-composer-body {
        background: #1a202c;
    }
    
    .quill-editor-container {
        position: relative;
    }
    
    #editor {
        min-height: 350px;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        font-size: 14px;
        color: #333333;
    }
    
    [data-bs-theme="dark"] #editor {
        color: #e2e8f0;
    }
    
    .ql-container {
        font-family: inherit;
        font-size: inherit;
    }
    
    [data-bs-theme="dark"] .ql-editor {
        color: #e2e8f0;
    }
    
    [data-bs-theme="dark"] .ql-snow {
        border-color: #4a5568;
        background: #2d3748;
    }
    
    [data-bs-theme="dark"] .ql-toolbar {
        background: #2d3748;
        border-color: #4a5568;
    }
    
    [data-bs-theme="dark"] .ql-stroke {
        stroke: #e2e8f0;
    }
    
    [data-bs-theme="dark"] .ql-fill {
        fill: #e2e8f0;
    }
    
    [data-bs-theme="dark"] .ql-picker-label {
        color: #e2e8f0;
    }
    
    .email-preview-wrapper {
        background: var(--bs-body-bg);
        border-top: 1px solid var(--bs-border-color);
    }
    
    .email-preview-wrapper.collapsed .email-preview-body {
        display: none;
    }
    
    .email-preview-header {
        padding: 0.75rem 1rem;
        background: var(--bs-secondary-bg);
        border-bottom: 1px solid var(--bs-border-color);
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 0.5rem;
    }
    
    .email-preview-toggle {
        border: none;
        background: none;
        color: var(--bs-link-color);
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        font-weight: 600;
        cursor: pointer;
        padding: 0;
    }
    
    .email-preview-toggle .chevron {
        transition: transform 0.2s ease;
    }
    
    .email-preview-wrapper:not(.collapsed) .email-preview-toggle .chevron {
        transform: rotate(90deg);
    }
    
    .email-preview-body {
        padding: 1.5rem;
        background: var(--bs-body-bg);
    }
    
    .email-preview-content {
        background: #f4f6f8;
        border-radius: 0.75rem;
        border: 1px solid #e2e8f0;
        overflow: hidden;
        min-height: 260px;
        position: relative;
    }
    
    [data-bs-theme="dark"] .email-preview-content {
        background: #111827;
        border-color: #1f2937;
    }
    
    .email-preview-placeholder {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        padding: 3rem 1rem;
        color: #64748b;
        font-size: 0.95rem;
        text-align: center;
    }
    
    [data-bs-theme="dark"] .email-preview-placeholder {
        color: #94a3b8;
    }
    
    .email-preview-spinner {
        position: absolute;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(255, 255, 255, 0.7);
    }
    
    [data-bs-theme="dark"] .email-preview-spinner {
        background: rgba(15, 23, 42, 0.7);
    }
    
    .email-composer-footer {
        background: var(--bs-secondary-bg);
        border-top: 1px solid var(--bs-border-color);
        padding: 1rem;
        border-radius: 0 0 0.375rem 0.375rem;
    }
    
    /* Button Loading State */
    #sendEmailButton {
        transition: opacity 0.3s ease, background-color 0.3s ease;
    }
    
    #sendEmailButton:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        pointer-events: none;
        /* Helle, deaktivierte Version - behält die Button-Farbe bei, aber heller */
        filter: brightness(0.85);
    }
    
    #sendEmailButton .button-text {
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
    }
    
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-10 mx-auto">
        <nav aria-label="breadcrumb" class="d-none d-md-block">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{{ url_for('email.index') }}">{{ _('email.compose.breadcrumb.index') }}</a></li>
                <li class="breadcrumb-item active">{{ _('email.compose.breadcrumb.current') }}</li>
            </ol>
        </nav>
        
        <div class="email-compose-wrapper">
        <div class="card email-composer">
            <div class="email-composer-header">
                <h4 class="mb-0"><i class="bi bi-pencil-square me-2"></i>{{ _('email.compose.card_title') }}</h4>
            </div>
            <div class="card-body p-0">
                <form method="POST" action="{{ url_for('email.compose') }}" enctype="multipart/form-data" id="emailComposeForm">
                    <!-- Hidden fields for reply/forward metadata -->
                    <input type="hidden" name="in_reply_to" value="{{ in_reply_to|default('') }}">
                    <input type="hidden" name="references" value="{{ references|default('') }}">
                    <input type="hidden" name="forward_attachment_ids" value="{{ forward_attachment_ids|default('') }}">
                    <input type="hidden" name="original_attachment_ids" id="originalAttachmentIds" value="{{ original_attachment_ids|default('') }}">
                    <input type="hidden" name="body" id="bodyHtml" value="">
                    
                    <div class="p-3 border-bottom">
                        <div class="mb-3">
                            <label for="toChipContainer" class="form-label fw-bold">{{ _('email.compose.form.to') }}</label>
                            <div id="toChipContainer" class="contact-chip-wrapper" data-placeholder="{{ _('email.compose.form.to_placeholder') }}" data-search-url="{{ url_for('contacts.search') }}"></div>
                            <input type="hidden" id="toHidden" name="to" value="{{ to|default('') }}" required>
                            <div class="form-text">{{ _('email.compose.form.to_help') }}</div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="ccChipContainer" class="form-label fw-bold">{{ _('email.compose.form.cc') }}</label>
                            <div id="ccChipContainer" class="contact-chip-wrapper" data-placeholder="{{ _('email.compose.form.cc_placeholder') }}" data-search-url="{{ url_for('contacts.search') }}"></div>
                            <input type="hidden" id="ccHidden" name="cc" value="{{ cc|default('') }}">
                        </div>
                        
                        <div class="mb-3">
                            <label for="subject" class="form-label fw-bold">{{ _('email.compose.form.subject') }}</label>
                            <input type="text" class="form-control" id="subject" name="subject" value="{{ subject|default('') }}" required>
                        </div>
                    </div>
                    
                    <!-- Rich Text Editor -->
                    <div class="email-composer-toolbar">
                        <div id="toolbar-container"></div>
                    </div>
                    <div class="email-composer-body">
                        <div class="quill-editor-container">
                            <div id="editor"></div>
                        </div>
                    </div>
                    <div class="email-preview-wrapper collapsed" id="emailPreviewWrapper">
                        <div class="email-preview-header">
                            <button type="button" class="email-preview-toggle" id="emailPreviewToggle" aria-expanded="false">
                                <span class="chevron"><i class="bi bi-chevron-right"></i></span>
                                <span>{{ _('email.compose.preview.toggle') }}</span>
                            </button>
                            <span class="text-muted small" id="emailPreviewStatus">{{ _('email.compose.preview.status_hidden') }}</span>
                        </div>
                        <div class="email-preview-body">
                            <div class="email-preview-content" id="emailPreviewContent">
                                <div class="email-preview-placeholder">
                                    <i class="bi bi-envelope-paper"></i>
                                    <span>{{ _('email.compose.preview.placeholder') }}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="email-composer-footer">
                        <div class="mb-3">
                            <label for="attachments" class="form-label fw-bold">
                                <i class="bi bi-paperclip me-1"></i>{{ _('email.compose.attachments.label') }}
                            </label>
                            <input type="file" class="form-control" id="attachments" name="attachments" multiple>
                            <div class="form-text">{{ _('email.compose.attachments.help') }}</div>
                        </div>
                        <div class="form-text mb-3">{{ _('email.compose.attachments.footer_note') }}</div>
                        <div class="d-flex gap-2">
                            <button type="submit" id="sendEmailButton" class="btn btn-accent">
                                <span class="button-text">
                                    <i class="bi bi-send me-1"></i> {{ _('email.compose.buttons.send') }}
                                </span>
                            </button>
                            <a href="{{ url_for('email.index') }}" class="btn btn-outline-secondary">
                                <i class="bi bi-x me-1"></i> {{ _('email.compose.buttons.cancel') }}
                            </a>
                        </div>
                    </div>
                </form>
            </div>
        </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Contacts JS -->
<script src="{{ url_for('static', filename='js/contacts.js') }}"></script>
<!-- Quill Editor JS -->
<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
<script>
const EMAIL_COMPOSE = {{ current_translations.get('email', {}).get('compose', {})|tojson }};
const EDITOR_I18N = EMAIL_COMPOSE.editor || {};
const PREVIEW_I18N = EMAIL_COMPOSE.preview || {};
const COMPOSE_MESSAGES = EMAIL_COMPOSE.messages || {};

document.addEventListener('DOMContentLoaded', function() {
    // Check if mobile
    var isMobile = window.matchMedia('(max-width: 767.98px)').matches;
    var previewUrl = "{{ url_for('email.preview_custom_email') }}";
    
    // Mobile-optimized toolbar (fewer options, horizontal scroll)
    var mobileToolbarOptions = [
        ['bold', 'italic', 'underline'],
        [{ 'color': [] }, { 'background': [] }],
        [{ 'size': ['small', false, 'large'] }],
        [{ 'list': 'ordered'}, { 'list': 'bullet' }],
        ['link'],
        ['clean']
    ];
    
    // Desktop full toolbar
    var desktopToolbarOptions = [
        [{ 'header': [1, 2, 3, 4, 5, 6, false] }],
        [{ 'font': [] }],
        [{ 'size': ['small', false, 'large', 'huge'] }],
        ['bold', 'italic', 'underline', 'strike'],
        [{ 'color': [] }, { 'background': [] }],
        [{ 'script': 'sub'}, { 'script': 'super' }],
        [{ 'list': 'ordered'}, { 'list': 'bullet' }],
        [{ 'indent': '-1'}, { 'indent': '+1' }],
        [{ 'align': [] }],
        ['blockquote', 'code-block'],
        ['link', 'image'],
        ['clean']
    ];
    
    var toolbarOptions = isMobile ? mobileToolbarOptions : desktopToolbarOptions;
    
    var quill = new Quill('#editor', {
        theme: 'snow',
        modules: {
            toolbar: toolbarOptions
        },
        placeholder: EDITOR_I18N.placeholder || ''
    });
    var previewContent = document.getElementById('emailPreviewContent');
    var previewStatus = document.getElementById('emailPreviewStatus');
    var subjectInput = document.getElementById('subject');
    var previewSpinner = null;
    var previewDebounce;
    var previewRequestId = 0;
    var previewWrapper = document.getElementById('emailPreviewWrapper');
    var previewToggle = document.getElementById('emailPreviewToggle');
    var previewOpen = false;
    
    // Mobile: Focus management for keyboard
    if (isMobile) {
        var toInput = document.querySelector('#toChipContainer .contact-chip-input');
        var ccInput = document.querySelector('#ccChipContainer .contact-chip-input');
        var footer = document.querySelector('.email-composer-footer');
        var sendButton = document.getElementById('sendEmailButton');
        
        // Function to ensure footer is visible
        function ensureFooterVisible() {
            if (footer && sendButton) {
                setTimeout(function() {
                    // Scroll footer into view if needed
                    var footerRect = footer.getBoundingClientRect();
                    var viewportHeight = window.innerHeight;
                    
                    // If footer is below viewport, scroll it into view
                    if (footerRect.bottom > viewportHeight) {
                        sendButton.scrollIntoView({ behavior: 'smooth', block: 'end' });
                    }
                }, 500); // Delay to account for keyboard animation
            }
        }
        
        // Auto-focus first empty field
        if (toInput) {
            setTimeout(function() {
                toInput.focus();
                ensureFooterVisible();
            }, 300);
        } else if (subjectInput && !subjectInput.value) {
            setTimeout(function() {
                subjectInput.focus();
                ensureFooterVisible();
            }, 300);
        }
        
        // Handle input focus for smooth keyboard
        [toInput, ccInput, subjectInput].forEach(function(input) {
            if (input) {
                input.addEventListener('focus', function() {
                    // Scroll to input on mobile
                    setTimeout(function() {
                        input.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        // Also ensure footer is visible after keyboard opens
                        ensureFooterVisible();
                    }, 300);
                });
                
                input.addEventListener('blur', function() {
                    // Ensure footer is visible when keyboard closes
                    setTimeout(ensureFooterVisible, 300);
                });
            }
        });
        
        // Ensure footer is visible when editor is focused
        var editorElement = document.querySelector('#editor .ql-editor');
        if (editorElement) {
            editorElement.addEventListener('focus', function() {
                ensureFooterVisible();
            });
        }
        
        // Also check on window resize (keyboard open/close)
        var resizeTimeout;
        window.addEventListener('resize', function() {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(ensureFooterVisible, 300);
        });
        
        // Initial check
        ensureFooterVisible();
    }
    
    function setPreviewPlaceholder() {
        if (previewSpinner) {
            previewSpinner.remove();
            previewSpinner = null;
        }
        previewContent.innerHTML = '<div class="email-preview-placeholder"><i class="bi bi-envelope-paper"></i><span>' + (PREVIEW_I18N.placeholder || '') + '</span></div>';
        previewStatus.textContent = PREVIEW_I18N.status_hidden || '';
    }
    
    function setPreviewLoading() {
        if (previewSpinner) {
            previewSpinner.remove();
        }
        previewSpinner = document.createElement('div');
        previewSpinner.className = 'email-preview-spinner';
        const loadingLabel = PREVIEW_I18N.loading_label || '';
        previewSpinner.innerHTML = '<div class="spinner-border text-primary" role="status"><span class="visually-hidden">' + loadingLabel + '</span></div>';
        previewContent.appendChild(previewSpinner);
        previewStatus.textContent = PREVIEW_I18N.status_loading || '';
    }
    
    function setPreviewError(message) {
        if (previewSpinner) {
            previewSpinner.remove();
            previewSpinner = null;
        }
        const errorMessage = message || PREVIEW_I18N.error_loading || '';
        previewContent.innerHTML = '<div class="email-preview-placeholder text-danger"><i class="bi bi-exclamation-triangle"></i><span>' + errorMessage + '</span></div>';
        previewStatus.textContent = PREVIEW_I18N.error_title || '';
    }
    
    function applyPreview(html) {
        if (previewSpinner) {
            previewSpinner.remove();
            previewSpinner = null;
        }
        previewContent.innerHTML = html;
        previewStatus.textContent = PREVIEW_I18N.status_ready || '';
    }
    
    function updatePreview() {
        if (!previewOpen) {
            return;
        }
        var textContent = quill.getText().trim();
        if (!textContent) {
            setPreviewPlaceholder();
            return;
        }
        var htmlContent = quill.root.innerHTML;
        setPreviewLoading();
        var body = {
            subject: subjectInput ? subjectInput.value : '',
            body: htmlContent
        };
        var requestId = ++previewRequestId;
        fetch(previewUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            credentials: 'same-origin',
            body: JSON.stringify(body)
        }).then(function(response) {
            if (!response.ok) {
                const template = COMPOSE_MESSAGES.server_error || '';
                const message = template.includes('{status}') ? template.replace('{status}', response.status) : template || ('Server error ' + response.status);
                throw new Error(message);
            }
            return response.json();
        }).then(function(data) {
            if (requestId !== previewRequestId) {
                return;
            }
            if (data && data.html) {
                applyPreview(data.html);
            } else if (data && data.error) {
                setPreviewError(data.error);
            } else {
                setPreviewError(PREVIEW_I18N.unknown_response || '');
            }
        }).catch(function(error) {
            console.error(error);
            if (requestId === previewRequestId) {
                setPreviewError(error.message || PREVIEW_I18N.error_loading || '');
            }
        });
    }
    
    function schedulePreview() {
        clearTimeout(previewDebounce);
        previewDebounce = setTimeout(updatePreview, 350);
    }
    
    function togglePreview() {
        previewOpen = !previewOpen;
        previewWrapper.classList.toggle('collapsed', !previewOpen);
        previewToggle.setAttribute('aria-expanded', previewOpen ? 'true' : 'false');
        previewStatus.textContent = previewOpen ? (PREVIEW_I18N.status_loading || '') : (PREVIEW_I18N.status_hidden || '');
        if (previewOpen) {
            updatePreview();
        }
    }
    
    if (previewToggle) {
        previewToggle.addEventListener('click', togglePreview);
    }
    
    // Set initial content if body exists
    {% if body is defined and body %}
    var initialContent = {{ body|tojson|safe }};
    if (initialContent) {
        // Try to parse as HTML first
        try {
            quill.clipboard.dangerouslyPasteHTML(initialContent);
        } catch (e) {
            quill.setText(initialContent);
        }
    }
    {% endif %}
    
    // Original E-Mail einfach am Ende einfügen
    {% if is_reply and original_email %}
    (function() {
        setTimeout(function() {
            try {
                // Einfacher Header
                var headerText = '{{ _('email.view.header.from') }} ' + {{ original_email.sender|decode_email_header|tojson|safe }} + '\n';
                headerText += '{{ _('email.view.header.to') }} ' + {{ original_email.recipients|decode_email_header|tojson|safe }} + '\n';
                {% if original_email.cc %}
                headerText += '{{ _('email.view.header.cc') }} ' + {{ original_email.cc|decode_email_header|tojson|safe }} + '\n';
                {% endif %}
                headerText += '{{ _('email.view.header.date') }} {{ original_email.received_at.strftime('%d.%m.%Y %H:%M') if original_email.received_at else original_email.sent_at.strftime('%d.%m.%Y %H:%M') }}\n';
                headerText += '{{ _('email.view.header.subject') }} ' + {{ original_email.subject|decode_email_header|tojson|safe }} + '\n\n';
                
                // Trennlinie
                var separator = '\n##- Bitte geben Sie Ihre Antwort über dieser Zeile ein. -##\n\n';
                
                // Original-E-Mail Text
                var originalText = '';
                {% if original_email.body_text %}
                originalText = {{ original_email.body_text|tojson|safe }};
                {% elif original_html %}
                // HTML zu Text konvertieren (einfach)
                var htmlContent = {{ original_html|tojson|safe }};
                var tempDiv = document.createElement('div');
                tempDiv.innerHTML = htmlContent;
                originalText = tempDiv.textContent || tempDiv.innerText || '';
                {% endif %}
                
                // Alles zusammenfügen: Header + Trennlinie + Original-Text
                var fullText = headerText + separator + originalText;
                
                // Am Ende des Editors einfügen
                var length = quill.getLength();
                quill.insertText(length - 1, fullText, 'user');
                
                // Cursor an den Anfang setzen (vor dem Header)
                quill.setSelection(0);
            } catch (e) {
                console.error('Fehler beim Einfügen der Original-E-Mail:', e);
            }
        }, 300);
    })();
    {% endif %}
    
    // AJAX form submission with loading state
    var sendButton = document.getElementById('sendEmailButton');
    var form = document.getElementById('emailComposeForm');
    var isSubmitting = false;
    
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Prevent double submission
        if (isSubmitting) {
            return false;
        }
        
        var htmlContent = quill.root.innerHTML;
        var textContent = quill.getText();
        
        // If only whitespace, show error
        if (!textContent.trim()) {
            alert(COMPOSE_MESSAGES.validation_error || 'Bitte geben Sie eine Nachricht ein.');
            return false;
        }
        
        // Set HTML content to hidden field
        document.getElementById('bodyHtml').value = htmlContent;
        
        // Disable button (Text bleibt sichtbar, Button wird heller)
        isSubmitting = true;
        sendButton.disabled = true;
        
        // Prepare FormData
        var formData = new FormData(form);
        
        // Send AJAX request
        fetch(form.action || window.location.pathname, {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            },
            credentials: 'same-origin'
        })
        .then(function(response) {
            return response.json().then(function(data) {
                if (!response.ok) {
                    throw new Error(data.message || 'Fehler beim Senden der E-Mail');
                }
                return data;
            });
        })
        .then(function(data) {
            if (data.success) {
                // Success: Show message and redirect
                if (data.message) {
                    // You could show a toast notification here
                    console.log('Success:', data.message);
                }
                // Redirect after short delay
                setTimeout(function() {
                    window.location.href = data.redirect_url || '{{ url_for("email.index") }}';
                }, 1000);
            } else {
                throw new Error(data.message || 'Fehler beim Senden der E-Mail');
            }
        })
        .catch(function(error) {
            // Error: Re-enable button and show error
            isSubmitting = false;
            sendButton.disabled = false;
            
            // Show error message
            alert(error.message || 'Fehler beim Senden der E-Mail. Bitte versuchen Sie es erneut.');
            console.error('E-Mail-Versand Fehler:', error);
        });
        
        return false;
    });
    
    quill.on('text-change', schedulePreview);
    if (subjectInput) {
        subjectInput.addEventListener('input', schedulePreview);
    }
    
    // Entwurf-Speicherung beim Verlassen der Seite
    var hasUnsavedDraft = false;
    var isSubmittingForm = false;
    var draftSaveUrl = "{{ url_for('email.save_draft') }}";
    
    // Prüfe, ob HTML tatsächlich Text enthält (nicht nur leere Tags)
    function hasRealTextContent(htmlContent) {
        if (!htmlContent || htmlContent.trim().length === 0) {
            return false;
        }
        
        // Erstelle temporäres Element, um Text zu extrahieren
        var tempDiv = document.createElement('div');
        tempDiv.innerHTML = htmlContent;
        var textContent = tempDiv.textContent || tempDiv.innerText || '';
        
        // Entferne alle Whitespace-Zeichen und prüfe, ob noch Text übrig ist
        return textContent.trim().length > 0;
    }
    
    // Prüfe, ob ein Entwurf vorhanden ist
    function hasDraftContent() {
        var subject = subjectInput ? subjectInput.value.trim() : '';
        var to = document.getElementById('to') ? document.getElementById('to').value.trim() : '';
        var textContent = quill.getText().trim();
        var htmlContent = quill.root.innerHTML.trim();
        var attachments = document.getElementById('attachments');
        var hasAttachments = attachments && attachments.files && attachments.files.length > 0;
        
        // Prüfe, ob HTML tatsächlich Text enthält
        var hasRealHtmlContent = hasRealTextContent(htmlContent);
        
        // Entwurf vorhanden, wenn Betreff, echter Text oder Anhänge vorhanden sind
        return subject.length > 0 || textContent.length > 0 || hasRealHtmlContent || hasAttachments;
    }
    
    // Speichere Entwurf
    function saveDraft() {
        if (isSubmittingForm) {
            return Promise.resolve();
        }
        
        if (!hasDraftContent()) {
            return Promise.resolve();
        }
        
        var formData = new FormData();
        var to = document.getElementById('toHidden') ? document.getElementById('toHidden').value : '';
        var cc = document.getElementById('ccHidden') ? document.getElementById('ccHidden').value : '';
        var subject = subjectInput ? subjectInput.value : '';
        var htmlContent = quill.root.innerHTML;
        var inReplyTo = document.querySelector('input[name="in_reply_to"]') ? document.querySelector('input[name="in_reply_to"]').value : '';
        var references = document.querySelector('input[name="references"]') ? document.querySelector('input[name="references"]').value : '';
        
        formData.append('to', to);
        formData.append('cc', cc);
        formData.append('subject', subject);
        formData.append('body', htmlContent);
        formData.append('in_reply_to', inReplyTo);
        formData.append('references', references);
        
        // Füge Anhänge hinzu
        var attachments = document.getElementById('attachments');
        if (attachments && attachments.files) {
            for (var i = 0; i < attachments.files.length; i++) {
                formData.append('attachments', attachments.files[i]);
            }
        }
        
        // Sende Entwurf asynchron (beacon für beforeunload)
        return fetch(draftSaveUrl, {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            },
            credentials: 'same-origin',
            keepalive: true  // Wichtig für beforeunload
        }).then(function(response) {
            return response.json();
        }).then(function(data) {
            if (data.success) {
                hasUnsavedDraft = false;
                console.log('Entwurf gespeichert');
            }
        }).catch(function(error) {
            console.error('Fehler beim Speichern des Entwurfs:', error);
        });
    }
    
    // Speichere Entwurf beim Verlassen der Seite
    window.addEventListener('beforeunload', function(e) {
        if (isSubmittingForm) {
            return;
        }
        
        if (hasDraftContent()) {
            // Verwende fetch mit keepalive für zuverlässiges Speichern beim Verlassen
            var to = document.getElementById('to') ? document.getElementById('to').value : '';
            var cc = document.getElementById('cc') ? document.getElementById('cc').value : '';
            var subject = subjectInput ? subjectInput.value : '';
            var htmlContent = quill.root.innerHTML;
            var inReplyTo = document.querySelector('input[name="in_reply_to"]') ? document.querySelector('input[name="in_reply_to"]').value : '';
            var references = document.querySelector('input[name="references"]') ? document.querySelector('input[name="references"]').value : '';
            
            // Erstelle JSON-Daten
            var data = {
                to: to,
                cc: cc,
                subject: subject,
                body: htmlContent,
                in_reply_to: inReplyTo,
                references: references
            };
            
            // Verwende fetch mit keepalive für zuverlässiges Speichern beim Verlassen
            fetch(draftSaveUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify(data),
                keepalive: true  // Wichtig: erlaubt Request auch nach page unload
            }).catch(function(error) {
                console.error('Fehler beim automatischen Speichern des Entwurfs:', error);
            });
        }
    });
    
    // Speichere Entwurf beim Klick auf Zurück-Button
    var cancelButton = document.querySelector('a[href="{{ url_for("email.index") }}"]');
    if (cancelButton) {
        cancelButton.addEventListener('click', function(e) {
            if (isSubmittingForm) {
                return;
            }
            
            if (hasDraftContent()) {
                e.preventDefault();
                saveDraft().then(function() {
                    window.location.href = "{{ url_for('email.index') }}";
                });
            }
        });
    }
    
    // Markiere Formular als absendend, wenn es gesendet wird
    form.addEventListener('submit', function() {
        isSubmittingForm = true;
    });
    
    // Prüfe regelmäßig, ob ein Entwurf vorhanden ist
    setInterval(function() {
        hasUnsavedDraft = hasDraftContent();
    }, 2000);
    
});
</script>
{% endblock %}



