{% extends "base.html" %}

{% block title %}{{ _('wiki.create.page_title') }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/wiki.css') }}">
<style>
    .wiki-editor-fullscreen {
        position: fixed !important;
        top: 0 !important;
        left: 0 !important;
        right: 0 !important;
        bottom: 0 !important;
        width: 100vw !important;
        height: 100vh !important;
        background: var(--bs-body-bg);
        z-index: 1060;
        display: flex !important;
        flex-direction: column !important;
        margin: 0 !important;
        padding: 0 !important;
        overflow: hidden !important;
    }
    
    .wiki-metadata-section {
        background: var(--bs-body-bg);
        border-bottom: 1px solid var(--bs-border-color);
        padding: 1rem 1.5rem;
        flex-shrink: 0;
    }
    
    .wiki-metadata-card {
        background: var(--bs-secondary-bg);
        border: 1px solid var(--bs-border-color);
        border-radius: 0.375rem;
        padding: 1rem;
    }
    
    .wiki-editor-toolbar {
        background: var(--bs-body-bg);
        border-bottom: 1px solid var(--bs-border-color);
        padding: 0.75rem 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        flex-wrap: wrap;
        position: sticky;
        top: 0;
        z-index: 1;
        flex-shrink: 0;
    }
    
    .wiki-editor-content {
        flex: 1 !important;
        display: flex !important;
        flex-direction: column !important;
        overflow: hidden !important;
    }
    
    .wiki-editor-textarea {
        flex: 1 !important;
        border: none !important;
        outline: none !important;
        padding: 1rem !important;
        font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace !important;
        font-size: 14px !important;
        line-height: 1.5 !important;
        resize: none !important;
        background: transparent !important;
        width: 100% !important;
        height: 100% !important;
    }
    
    #new_category_input {
        display: none;
    }
    
    #new_category_input.show {
        display: block;
    }
</style>
{% endblock %}

{% block content %}
<form method="POST" id="createForm" action="{{ url_for('wiki.create') }}">
<div class="wiki-editor-fullscreen">
    <div class="wiki-metadata-section">
        <div class="wiki-metadata-card">
            <div class="row g-3">
                <div class="col-12 col-md-4">
                    <label for="title" class="form-label">{{ _('wiki.create.form.title.label') }}</label>
                    <input type="text" class="form-control" id="title" name="title" value="{{ title or '' }}" required>
                </div>
                <div class="col-12 col-md-4">
                    <label for="category_id" class="form-label">{{ _('wiki.create.form.category.label') }}</label>
                    <select class="form-select" id="category_id" name="category_id" onchange="handleCategoryChange()">
                        <option value="">{{ _('wiki.create.form.category.none') }}</option>
                        <option value="__new__">{{ _('wiki.create.form.category.new_option') }}</option>
                        {% for category in categories %}
                        <option value="{{ category.id }}">{{ category.name }}</option>
                        {% endfor %}
                    </select>
                    <div id="new_category_input" class="mt-2">
                        <input type="text" class="form-control" id="new_category_name" name="new_category_name" placeholder="{{ _('wiki.create.form.category.new_placeholder') }}">
                    </div>
                </div>
                <div class="col-12 col-md-4">
                    <label for="tags" class="form-label">{{ _('wiki.create.form.tags.label') }}</label>
                    <input type="text" class="form-control" id="tags" name="tags" placeholder="{{ _('wiki.create.form.tags.placeholder') }}">
                </div>
            </div>
        </div>
    </div>
    
    <div class="wiki-editor-toolbar">
        <button type="button" class="btn btn-outline-secondary" onclick="goBack()">
            <i class="bi bi-arrow-left"></i> {{ _('wiki.create.toolbar.back') }}
        </button>
        <button type="button" class="btn btn-accent" onclick="savePage()">
            <i class="bi bi-check-lg"></i> {{ _('wiki.create.toolbar.submit') }}
        </button>
        
        <div class="vr"></div>
        
        <div class="btn-group" role="group">
            <button type="button" class="btn btn-outline-secondary" onclick="formatText('bold')" title="{{ _('wiki.create.toolbar.bold') }}">
                <i class="bi bi-type-bold"></i>
            </button>
            <button type="button" class="btn btn-outline-secondary" onclick="formatText('italic')" title="{{ _('wiki.create.toolbar.italic') }}">
                <i class="bi bi-type-italic"></i>
            </button>
            <button type="button" class="btn btn-outline-secondary" onclick="formatText('strikethrough')" title="{{ _('wiki.create.toolbar.strikethrough') }}">
                <i class="bi bi-type-strikethrough"></i>
            </button>
        </div>
        
        <div class="vr"></div>
        
        <div class="btn-group" role="group">
            <button type="button" class="btn btn-outline-secondary" onclick="formatText('heading1')" title="{{ _('wiki.create.toolbar.heading1') }}">
                <i class="bi bi-type-h1"></i>
            </button>
            <button type="button" class="btn btn-outline-secondary" onclick="formatText('heading2')" title="{{ _('wiki.create.toolbar.heading2') }}">
                <i class="bi bi-type-h2"></i>
            </button>
            <button type="button" class="btn btn-outline-secondary" onclick="formatText('heading3')" title="{{ _('wiki.create.toolbar.heading3') }}">
                <i class="bi bi-type-h3"></i>
            </button>
        </div>
        
        <div class="vr"></div>
        
        <div class="btn-group" role="group">
            <button type="button" class="btn btn-outline-secondary" onclick="formatText('link')" title="{{ _('wiki.create.toolbar.link') }}">
                <i class="bi bi-link-45deg"></i>
            </button>
            <button type="button" class="btn btn-outline-secondary" onclick="formatText('code')" title="{{ _('wiki.create.toolbar.code') }}">
                <i class="bi bi-code"></i>
            </button>
            <button type="button" class="btn btn-outline-secondary" onclick="formatText('list')" title="{{ _('wiki.create.toolbar.list') }}">
                <i class="bi bi-list-ul"></i>
            </button>
            <button type="button" class="btn btn-outline-secondary" onclick="formatText('wikilink')" title="{{ _('wiki.create.toolbar.wikilink') }}">
                <i class="bi bi-link"></i> [[
            </button>
        </div>
        
        <div class="ms-auto">
            <button type="button" class="btn btn-outline-primary" onclick="openPreview()">
                <i class="bi bi-eye"></i> {{ _('wiki.create.toolbar.preview') }}
            </button>
        </div>
    </div>
    
    <div class="wiki-editor-content">
        <div class="container-fluid h-100">
            <div class="row g-3 h-100">
                <div class="col-12 col-md-8">
                    <textarea 
                        class="wiki-editor-textarea" 
                        name="content" 
                        id="wikiEditor"
                        placeholder="{{ _('wiki.create.editor.placeholder') }}">{{ content or '' }}</textarea>
                </div>
            </div>
        </div>
    </div>
</div>
</form>

<script>
const WIKI_CREATE_I18N = {{ current_translations.get('wiki', {}).get('create', {})|tojson }};
const WIKI_CREATE_TOOLBAR = WIKI_CREATE_I18N.toolbar || {};
const WIKI_CREATE_ALERTS = WIKI_CREATE_I18N.alerts || {};
const WIKI_CREATE_EDITOR = WIKI_CREATE_I18N.editor || {};
const WIKI_CREATE_FORMAT = WIKI_CREATE_I18N.format_defaults || {};

function wikiCreateTranslate(path, fallback = '') {
    return path.split('.').reduce((obj, key) => (obj && obj[key] !== undefined ? obj[key] : undefined), WIKI_CREATE_I18N) ?? fallback;
}

function formatDefault(key, fallback) {
    return WIKI_CREATE_FORMAT[key] || fallback;
}

document.addEventListener('DOMContentLoaded', function() {
    const editor = document.getElementById('wikiEditor');
    if (editor) {
        editor.placeholder = WIKI_CREATE_EDITOR.placeholder || editor.placeholder;
        editor.focus();
    }
});

function handleCategoryChange() {
    const categorySelect = document.getElementById('category_id');
    const newCategoryInput = document.getElementById('new_category_input');
    const newCategoryName = document.getElementById('new_category_name');
    
    if (categorySelect.value === '__new__') {
        newCategoryInput.classList.add('show');
        newCategoryName.focus();
    } else {
        newCategoryInput.classList.remove('show');
        newCategoryName.value = '';
    }
}

function goBack() {
    window.location.href = '{{ url_for("wiki.index") }}';
}

function savePage() {
    const form = document.getElementById('createForm');
    const title = document.getElementById('title').value.trim();
    const categorySelect = document.getElementById('category_id');
    const newCategoryName = document.getElementById('new_category_name').value.trim();
    
    if (!title) {
        alert(WIKI_CREATE_ALERTS.title_required || 'Please enter a title.');
        return;
    }
    
    if (categorySelect.value === '__new__') {
        if (!newCategoryName) {
            alert(WIKI_CREATE_ALERTS.new_category_required || 'Please enter a name for the new category.');
            return;
        }
        categorySelect.value = '';
    }
    
    const saveBtn = document.querySelector('.btn-accent');
    if (saveBtn) {
        saveBtn.innerHTML = `<i class="bi bi-hourglass-split"></i> ${WIKI_CREATE_EDITOR.saving || 'Creating...'}`;
        saveBtn.disabled = true;
    }
    
    form.submit();
}

function formatText(type) {
    const editor = document.getElementById('wikiEditor');
    const start = editor.selectionStart;
    const end = editor.selectionEnd;
    const selectedText = editor.value.substring(start, end);
    
    let replacement = '';
    switch(type) {
        case 'bold':
            replacement = `**${selectedText || formatDefault('text', 'Text')}**`;
            break;
        case 'italic':
            replacement = `*${selectedText || formatDefault('text', 'Text')}*`;
            break;
        case 'strikethrough':
            replacement = `~~${selectedText || formatDefault('text', 'Text')}~~`;
            break;
        case 'heading1':
            replacement = `# ${selectedText || formatDefault('heading', 'Heading')}`;
            break;
        case 'heading2':
            replacement = `## ${selectedText || formatDefault('heading', 'Heading')}`;
            break;
        case 'heading3':
            replacement = `### ${selectedText || formatDefault('heading', 'Heading')}`;
            break;
        case 'link':
            replacement = `[${selectedText || formatDefault('link_text', 'Link text')}](URL)`;
            break;
        case 'code':
            replacement = `\`${selectedText || formatDefault('code', 'Code')}\``;
            break;
        case 'list':
            replacement = `- ${selectedText || formatDefault('list_item', 'List item')}`;
            break;
        case 'wikilink':
            replacement = `[[${selectedText || formatDefault('page_name', 'Page name')}]]`;
            break;
    }
    
    editor.value = editor.value.substring(0, start) + replacement + editor.value.substring(end);
    const newCursorPos = start + replacement.length;
    editor.setSelectionRange(newCursorPos, newCursorPos);
    editor.focus();
}

function openPreview() {
    const form = document.getElementById('createForm');
    const formData = new FormData(form);
    
    fetch('{{ url_for("wiki.preview") }}', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        const previewWindow = window.open('', '_blank');
        const previewTitle = WIKI_CREATE_EDITOR.preview_title || 'Preview';
        previewWindow.document.write(`
            <html>
                <head>
                    <title>${previewTitle}</title>
                    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
                    <style>
                        body { padding: 2rem; max-width: 1200px; margin: 0 auto; }
                        .markdown-content { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; line-height: 1.6; }
                    </style>
                </head>
                <body>
                    <div class="markdown-content">${data.html}</div>
                </body>
            </html>
        `);
    })
    .catch(error => {
        console.error('Error:', error);
        alert(WIKI_CREATE_ALERTS.preview_error || 'Failed to load preview.');
    });
}

document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        goBack();
    }
});
</script>
{% endblock %}
