{% extends "base.html" %}

{% block title %}{{ page.title }} bearbeiten - Wiki{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/wiki.css') }}">
<style>
    .wiki-editor-fullscreen {
        position: fixed !important;
        top: 0 !important;
        left: 0 !important;
        right: 0 !important;
        bottom: 0 !important;
        width: 100vw !important;
        height: 100vh !important;
        background: var(--bs-body-bg);
        z-index: 1060;
        display: flex !important;
        flex-direction: column !important;
        margin: 0 !important;
        padding: 0 !important;
        overflow: hidden !important;
    }
    
    .wiki-metadata-section {
        background: var(--bs-body-bg);
        border-bottom: 1px solid var(--bs-border-color);
        padding: 1rem 1.5rem;
        flex-shrink: 0;
    }
    
    .wiki-metadata-card {
        background: var(--bs-secondary-bg);
        border: 1px solid var(--bs-border-color);
        border-radius: 0.375rem;
        padding: 1rem;
    }
    
    .wiki-editor-toolbar {
        background: var(--bs-body-bg);
        border-bottom: 1px solid var(--bs-border-color);
        padding: 0.75rem 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        flex-wrap: wrap;
        position: sticky;
        top: 0;
        z-index: 1;
        flex-shrink: 0;
    }
    
    .wiki-editor-content {
        flex: 1 !important;
        display: flex !important;
        flex-direction: column !important;
        overflow: hidden !important;
    }
    
    .wiki-editor-textarea {
        flex: 1 !important;
        border: none !important;
        outline: none !important;
        padding: 1rem !important;
        font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace !important;
        font-size: 14px !important;
        line-height: 1.5 !important;
        resize: none !important;
        background: transparent !important;
        width: 100% !important;
        height: 100% !important;
    }
    
    #new_category_input {
        display: none;
    }
    
    #new_category_input.show {
        display: block;
    }
</style>
{% endblock %}

{% block content %}
<form method="POST" id="editForm" action="{{ url_for('wiki.edit', slug=page.slug) }}">
<div class="wiki-editor-fullscreen">
    <div class="wiki-metadata-section">
        <div class="wiki-metadata-card">
            <div class="row g-3">
                <div class="col-12 col-md-4">
                    <label for="title" class="form-label">Titel</label>
                    <input type="text" class="form-control" id="title" name="title" value="{{ page.title }}" required>
                </div>
                <div class="col-12 col-md-4">
                    <label for="category_id" class="form-label">Kategorie</label>
                    <select class="form-select" id="category_id" name="category_id" onchange="handleCategoryChange()">
                        <option value="">Keine Kategorie</option>
                        <option value="__new__">➕ Neue Kategorie</option>
                        {% for category in categories %}
                        <option value="{{ category.id }}" {% if page.category_id == category.id %}selected{% endif %}>
                            {{ category.name }}
                        </option>
                        {% endfor %}
                    </select>
                    <div id="new_category_input" class="mt-2">
                        <input type="text" class="form-control" id="new_category_name" name="new_category_name" placeholder="Kategoriename eingeben">
                    </div>
                </div>
                <div class="col-12 col-md-4">
                    <label for="tags" class="form-label">Tags (kommagetrennt)</label>
                    <input type="text" class="form-control" id="tags" name="tags" value="{{ tags }}" placeholder="tag1, tag2, tag3">
                </div>
            </div>
        </div>
    </div>
    
    <div class="wiki-editor-toolbar">
        <button type="button" class="btn btn-outline-secondary" onclick="goBack()">
            <i class="bi bi-arrow-left"></i> Zurück
        </button>
        <button type="button" class="btn btn-accent" onclick="savePage()">
            <i class="bi bi-check-lg"></i> Speichern
        </button>
        
        <div class="vr"></div>
        
        <div class="btn-group" role="group">
            <button type="button" class="btn btn-outline-secondary" onclick="formatText('bold')" title="Fett">
                <i class="bi bi-type-bold"></i>
            </button>
            <button type="button" class="btn btn-outline-secondary" onclick="formatText('italic')" title="Kursiv">
                <i class="bi bi-type-italic"></i>
            </button>
            <button type="button" class="btn btn-outline-secondary" onclick="formatText('strikethrough')" title="Durchgestrichen">
                <i class="bi bi-type-strikethrough"></i>
            </button>
        </div>
        
        <div class="vr"></div>
        
        <div class="btn-group" role="group">
            <button type="button" class="btn btn-outline-secondary" onclick="formatText('heading1')" title="Überschrift 1">
                <i class="bi bi-type-h1"></i>
            </button>
            <button type="button" class="btn btn-outline-secondary" onclick="formatText('heading2')" title="Überschrift 2">
                <i class="bi bi-type-h2"></i>
            </button>
            <button type="button" class="btn btn-outline-secondary" onclick="formatText('heading3')" title="Überschrift 3">
                <i class="bi bi-type-h3"></i>
            </button>
        </div>
        
        <div class="vr"></div>
        
        <div class="btn-group" role="group">
            <button type="button" class="btn btn-outline-secondary" onclick="formatText('link')" title="Link">
                <i class="bi bi-link-45deg"></i>
            </button>
            <button type="button" class="btn btn-outline-secondary" onclick="formatText('code')" title="Code">
                <i class="bi bi-code"></i>
            </button>
            <button type="button" class="btn btn-outline-secondary" onclick="formatText('list')" title="Liste">
                <i class="bi bi-list-ul"></i>
            </button>
            <button type="button" class="btn btn-outline-secondary" onclick="formatText('wikilink')" title="Wiki-Link">
                <i class="bi bi-link"></i> [[
            </button>
        </div>
        
        <div class="ms-auto">
            <button type="button" class="btn btn-outline-primary" onclick="openPreview()">
                <i class="bi bi-eye"></i> Vorschau
            </button>
        </div>
    </div>
    
    <div class="wiki-editor-content">
        <div class="container-fluid h-100">
            <div class="row g-3 h-100">
                <div class="col-12 col-md-8">
                    <textarea 
                        class="wiki-editor-textarea" 
                        name="content" 
                        id="wikiEditor"
                        placeholder="Beginnen Sie mit dem Schreiben...">{{ page.content }}</textarea>
                </div>
            </div>
        </div>
    </div>
</div>
</form>

<script>
let hasUnsavedChanges = false;

document.addEventListener('DOMContentLoaded', function() {
    const editor = document.getElementById('wikiEditor');
    const form = document.getElementById('editForm');
    
    // Auto-save functionality
    let autoSaveTimeout;
    editor.addEventListener('input', function() {
        hasUnsavedChanges = true;
        
        clearTimeout(autoSaveTimeout);
        autoSaveTimeout = setTimeout(() => {
            if (hasUnsavedChanges) {
                savePage(true); // Silent save
            }
        }, 30000);
    });
    
    // Warnung vor Verlassen bei ungespeicherten Änderungen
    window.addEventListener('beforeunload', function(e) {
        if (hasUnsavedChanges) {
            e.preventDefault();
            e.returnValue = '';
        }
    });
    
    // Keyboard shortcuts
    editor.addEventListener('keydown', function(e) {
        if ((e.ctrlKey || e.metaKey) && e.key === 's') {
            e.preventDefault();
            savePage();
        }
    });
    
    editor.focus();
});

function handleCategoryChange() {
    const categorySelect = document.getElementById('category_id');
    const newCategoryInput = document.getElementById('new_category_input');
    const newCategoryName = document.getElementById('new_category_name');
    
    if (categorySelect.value === '__new__') {
        newCategoryInput.classList.add('show');
        newCategoryName.focus();
    } else {
        newCategoryInput.classList.remove('show');
        newCategoryName.value = '';
    }
}

function goBack() {
    if (hasUnsavedChanges) {
        if (confirm('Sie haben ungespeicherte Änderungen. Möchten Sie wirklich zurückgehen?')) {
            window.location.href = '{{ url_for("wiki.view", slug=page.slug) }}';
        }
    } else {
        window.location.href = '{{ url_for("wiki.view", slug=page.slug) }}';
    }
}

function savePage(silent = false) {
    const form = document.getElementById('editForm');
    const categorySelect = document.getElementById('category_id');
    const newCategoryName = document.getElementById('new_category_name').value.trim();
    
    // Wenn "Neue Kategorie" ausgewählt ist, prüfe ob Name eingegeben wurde
    if (categorySelect.value === '__new__') {
        if (!newCategoryName) {
            if (!silent) {
                alert('Bitte geben Sie einen Namen für die neue Kategorie ein.');
            }
            return;
        }
        // Setze den Wert auf leer, damit das Backend die neue Kategorie erkennt
        categorySelect.value = '';
    }
    
    if (!silent) {
        const saveBtn = document.querySelector('.btn-accent');
        saveBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Speichere...';
        saveBtn.disabled = true;
    }
    
    fetch(form.action, {
        method: 'POST',
        body: new FormData(form)
    })
    .then(response => {
        if (response.ok) {
            hasUnsavedChanges = false;
            if (!silent) {
                window.location.href = response.url || '{{ url_for("wiki.view", slug=page.slug) }}';
            }
        } else {
            throw new Error('Fehler beim Speichern');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        if (!silent) {
            alert('Fehler beim Speichern der Seite. Bitte versuchen Sie es erneut.');
        }
    })
    .finally(() => {
        if (!silent) {
            const saveBtn = document.querySelector('.btn-accent');
            saveBtn.disabled = false;
            saveBtn.innerHTML = '<i class="bi bi-check-lg"></i> Speichern';
        }
    });
}

function formatText(type) {
    const editor = document.getElementById('wikiEditor');
    const start = editor.selectionStart;
    const end = editor.selectionEnd;
    const selectedText = editor.value.substring(start, end);
    
    let replacement = '';
    
    switch(type) {
        case 'bold':
            replacement = `**${selectedText || 'Text'}**`;
            break;
        case 'italic':
            replacement = `*${selectedText || 'Text'}*`;
            break;
        case 'strikethrough':
            replacement = `~~${selectedText || 'Text'}~~`;
            break;
        case 'heading1':
            replacement = `# ${selectedText || 'Überschrift'}`;
            break;
        case 'heading2':
            replacement = `## ${selectedText || 'Überschrift'}`;
            break;
        case 'heading3':
            replacement = `### ${selectedText || 'Überschrift'}`;
            break;
        case 'link':
            replacement = `[${selectedText || 'Link-Text'}](URL)`;
            break;
        case 'code':
            replacement = `\`${selectedText || 'Code'}\``;
            break;
        case 'list':
            replacement = `- ${selectedText || 'Listenpunkt'}`;
            break;
        case 'wikilink':
            replacement = `[[${selectedText || 'Seitenname'}]]`;
            break;
    }
    
    editor.value = editor.value.substring(0, start) + replacement + editor.value.substring(end);
    const newCursorPos = start + replacement.length;
    editor.setSelectionRange(newCursorPos, newCursorPos);
    editor.focus();
    editor.dispatchEvent(new Event('input'));
}

function openPreview() {
    const form = document.getElementById('editForm');
    const formData = new FormData(form);
    
    // Öffne Vorschau in neuem Tab/Fenster
    const previewUrl = '{{ url_for("wiki.view", slug=page.slug) }}';
    
    // Speichere temporär und öffne dann
    fetch('{{ url_for("wiki.edit", slug=page.slug) }}', {
        method: 'POST',
        body: formData
    })
    .then(response => {
        if (response.ok) {
            window.open(previewUrl, '_blank');
        } else {
            // Wenn Speichern fehlschlägt, öffne trotzdem Vorschau mit aktuellen Daten
            const previewWindow = window.open('', '_blank');
            previewWindow.document.write('<html><head><title>Vorschau</title></head><body>Lade Vorschau...</body></html>');
            
            // Nutze Preview-Endpoint
            fetch('{{ url_for("wiki.preview") }}', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                previewWindow.document.write(`
                    <html>
                        <head>
                            <title>Vorschau - {{ page.title }}</title>
                            <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
                            <style>
                                body { padding: 2rem; max-width: 1200px; margin: 0 auto; }
                                .markdown-content { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; line-height: 1.6; }
                            </style>
                        </head>
                        <body>
                            <div class="markdown-content">${data.html}</div>
                        </body>
                    </html>
                `);
            });
        }
    });
}

// Escape key zum Schließen
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        goBack();
    }
});
</script>
{% endblock %}


