{% extends "base.html" %}

{% block title %}{{ _('calendar.index.page_title') }}{% endblock %}

{% block content %}
<div class="row mb-3">
    <div class="col">
        <h1><i class="bi bi-calendar-event"></i> {{ _('calendar.index.heading') }}</h1>
    </div>
    <div class="col-auto">
        <div class="btn-group me-3 mb-2" role="group">
            <button type="button" class="btn btn-accent active" id="monthViewBtn">
                <i class="bi bi-calendar-month"></i> <span class="d-none d-md-inline">{{ _('calendar.index.view_buttons.month') }}</span>
            </button>
            <button type="button" class="btn btn-outline-accent" id="weekViewBtn">
                <i class="bi bi-calendar-week"></i> <span class="d-none d-md-inline">{{ _('calendar.index.view_buttons.week') }}</span>
            </button>
            <button type="button" class="btn btn-outline-accent" id="dayViewBtn">
                <i class="bi bi-calendar-day"></i> <span class="d-none d-md-inline">{{ _('calendar.index.view_buttons.day') }}</span>
            </button>
            <button type="button" class="btn btn-outline-accent" id="listViewBtn">
                <i class="bi bi-list-ul"></i> <span class="d-none d-md-inline">{{ _('calendar.index.view_buttons.list') }}</span>
            </button>
        </div>
        <div class="btn-group me-2 mb-2" role="group">
            <a href="{{ url_for('calendar.create_event') }}" class="btn btn-accent">
                <i class="bi bi-plus-circle"></i> <span class="d-none d-md-inline">{{ _('calendar.index.new_event') }}</span>
            </a>
            <button type="button" class="btn btn-accent dropdown-toggle dropdown-toggle-split" data-bs-toggle="dropdown" aria-expanded="false">
                <span class="visually-hidden">{{ _('calendar.index.dropdown.toggle') }}</span>
            </button>
            <ul class="dropdown-menu">
                <li><a class="dropdown-item" href="{{ url_for('calendar.export_calendar') }}"><i class="bi bi-download"></i> {{ _('calendar.index.dropdown.export') }}</a></li>
                <li><a class="dropdown-item" href="{{ url_for('calendar.import_calendar') }}"><i class="bi bi-upload"></i> {{ _('calendar.index.dropdown.import') }}</a></li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item" href="{{ url_for('calendar.manage_feeds') }}"><i class="bi bi-share"></i> {{ _('calendar.index.dropdown.feeds') }}</a></li>
            </ul>
        </div>
    </div>
</div>

<!-- Monatsansicht -->
<div id="monthView" class="calendar-view">
    <div class="row mb-3">
        <div class="col-auto">
            <button class="btn btn-outline-secondary" id="prevMonth">
                <i class="bi bi-chevron-left"></i>
            </button>
        </div>
        <div class="col text-center">
            <h3 id="currentMonth"></h3>
        </div>
        <div class="col-auto">
            <button class="btn btn-outline-secondary" id="nextMonth">
                <i class="bi bi-chevron-right"></i>
            </button>
        </div>
    </div>
    
    <div class="calendar-grid">
        <div class="calendar-header">
            {% for weekday in current_translations.get('calendar', {}).get('index', {}).get('weekday_short', []) %}
            <div class="day-header">{{ weekday }}</div>
            {% endfor %}
        </div>
        
        <div class="calendar-body" id="calendarBody">
            <!-- Kalender wird per JavaScript generiert -->
        </div>
    </div>
</div>

<!-- Terminübersicht -->
<div id="listView" class="calendar-view" style="display: none;">
    {% if events %}
    <div class="list-group">
        {% for event in events %}
        <div class="list-group-item list-group-item-action event-list-item">
            <div class="d-flex w-100 justify-content-between align-items-start">
                <div class="flex-grow-1">
                    <h5 class="mb-1">{{ event.title }}</h5>
                    <p class="mb-1">
                        <i class="bi bi-calendar"></i> {{ event.start_time.strftime('%d.%m.%Y') }}
                        {% set time_suffix = _('calendar.index.list.time_suffix') %}
                        <i class="bi bi-clock ms-2"></i> {{ event.start_time.strftime('%H:%M') }} - {{ event.end_time.strftime('%H:%M') }}{% if time_suffix %} {{ time_suffix }}{% endif %}
                        {% if event.location %}
                        <i class="bi bi-geo-alt ms-2"></i> {{ event.location }}
                        {% endif %}
                    </p>
                    {% if event.description %}
                    <p class="mb-1 text-muted">{{ event.description }}</p>
                    {% endif %}
                </div>
                <div class="ms-3">
                    {% set participation = participations.get(event.id) %}
                    {% if participation %}
                        {% if participation.status == 'accepted' %}
                        <span class="badge bg-success">{{ _('calendar.index.list.statuses.accepted') }}</span>
                        {% elif participation.status == 'declined' %}
                        <span class="badge bg-danger">{{ _('calendar.index.list.statuses.declined') }}</span>
                        {% elif participation.status == 'removed' %}
                        <span class="badge bg-secondary">{{ _('calendar.index.list.statuses.removed') }}</span>
                        {% else %}
                        <span class="badge bg-warning">{{ _('calendar.index.list.statuses.pending') }}</span>
                        {% endif %}
                    {% endif %}
                    <a href="{{ url_for('calendar.view_event', event_id=event.id) }}" class="btn btn-sm btn-outline-accent ms-2">
                        {{ _('calendar.index.list.details') }}
                    </a>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="alert alert-info">
        <i class="bi bi-info-circle"></i>
        {{ _('calendar.index.list.empty.message') }} {{ _('calendar.index.list.empty.hint') }}
    </div>
    {% endif %}
</div>

<!-- Wochenansicht -->
<div id="weekView" class="calendar-view" style="display: none;">
    <div class="row mb-3">
        <div class="col">
            <h4 id="weekTitle">{{ _('calendar.index.week.title_prefix') }}</h4>
        </div>
        <div class="col-auto">
            <div class="btn-group" role="group">
                <button type="button" class="btn btn-outline-primary" id="prevWeekBtn">
                    <i class="bi bi-chevron-left"></i>
                </button>
                <button type="button" class="btn btn-outline-primary" id="todayWeekBtn">{{ _('calendar.index.week.today') }}</button>
                <button type="button" class="btn btn-outline-primary" id="nextWeekBtn">
                    <i class="bi bi-chevron-right"></i>
                </button>
            </div>
        </div>
    </div>
    <div id="weekCalendar"></div>
</div>

<!-- Tagesansicht -->
<div id="dayView" class="calendar-view" style="display: none;">
    <div class="row mb-3">
        <div class="col">
            <h4 id="dayTitle">{{ _('calendar.index.day.title') }}</h4>
        </div>
        <div class="col-auto">
            <div class="btn-group" role="group">
                <button type="button" class="btn btn-outline-primary" id="prevDayBtn">
                    <i class="bi bi-chevron-left"></i>
                </button>
                <button type="button" class="btn btn-outline-primary" id="todayDayBtn">{{ _('calendar.index.day.today') }}</button>
                <button type="button" class="btn btn-outline-primary" id="nextDayBtn">
                    <i class="bi bi-chevron-right"></i>
                </button>
            </div>
        </div>
    </div>
    <div id="dayCalendar"></div>
</div>

<script>
const CAL_I18N = {{ current_translations.get('calendar', {}).get('index', {})|tojson }};
const CURRENT_LANG = "{{ current_language }}";
const LOCALE_MAP = { "de": "de-DE", "en": "en-US", "es": "es-ES", "pt": "pt-PT", "ru": "ru-RU" };

function getLocale() {
    return LOCALE_MAP[CURRENT_LANG] || CURRENT_LANG || "en-US";
}

function formatTooltip(event) {
    if (!CAL_I18N.events) {
        const locationText = event.location ? ` - ${event.location}` : "";
        return `${event.title} - ${event.time}${locationText}`;
    }
    const locationPrefix = event.location ? (CAL_I18N.events.location_prefix || "") + event.location : "";
    return CAL_I18N.events.tooltip
        .replace("{title}", event.title)
        .replace("{time}", event.time)
        .replace("{location}", locationPrefix);
}

document.addEventListener('DOMContentLoaded', function() {
    // View Toggle
    const monthViewBtn = document.getElementById('monthViewBtn');
    const weekViewBtn = document.getElementById('weekViewBtn');
    const dayViewBtn = document.getElementById('dayViewBtn');
    const listViewBtn = document.getElementById('listViewBtn');
    const monthView = document.getElementById('monthView');
    const weekView = document.getElementById('weekView');
    const dayView = document.getElementById('dayView');
    const listView = document.getElementById('listView');
    const currentMonthLabel = document.getElementById('currentMonth');
    const weekTitleElement = document.getElementById('weekTitle');
    const dayTitleElement = document.getElementById('dayTitle');
    const todayWeekBtn = document.getElementById('todayWeekBtn');
    const todayDayBtn = document.getElementById('todayDayBtn');

    if (todayWeekBtn) {
        todayWeekBtn.textContent = CAL_I18N.week?.today || todayWeekBtn.textContent;
    }
    if (todayDayBtn) {
        todayDayBtn.textContent = CAL_I18N.day?.today || todayDayBtn.textContent;
    }
    
    function switchView(activeView, activeBtn) {
        // Hide all views
        monthView.style.display = 'none';
        weekView.style.display = 'none';
        dayView.style.display = 'none';
        listView.style.display = 'none';
        
        // Remove active class from all buttons
        [monthViewBtn, weekViewBtn, dayViewBtn, listViewBtn].forEach(btn => {
            btn.classList.remove('active', 'btn-accent');
            btn.classList.add('btn-outline-accent');
        });
        
        // Show active view and button
        activeView.style.display = 'block';
        activeBtn.classList.add('active', 'btn-accent');
        activeBtn.classList.remove('btn-outline-accent');
    }
    
    monthViewBtn.addEventListener('click', function() {
        switchView(monthView, monthViewBtn);
        updateCalendar(); // Regenerate calendar when switching back
    });
    
    weekViewBtn.addEventListener('click', function() {
        switchView(weekView, weekViewBtn);
        generateWeekView();
    });
    
    dayViewBtn.addEventListener('click', function() {
        switchView(dayView, dayViewBtn);
        generateDayView();
    });
    
    listViewBtn.addEventListener('click', function() {
        switchView(listView, listViewBtn);
    });
    
    // Calendar Navigation
    let currentDate = new Date();
    const monthNames = CAL_I18N.month_names || [];
    
    function updateCalendar() {
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();
        const locale = getLocale();
        const monthName = monthNames[month] || new Date(year, month, 1).toLocaleDateString(locale, { month: 'long' });
        if (currentMonthLabel) {
            currentMonthLabel.textContent = `${monthName} ${year}`;
        }
        
        generateCalendar(year, month);
    }
    
    async function generateCalendar(year, month) {
        const calendarBody = document.getElementById('calendarBody');
        calendarBody.innerHTML = '';
        
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        const daysInMonth = lastDay.getDate();
        const startDay = (firstDay.getDay() + 6) % 7; // Montag = 0
        
        // Leere Zellen für Tage vor dem ersten Tag des Monats
        for (let i = 0; i < startDay; i++) {
            const emptyCell = document.createElement('div');
            emptyCell.className = 'calendar-day empty';
            calendarBody.appendChild(emptyCell);
        }
        
        // Tage des Monats
        for (let day = 1; day <= daysInMonth; day++) {
            const dayCell = document.createElement('div');
            dayCell.className = 'calendar-day';
            dayCell.textContent = day;
            
            // Heute markieren
            const today = new Date();
            if (year === today.getFullYear() && month === today.getMonth() && day === today.getDate()) {
                dayCell.classList.add('today');
            }
            
            calendarBody.appendChild(dayCell);
        }
        
        // Events für alle Tage laden (einmal für den ganzen Monat)
        await loadEventsForMonth(year, month + 1);
    }
    
    async function loadEventsForMonth(year, month) {
        try {
            const response = await fetch(`/calendar/api/events/${year}/${month}`);
            if (response.ok) {
                const events = await response.json();
                const calendarBody = document.getElementById('calendarBody');
                const dayCells = document.querySelectorAll('.calendar-day:not(.empty)');
                
                // Calculate first day of month and offset
                const firstDay = new Date(year, month - 1, 1);
                const startDayOffset = (firstDay.getDay() + 6) % 7; // Montag = 0
                
                // Create a map of day numbers to grid positions
                const dayToGridPosition = new Map();
                dayCells.forEach((cell, index) => {
                    const dayNum = parseInt(cell.textContent);
                    if (dayNum && !dayToGridPosition.has(dayNum)) {
                        dayToGridPosition.set(dayNum, startDayOffset + index);
                    }
                });
                
                // Separate single-day and multi-day events
                const singleDayEvents = [];
                const multiDayEvents = [];
                const monthStart = new Date(year, month - 1, 1);
                const monthEnd = new Date(year, month, 0, 23, 59, 59);
                
                events.forEach(event => {
                    // Calculate duration from dates to be more accurate
                    const eventStartDate = new Date(event.start_date + 'T00:00:00');
                    const eventEndDate = new Date(event.end_date + 'T23:59:59');
                    
                    // Use duration_days from API if available, otherwise calculate
                    let durationInDays = event.duration_days;
                    if (!durationInDays || durationInDays <= 0) {
                        // Calculate based on date difference
                        const startDateOnly = new Date(eventStartDate.getFullYear(), eventStartDate.getMonth(), eventStartDate.getDate());
                        const endDateOnly = new Date(eventEndDate.getFullYear(), eventEndDate.getMonth(), eventEndDate.getDate());
                        durationInDays = Math.floor((endDateOnly - startDateOnly) / (1000 * 60 * 60 * 24)) + 1;
                    }
                    
                    // Check if event overlaps with this month
                    if (eventEndDate >= monthStart && eventStartDate <= monthEnd) {
                        if (durationInDays > 1) {
                            multiDayEvents.push(event);
                        } else {
                            singleDayEvents.push(event);
                        }
                    }
                });
                
                // Process all events for each day
                // First, group events by day
                const eventsByDay = new Map();
                
                // Add single-day events
                singleDayEvents.forEach(event => {
                    const eventDate = new Date(event.start_date + 'T00:00:00');
                    const dayNum = eventDate.getDate();
                    
                    // Only add if event is within current month (check month and year)
                    if (eventDate.getFullYear() === year && eventDate.getMonth() === (month - 1)) {
                        if (!eventsByDay.has(dayNum)) {
                            eventsByDay.set(dayNum, { single: [], multi: [] });
                        }
                        eventsByDay.get(dayNum).single.push(event);
                    }
                });
                
                // Add multi-day events
                multiDayEvents.forEach(event => {
                    const startDate = new Date(event.start_date + 'T00:00:00');
                    const endDate = new Date(event.end_date + 'T23:59:59');
                    
                    // Calculate actual days to show in this month
                    let actualStartDay, actualEndDay;
                    
                    if (startDate < monthStart) {
                        // Event starts before this month
                        actualStartDay = 1;
                    } else if (startDate.getFullYear() === year && startDate.getMonth() === (month - 1)) {
                        // Event starts in this month
                        actualStartDay = startDate.getDate();
                    } else {
                        // Event starts after this month (shouldn't happen)
                        actualStartDay = 1;
                    }
                    
                    if (endDate > monthEnd) {
                        // Event ends after this month
                        actualEndDay = monthEnd.getDate();
                    } else if (endDate.getFullYear() === year && endDate.getMonth() === (month - 1)) {
                        // Event ends in this month
                        actualEndDay = endDate.getDate();
                    } else {
                        // Event ends before this month (shouldn't happen)
                        actualEndDay = monthEnd.getDate();
                    }
                    
                    // Show event on each day it spans
                    for (let day = actualStartDay; day <= actualEndDay; day++) {
                        if (!eventsByDay.has(day)) {
                            eventsByDay.set(day, { single: [], multi: [] });
                        }
                        
                        const isStart = (day === actualStartDay && startDate >= monthStart);
                        const isEnd = (day === actualEndDay && endDate <= monthEnd);
                        
                        eventsByDay.get(day).multi.push({
                            event: event,
                            day: day,
                            isStart: isStart,
                            isEnd: isEnd
                        });
                    }
                });
                
                // Render events for each day
                eventsByDay.forEach((dayEvents, dayNum) => {
                    const dayCell = Array.from(dayCells).find(cell => parseInt(cell.textContent) === dayNum);
                    if (!dayCell) return;
                    
                    // Add single-day events first
                    dayEvents.single.forEach(event => {
                        const eventElement = createEventElement(event);
                        dayCell.appendChild(eventElement);
                    });
                    
                    // Add multi-day events
                    dayEvents.multi.forEach(({ event, day, isStart, isEnd }) => {
                        const eventElement = createEventElement(event, true);
                        eventElement.classList.add('multi-day');
                        
                        // Add indicator for multi-day events
                        if (isStart) {
                            eventElement.textContent = `→ ${event.title}`;
                        } else if (isEnd) {
                            eventElement.textContent = `${event.title} ←`;
                        } else {
                            eventElement.textContent = `↔ ${event.title}`;
                        }
                        
                        dayCell.appendChild(eventElement);
                    });
                });
            }
        } catch (error) {
            console.error('Error loading events:', error);
        }
    }
    
    function createEventElement(event, isMultiDay = false) {
        const eventElement = document.createElement('div');
        eventElement.className = 'calendar-event';
        
        // Add status-based styling
        if (event.participation_status === 'accepted') {
            eventElement.classList.add('accepted');
        } else if (event.participation_status === 'declined') {
            eventElement.classList.add('declined');
        } else if (event.participation_status === 'removed') {
            eventElement.classList.add('removed');
        } else {
            eventElement.classList.add('pending');
        }
        
        eventElement.textContent = event.title;
        const timeText = event.time || 'Ganztägig';
        eventElement.title = `${event.title} - ${timeText}${event.location ? ' - ' + event.location : ''}`;
        
        // Make event clickable
        eventElement.style.cursor = 'pointer';
        eventElement.addEventListener('click', function() {
            window.location.href = event.url;
        });
        
        return eventElement;
    }
    
    document.getElementById('prevMonth').addEventListener('click', function() {
        currentDate.setMonth(currentDate.getMonth() - 1);
        updateCalendar();
    });
    
    document.getElementById('nextMonth').addEventListener('click', function() {
        currentDate.setMonth(currentDate.getMonth() + 1);
        updateCalendar();
    });
    
    // Initial calendar generation
    updateCalendar();
    
    // Week View Functions
    let currentWeekDate = new Date();
    
    function isMobileView() {
        return window.innerWidth < 768; // Bootstrap md breakpoint
    }
    
    function getDaysToShow() {
        return isMobileView() ? 3 : 7;
    }
    
    function generateWeekView() {
        const weekCalendar = document.getElementById('weekCalendar');
        const weekTitle = weekTitleElement;
        
        // Determine number of days to show based on screen width
        const daysToShow = getDaysToShow();
        
        // Get start date - on mobile, start from current date, on desktop start from Monday
        let startDate;
        if (isMobileView()) {
            // On mobile, start from current date (today or the day we're viewing)
            startDate = new Date(currentWeekDate);
        } else {
            // On desktop, start from Monday
            const day = currentWeekDate.getDay();
            const diff = currentWeekDate.getDate() - day + (day === 0 ? -6 : 1);
            startDate = new Date(currentWeekDate);
            startDate.setDate(diff);
        }
        
        // Get end date
        const endDate = new Date(startDate);
        endDate.setDate(startDate.getDate() + daysToShow - 1);
        
        if (weekTitle) {
            const locale = getLocale();
            const prefix = CAL_I18N.week?.title_prefix || 'Week';
            const separator = CAL_I18N.week?.range_separator || ' - ';
            const startLabel = startDate.toLocaleDateString(locale, { day: 'numeric', month: 'numeric', year: 'numeric' });
            const endLabel = endDate.toLocaleDateString(locale, { day: 'numeric', month: 'numeric', year: 'numeric' });
            weekTitle.textContent = `${prefix} ${startLabel}${separator}${endLabel}`;
        }
        
        // Generate week grid
        const days = CAL_I18N.weekday_long || ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
        const daysShort = CAL_I18N.weekday_short || ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
        const hours = Array.from({length: 24}, (_, i) => i); // 00:00 bis 23:00
        const timeColumnLabel = CAL_I18N.week?.time_column || 'Time';
        
        let html = '<div class="week-grid">';
        html += '<div class="week-header">';
        html += `<div class="time-column">${timeColumnLabel}</div>`;
        
        for (let i = 0; i < daysToShow; i++) {
            const date = new Date(startDate);
            date.setDate(startDate.getDate() + i);
            const isToday = date.toDateString() === new Date().toDateString();
            // Get correct weekday index (Monday = 0, Sunday = 6)
            const weekdayIndex = date.getDay() === 0 ? 6 : date.getDay() - 1;
            const dayName = isMobileView() ? daysShort[weekdayIndex] : days[weekdayIndex];
            html += `<div class="day-header ${isToday ? 'today' : ''}">${dayName}<br><small>${date.getDate()}.${date.getMonth() + 1}</small></div>`;
        }
        html += '</div>';
        
        // Bereich für mehrtägige Events zwischen Header und 0:00
        html += '<div class="week-multi-day-events">';
        html += '<div class="time-label">Ganztägig</div>';
        for (let day = 0; day < daysToShow; day++) {
            const date = new Date(startDate);
            date.setDate(startDate.getDate() + day);
            html += `<div class="week-multi-day-slot" data-date="${date.toISOString().split('T')[0]}"></div>`;
        }
        html += '</div>';
        
        // Time slots
        for (const hour of hours) {
            html += '<div class="time-row">';
            html += `<div class="time-label">${hour.toString().padStart(2, '0')}:00</div>`;
            
            for (let day = 0; day < daysToShow; day++) {
                const date = new Date(startDate);
                date.setDate(startDate.getDate() + day);
                html += `<div class="time-slot" data-date="${date.toISOString().split('T')[0]}" data-hour="${hour}"></div>`;
            }
            html += '</div>';
        }
        
        html += '</div>';
        weekCalendar.innerHTML = html;
        
        // Load events for the period
        loadWeekEvents(startDate, endDate);
    }
    
    async function loadWeekEvents(startDate, endDate) {
        try {
            const response = await fetch(`/calendar/api/events/range/${startDate.toISOString().split('T')[0]}/${endDate.toISOString().split('T')[0]}`);
            if (response.ok) {
                const events = await response.json();
                
                // Separate single-day and multi-day events
                const singleDayEvents = [];
                const multiDayEvents = [];
                
                events.forEach(event => {
                    if (event.duration_days && event.duration_days > 1) {
                        multiDayEvents.push(event);
                    } else {
                        singleDayEvents.push(event);
                    }
                });
                
                // Handle single-day events - only in time slots
                singleDayEvents.forEach(event => {
                    const eventDate = new Date(event.start_time).toISOString().split('T')[0];
                    const eventHour = new Date(event.start_time).getHours();
                    const timeSlot = document.querySelector(`.time-slot[data-date="${eventDate}"][data-hour="${eventHour}"]`);
                    
                    if (timeSlot) {
                        const eventElement = document.createElement('div');
                        eventElement.className = `calendar-event ${event.participation_status || 'pending'}`;
                        const timeText = event.time || 'Ganztägig';
                        eventElement.innerHTML = `
                            <strong>${timeText}</strong><br>
                            ${event.title}
                            ${event.location ? `<br><small><i class="bi bi-geo-alt"></i> ${event.location}</small>` : ''}
                        `;
                        eventElement.title = formatTooltip(event);
                        eventElement.onclick = () => window.location.href = event.url;
                        timeSlot.appendChild(eventElement);
                    }
                });
                
                // Handle multi-day events - show in multi-day slot above 0:00
                multiDayEvents.forEach(event => {
                    const eventStartDate = new Date(event.start_date + 'T00:00:00');
                    const eventEndDate = new Date(event.end_date + 'T23:59:59');
                    const daysToShow = getDaysToShow();
                    
                    // Show event on each day it spans within the visible period
                    for (let day = 0; day < daysToShow; day++) {
                        const currentDate = new Date(startDate);
                        currentDate.setDate(startDate.getDate() + day);
                        const currentDateStr = currentDate.toISOString().split('T')[0];
                        
                        // Check if event spans this day
                        if (currentDate >= eventStartDate && currentDate <= eventEndDate) {
                            const multiDaySlot = document.querySelector(`.week-multi-day-slot[data-date="${currentDateStr}"]`);
                            
                            if (multiDaySlot) {
                                const eventElement = document.createElement('div');
                                eventElement.className = `calendar-event multi-day ${event.participation_status || 'pending'}`;
                                let titleText = event.title;
                                
                                // Add indicators for start/end
                                if (currentDateStr === event.start_date) {
                                    titleText = `→ ${event.title}`;
                                } else if (currentDateStr === event.end_date) {
                                    titleText = `${event.title} ←`;
                                } else {
                                    titleText = `↔ ${event.title}`;
                                }
                                
                                eventElement.innerHTML = `
                                    ${titleText}
                                    ${event.location ? `<br><small><i class="bi bi-geo-alt"></i> ${event.location}</small>` : ''}
                                `;
                                eventElement.title = `${event.title} - ${event.start_date} bis ${event.end_date}${event.location ? ' - ' + event.location : ''}`;
                                eventElement.onclick = () => window.location.href = event.url;
                                multiDaySlot.appendChild(eventElement);
                            }
                        }
                    }
                });
            }
        } catch (error) {
            console.error('Error loading week events:', error);
        }
    }
    
    // Day View Functions
    let currentDayDate = new Date();
    
    function generateDayView() {
        const dayCalendar = document.getElementById('dayCalendar');
        const dayTitle = dayTitleElement;
        const locale = getLocale();

        const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        if (dayTitle) {
            dayTitle.textContent = currentDayDate.toLocaleDateString(locale, options);
        }

        const hours = Array.from({length: 24}, (_, i) => i);
        let html = '<div class="day-grid">';
        
        // Bereich für mehrtägige Events über 0:00
        html += '<div class="day-multi-day-events">';
        html += '<div class="day-time-label">Ganztägig</div>';
        html += '<div class="day-multi-day-slot" id="dayMultiDaySlot"></div>';
        html += '</div>';

        for (const hour of hours) {
            html += '<div class="day-time-row">';
            html += `<div class="day-time-label">${hour.toString().padStart(2, '0')}:00</div>`;
            html += `<div class="day-time-slot" data-hour="${hour}"></div>`;
            html += '</div>';
        }

        html += '</div>';
        dayCalendar.innerHTML = html;

        loadDayEvents(currentDayDate);
    }

    async function loadDayEvents(date) {
        try {
            const dateStr = date.toISOString().split('T')[0];
            const response = await fetch(`/calendar/api/events/range/${dateStr}/${dateStr}`);
            if (response.ok) {
                const events = await response.json();
                const multiDaySlot = document.getElementById('dayMultiDaySlot');
                
                // Separate single-day and multi-day events
                const singleDayEvents = [];
                const multiDayEvents = [];
                
                events.forEach(event => {
                    const eventStartDate = new Date(event.start_date + 'T00:00:00');
                    const eventEndDate = new Date(event.end_date + 'T23:59:59');
                    const currentDate = new Date(dateStr + 'T00:00:00');
                    
                    // Check if event spans this day
                    if (currentDate >= eventStartDate && currentDate <= eventEndDate) {
                        if (event.duration_days && event.duration_days > 1) {
                            multiDayEvents.push(event);
                        } else {
                            singleDayEvents.push(event);
                        }
                    }
                });
                
                // Handle multi-day events - display above 0:00
                multiDayEvents.forEach(event => {
                    const eventStartDate = new Date(event.start_date + 'T00:00:00');
                    const currentDate = new Date(dateStr + 'T00:00:00');
                    const dayNumber = Math.floor((currentDate - eventStartDate) / (1000 * 60 * 60 * 24)) + 1;
                    
                    let prefix = '';
                    if (dateStr === event.start_date) {
                        prefix = '→ ';
                    } else if (dateStr === event.end_date) {
                        prefix = '';
                    } else {
                        prefix = '↔ ';
                    }
                    
                    const titleText = `${prefix}${event.title} (Tag ${dayNumber}/${event.duration_days})`;
                    
                    const eventElement = document.createElement('div');
                    eventElement.className = `calendar-event multi-day ${event.participation_status || 'pending'}`;
                    eventElement.innerHTML = `
                        ${titleText}
                        ${event.location ? `<br><small><i class="bi bi-geo-alt"></i> ${event.location}</small>` : ''}
                    `;
                    eventElement.title = `${event.title} - ${event.start_date} bis ${event.end_date}${event.location ? ' - ' + event.location : ''}`;
                    eventElement.onclick = () => window.location.href = event.url;
                    if (multiDaySlot) {
                        multiDaySlot.appendChild(eventElement);
                    }
                });
                
                // Handle single-day events with time - display in time slots
                singleDayEvents.forEach(event => {
                    const eventHour = new Date(event.start_time).getHours();
                    const timeSlot = document.querySelector(`.day-time-slot[data-hour="${eventHour}"]`);

                    if (timeSlot) {
                        const eventElement = document.createElement('div');
                        eventElement.className = `calendar-event ${event.participation_status || 'pending'}`;
                        
                        const timeText = event.time || 'Ganztägig';
                        eventElement.innerHTML = `
                            <strong>${timeText}</strong><br>
                            ${event.title}
                            ${event.location ? `<br><small><i class="bi bi-geo-alt"></i> ${event.location}</small>` : ''}
                        `;
                        eventElement.title = formatTooltip(event);
                        eventElement.onclick = () => window.location.href = event.url;
                        timeSlot.appendChild(eventElement);
                    }
                });
            }
        } catch (error) {
            console.error('Error loading day events:', error);
        }
    }
    
    // Week Navigation
    document.getElementById('prevWeekBtn').addEventListener('click', function() {
        const daysToJump = getDaysToShow();
        currentWeekDate.setDate(currentWeekDate.getDate() - daysToJump);
        generateWeekView();
    });
    
    document.getElementById('nextWeekBtn').addEventListener('click', function() {
        const daysToJump = getDaysToShow();
        currentWeekDate.setDate(currentWeekDate.getDate() + daysToJump);
        generateWeekView();
    });
    
    document.getElementById('todayWeekBtn').addEventListener('click', function() {
        currentWeekDate = new Date();
        generateWeekView();
    });
    
    // Regenerate week view on window resize to adapt to mobile/desktop
    let resizeTimer;
    window.addEventListener('resize', function() {
        clearTimeout(resizeTimer);
        resizeTimer = setTimeout(function() {
            if (weekView.style.display !== 'none') {
                generateWeekView();
            }
        }, 250);
    });
    
    // Day Navigation
    document.getElementById('prevDayBtn').addEventListener('click', function() {
        currentDayDate.setDate(currentDayDate.getDate() - 1);
        generateDayView();
    });
    
    document.getElementById('nextDayBtn').addEventListener('click', function() {
        currentDayDate.setDate(currentDayDate.getDate() + 1);
        generateDayView();
    });
    
    document.getElementById('todayDayBtn').addEventListener('click', function() {
        currentDayDate = new Date();
        generateDayView();
    });
});
</script>
{% endblock %}



