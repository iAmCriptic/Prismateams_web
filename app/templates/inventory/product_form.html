{% extends "base.html" %}

{% block title %}{% if product %}Produkt bearbeiten{% else %}Produkt hinzufügen{% endif %} - Team Portal{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <h1 class="mb-3">
            <i class="bi bi-{% if product %}pencil{% else %}plus-circle{% endif %}"></i> 
            {% if product %}Produkt bearbeiten{% else %}Produkt hinzufügen{% endif %}
        </h1>
    </div>
</div>

<div class="row">
    <div class="col-12 col-lg-8">
        <div class="card">
            <div class="card-body">
                <form method="POST" enctype="multipart/form-data">
                    <!-- Name (Pflichtfeld) -->
                    <div class="mb-3">
                        <label for="name" class="form-label">Produktname <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="name" name="name" 
                               value="{{ product.name if product else '' }}" required>
                    </div>

                    <!-- Beschreibung -->
                    <div class="mb-3">
                        <label for="description" class="form-label">Beschreibung / Details</label>
                        <textarea class="form-control" id="description" name="description" rows="3">{{ product.description if product else '' }}</textarea>
                    </div>

                    <div class="row">
                        <!-- Ordner -->
                        <div class="col-md-6 mb-3">
                            <label for="folder_id" class="form-label">Ordner</label>
                            <div class="input-group">
                                <select class="form-select" id="folder_id" name="folder_id">
                                    <option value="">Kein Ordner</option>
                                    {% for folder in folders %}
                                    <option value="{{ folder.id }}" {% if product and product.folder_id == folder.id %}selected{% endif %}>{{ folder.name }}</option>
                                    {% endfor %}
                                </select>
                                <button class="btn btn-outline-primary" type="button" id="addFolderBtn" title="Neuen Ordner anlegen">
                                    <i class="bi bi-plus"></i>
                                </button>
                                <button class="btn btn-outline-secondary" type="button" id="manageFoldersBtn" title="Ordner verwalten">
                                    <i class="bi bi-pencil"></i>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Kategorie -->
                        <div class="col-md-6 mb-3">
                            <label for="category" class="form-label">Kategorie</label>
                            <div class="input-group">
                                <select class="form-select" id="category" name="category">
                                    <option value="">Keine Kategorie</option>
                                    {% for cat in categories %}
                                    <option value="{{ cat }}" {% if product and product.category == cat %}selected{% endif %}>{{ cat }}</option>
                                    {% endfor %}
                                </select>
                                <button class="btn btn-outline-primary" type="button" id="addCategoryBtn" title="Neue Kategorie anlegen">
                                    <i class="bi bi-plus"></i>
                                </button>
                                <button class="btn btn-outline-secondary" type="button" id="manageCategoriesBtn" title="Kategorien verwalten">
                                    <i class="bi bi-pencil"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Zustand -->
                        <div class="col-md-6 mb-3">
                            <label for="condition" class="form-label">Zustand</label>
                            <select class="form-select" id="condition" name="condition">
                                <option value="">Bitte wählen...</option>
                                <option value="Neu" {% if product and product.condition == 'Neu' %}selected{% endif %}>Neu</option>
                                <option value="Gut" {% if product and product.condition == 'Gut' %}selected{% endif %}>Gut</option>
                                <option value="Gebraucht" {% if product and product.condition == 'Gebraucht' %}selected{% endif %}>Gebraucht</option>
                                <option value="Beschädigt" {% if product and product.condition == 'Beschädigt' %}selected{% endif %}>Beschädigt</option>
                            </select>
                        </div>
                    </div>

                    <div class="row">
                        <!-- Seriennummer -->
                        <div class="col-md-4 mb-3">
                            <label for="serial_number" class="form-label">Seriennummer</label>
                            <input type="text" class="form-control" id="serial_number" name="serial_number" 
                                   value="{{ product.serial_number if product else '' }}">
                        </div>

                        <!-- Lagerort -->
                        <div class="col-md-4 mb-3">
                            <label for="location" class="form-label">Lagerort</label>
                            <input type="text" class="form-control" id="location" name="location" 
                                   value="{{ product.location if product else '' }}">
                        </div>

                        <!-- Länge -->
                        <div class="col-md-4 mb-3">
                            {% set length_form_value = request.form.get('length') %}
                            {% if length_form_value %}
                                {% set length_value = length_form_value | replace(',', '.') %}
                            {% elif product and product.length_meters is not none %}
                                {% set length_value = product.length_meters %}
                            {% else %}
                                {% set length_value = '' %}
                            {% endif %}
                            <label for="length" class="form-label">Länge (in Metern)</label>
                            <input type="number" class="form-control" id="length" name="length"
                                   value="{{ length_value }}" step="0.01" min="0"
                                   placeholder="z.B. 5.5">
                            <small class="form-text text-muted">Bitte Meterwerte mit Punkt oder Komma als Dezimaltrennzeichen eingeben.</small>
                        </div>
                    </div>

                    <!-- Anschaffungsdatum -->
                    <div class="mb-3">
                        <label for="purchase_date" class="form-label">Anschaffungsdatum</label>
                        <input type="date" class="form-control" id="purchase_date" name="purchase_date" 
                               value="{{ purchase_date_formatted if purchase_date_formatted else '' }}">
                    </div>

                    <!-- Status -->
                    {% if product %}
                    <div class="mb-3">
                        <label for="status" class="form-label">Status</label>
                        <select class="form-select" id="status" name="status">
                            <option value="available" {% if product.status == 'available' %}selected{% endif %}>Verfügbar</option>
                            <option value="borrowed" {% if product.status == 'borrowed' %}selected{% endif %}>Ausgeliehen</option>
                            <option value="missing" {% if product.status == 'missing' %}selected{% endif %}>Fehlend</option>
                        </select>
                    </div>
                    {% endif %}

                    <!-- Bild-Upload -->
                    <div class="mb-3">
                        <label for="image" class="form-label">Produktbild</label>
                        <input type="file" class="form-control" id="image" name="image" accept="image/*">
                        {% if product and product.image_path %}
                        <div class="mt-2">
                            <small class="text-muted">Aktuelles Bild:</small><br>
                            {% set image_filename = product.image_path.split('/')[-1] if '/' in product.image_path else product.image_path %}
                            {% set image_filename = image_filename.split('\\')[-1] if '\\' in image_filename else image_filename %}
                            <img src="{{ url_for('inventory.serve_product_image', filename=image_filename) }}" alt="Produktbild" class="img-thumbnail mt-2" style="max-width: 200px;">
                            <div class="mt-2">
                                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeProductImage({{ product.id }})">
                                    <i class="bi bi-trash"></i> Bild entfernen
                                </button>
                            </div>
                            <input type="hidden" id="remove_image" name="remove_image" value="0">
                        </div>
                        {% endif %}
                    </div>

                    <!-- Anzahl (nur beim Erstellen) -->
                    {% if not product %}
                    <div class="mb-3">
                        <label for="quantity" class="form-label">Anzahl</label>
                        <input type="number" class="form-control" id="quantity" name="quantity" 
                               value="1" min="1" max="100" required>
                        <small class="form-text text-muted">Geben Sie an, wie viele Produkte mit denselben Attributen erstellt werden sollen.</small>
                    </div>
                    {% endif %}

                    <!-- Buttons -->
                    <div class="d-flex justify-content-between">
                        <a href="{{ url_for('inventory.stock') }}" class="btn btn-secondary">Abbrechen</a>
                        <button type="submit" class="btn btn-accent">
                            <i class="bi bi-check-circle"></i> {% if product %}Speichern{% else %}Erstellen{% endif %}
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Ordner verwalten Modal -->
<div class="modal fade" id="manageFoldersModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-folder"></i> Ordner verwalten</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <button class="btn btn-sm btn-primary mb-3" id="modalCreateFolderBtn">
                    <i class="bi bi-plus"></i> Neuer Ordner
                </button>
                <ul class="list-group" id="folderList"></ul>
                <div class="alert alert-info mt-3" id="foldersEmptyHint" style="display: none;">
                    <i class="bi bi-info-circle"></i> Noch keine Ordner vorhanden.
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Kategorien verwalten Modal -->
<div class="modal fade" id="manageCategoriesModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-tags"></i> Kategorien verwalten</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <button class="btn btn-sm btn-primary mb-3" id="modalCreateCategoryBtn">
                    <i class="bi bi-plus"></i> Neue Kategorie
                </button>
                <ul class="list-group" id="categoryList"></ul>
                <div class="alert alert-info mt-3" id="categoriesEmptyHint" style="display: none;">
                    <i class="bi bi-info-circle"></i> Noch keine Kategorien vorhanden.
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Eintrag bearbeiten Modal (wird für Ordner und Kategorien genutzt) -->
<div class="modal fade" id="entryModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="entryModalTitle"></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="entryForm">
                    <input type="hidden" id="entryType">
                    <input type="hidden" id="entryId">
                    <div class="mb-3">
                        <label for="entryName" class="form-label" id="entryNameLabel"></label>
                        <input type="text" class="form-control" id="entryName" required>
                    </div>
                    <div class="d-flex justify-content-between align-items-center">
                        <button type="button" class="btn btn-outline-danger" id="entryDeleteBtn" style="display: none;">
                            <i class="bi bi-trash"></i> Löschen
                        </button>
                        <div class="ms-auto">
                            <button type="button" class="btn btn-secondary me-2" data-bs-dismiss="modal">Abbrechen</button>
                            <button type="submit" class="btn btn-primary" id="entrySubmitBtn"></button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

{% block extra_js %}
{{ super() }}
<script>
function removeProductImage(productId) {
    if (confirm('Möchten Sie das Produktbild wirklich entfernen?')) {
        // Setze hidden input für Bild-Entfernung
        const removeInput = document.getElementById('remove_image');
        if (removeInput) {
            removeInput.value = '1';
        }
        // Verstecke Bild-Vorschau
        const imageContainer = document.querySelector('.img-thumbnail');
        if (imageContainer) {
            imageContainer.closest('div.mt-2').style.display = 'none';
        }
    }
}

window.inventoryFormData = {
    folders: [
        {% for folder in folders %}
        { id: {{ folder.id }}, name: {{ folder.name|tojson }} }{% if not loop.last %}, {% endif %}
        {% endfor %}
    ],
    categories: {{ categories|tojson }},
    selectedFolderId: {% if product and product.folder_id %}{{ product.folder_id }}{% else %}null{% endif %},
    selectedCategory: {% if product and product.category %}{{ product.category|tojson }}{% else %}null{% endif %}
};
</script>
<script src="{{ url_for('static', filename='js/product_form.js') }}"></script>
{% endblock %}
{% endblock %}

