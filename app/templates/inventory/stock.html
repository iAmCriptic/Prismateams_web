{% extends "base.html" %}

{% block title %}{{ _('inventory.stock.page_title') }}{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <h1 class="mb-3">
            <i class="bi bi-box-seam"></i> {{ _('inventory.stock.heading') }}
            {% if current_folder %}
                <small class="text-muted">- {{ current_folder.name }}</small>
            {% endif %}
        </h1>
        {% if current_folder %}
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{{ url_for('inventory.stock') }}">{{ _('inventory.stock.breadcrumb_root') }}</a></li>
                <li class="breadcrumb-item active" aria-current="page">{{ current_folder.name }}</li>
            </ol>
        </nav>
        {% endif %}
    </div>
    <div class="col-auto d-flex gap-2">
        <button id="borrowSelectedBtn" class="btn btn-primary" style="display: none;">
            <i class="bi bi-cart-check"></i> {{ _('inventory.stock.borrow_selected') }} (<span id="selectedCount">0</span>)
        </button>
        <a href="{{ url_for('inventory.product_new') }}" class="btn btn-accent">
            <i class="bi bi-plus-circle"></i> {{ _('inventory.stock.add_product') }}
        </a>
    </div>
</div>

<!-- Such- und Filterleiste -->
<div class="card mb-4">
    <div class="card-body">
        <!-- Erweiterte Suche (immer sichtbar) -->
        <div class="row g-3 mb-3">
            <div class="col-12">
                <label for="searchInput" class="form-label">{{ _('inventory.stock.search.label') }}</label>
                <input type="text" class="form-control" id="searchInput" 
                       placeholder="{{ _('inventory.stock.search.placeholder') }}">
                <small class="form-text text-muted">{{ _('inventory.stock.search.help') }}</small>
            </div>
        </div>
        
        <!-- Schnellfilter -->
        <div class="mb-3">
            <label class="form-label">{{ _('inventory.stock.quick_filters.label') }}</label>
            <div class="d-flex flex-wrap gap-2">
                <button type="button" class="btn btn-sm btn-outline-primary quick-filter" data-filter="all">
                    <i class="bi bi-list-ul"></i> {{ _('inventory.stock.quick_filters.all') }}
                </button>
                <button type="button" class="btn btn-sm btn-outline-primary quick-filter" data-filter="favorites">
                    <i class="bi bi-star-fill"></i> {{ _('inventory.stock.quick_filters.favorites') }}
                </button>
                <button type="button" class="btn btn-sm btn-outline-primary quick-filter" data-filter="available">
                    <i class="bi bi-check-circle"></i> {{ _('inventory.stock.quick_filters.available') }}
                </button>
                <button type="button" class="btn btn-sm btn-outline-primary quick-filter" data-filter="borrowed">
                    <i class="bi bi-clock-history"></i> {{ _('inventory.stock.quick_filters.borrowed') }}
                </button>
            </div>
        </div>
        
        <!-- Filter & Sortierung -->
        <div class="row g-3">
            <div class="col-12 col-xl-6">
                <div class="accordion" id="filterAccordion">
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="filterHeading">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" 
                                    data-bs-target="#filterCollapse" aria-expanded="false" aria-controls="filterCollapse">
                                <i class="bi bi-funnel me-2"></i> {{ _('inventory.stock.filters.title') }}
                            </button>
                        </h2>
                        <div id="filterCollapse" class="accordion-collapse collapse" 
                             aria-labelledby="filterHeading" data-bs-parent="#filterAccordion">
                            <div class="accordion-body">
                                <div class="row g-3">
                                    <div class="col-12 col-md-6">
                                        <label for="categoryFilter" class="form-label">{{ _('inventory.stock.filters.category') }}</label>
                                        <select class="form-select" id="categoryFilter">
                                            <option value="">{{ _('inventory.stock.filters.all_categories') }}</option>
                                        </select>
                                    </div>
                                    <div class="col-12 col-md-6">
                                        <label for="statusFilter" class="form-label">{{ _('inventory.stock.filters.status') }}</label>
                                        <select class="form-select" id="statusFilter">
                                            <option value="">{{ _('inventory.stock.filters.all_status') }}</option>
                                            <option value="available">{{ _('inventory.stock.filters.available') }}</option>
                                            <option value="borrowed">{{ _('inventory.stock.filters.borrowed') }}</option>
                                            <option value="missing">{{ _('inventory.stock.filters.missing') }}</option>
                                        </select>
                                    </div>
                                    <div class="col-12 col-md-6">
                                        <label for="conditionFilter" class="form-label">{{ _('inventory.stock.filters.condition') }}</label>
                                        <select class="form-select" id="conditionFilter">
                                            <option value="">{{ _('inventory.stock.filters.all_conditions') }}</option>
                                        </select>
                                    </div>
                                    <div class="col-12 col-md-6">
                                        <label for="locationFilter" class="form-label">{{ _('inventory.stock.filters.location') }}</label>
                                        <select class="form-select" id="locationFilter">
                                            <option value="">{{ _('inventory.stock.filters.all_locations') }}</option>
                                        </select>
                                    </div>
                                    <div class="col-12 col-md-6">
                                        <label for="lengthFilter" class="form-label">{{ _('inventory.stock.filters.length') }}</label>
                                        <select class="form-select" id="lengthFilter">
                                            <option value="">{{ _('inventory.stock.filters.all_lengths') }}</option>
                                        </select>
                                    </div>
                                    <div class="col-12">
                                        <label for="purchaseYearFilter" class="form-label">{{ _('inventory.stock.filters.purchase_year') }}</label>
                                        <select class="form-select" id="purchaseYearFilter">
                                            <option value="">{{ _('inventory.stock.filters.all_years') }}</option>
                                        </select>
                                    </div>
                                    <div class="col-12">
                                        <button type="button" class="btn btn-sm btn-outline-secondary" id="resetFiltersBtn">
                                            <i class="bi bi-x-circle"></i> {{ _('inventory.stock.filters.reset') }}
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-12 col-xl-6">
                <div class="accordion" id="sortAccordion">
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="sortHeading">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                    data-bs-target="#sortCollapse" aria-expanded="false" aria-controls="sortCollapse">
                                <i class="bi bi-arrow-down-up me-2"></i> {{ _('inventory.stock.sort.title') }}
                            </button>
                        </h2>
                        <div id="sortCollapse" class="accordion-collapse collapse"
                             aria-labelledby="sortHeading" data-bs-parent="#sortAccordion">
                            <div class="accordion-body">
                                <div class="row g-3">
                                    <div class="col-12">
                                        <label for="sortField" class="form-label">{{ _('inventory.stock.sort.field') }}</label>
                                        <select class="form-select" id="sortField">
                                            <option value="name">{{ _('inventory.stock.sort.name') }}</option>
                                            <option value="category">{{ _('inventory.stock.sort.category') }}</option>
                                            <option value="condition">{{ _('inventory.stock.sort.condition') }}</option>
                                            <option value="length">{{ _('inventory.stock.sort.length') }}</option>
                                        </select>
                                    </div>
                                    <div class="col-12">
                                        <label for="sortDirection" class="form-label">{{ _('inventory.stock.sort.direction') }}</label>
                                        <select class="form-select" id="sortDirection">
                                            <option value="asc">{{ _('inventory.stock.sort.asc') }}</option>
                                            <option value="desc">{{ _('inventory.stock.sort.desc') }}</option>
                                        </select>
                                    </div>
                                    <div class="col-12 d-flex gap-2">
                                        <button type="button" class="btn btn-outline-secondary flex-fill" id="resetSortBtn">
                                            <i class="bi bi-arrow-counterclockwise"></i> {{ _('inventory.stock.sort.reset') }}
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Bulk-Auswahl Toolbar -->
<div id="bulkSelectionToolbar" class="card mb-3" style="display: none;">
    <div class="card-body py-2">
        <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
            <div class="d-flex gap-2 align-items-center">
                <span class="text-muted me-2">
                    <strong id="bulkSelectionCount">0</strong> {{ _('inventory.stock.bulk_selection.selected') }}
                </span>
            </div>
            <div class="d-flex gap-2 flex-wrap">
                <button id="bulkSelectAllBtn" class="btn btn-sm btn-outline-primary" title="{{ _('inventory.stock.bulk_selection.select_all') }}">
                    <i class="bi bi-check-square"></i> {{ _('inventory.stock.bulk_selection.select_all') }}
                </button>
                <button id="bulkDeselectAllBtn" class="btn btn-sm btn-outline-secondary" title="{{ _('inventory.stock.bulk_selection.deselect_all') }}">
                    <i class="bi bi-square"></i> {{ _('inventory.stock.bulk_selection.deselect_all') }}
                </button>
                <div class="vr"></div>
                <button id="bulkEditBtn" class="btn btn-sm btn-primary" title="{{ _('inventory.stock.bulk_selection.edit') }}">
                    <i class="bi bi-pencil"></i> {{ _('inventory.stock.bulk_selection.edit') }}
                </button>
                <button id="bulkBorrowBtn" class="btn btn-sm btn-success" title="{{ _('inventory.stock.bulk_selection.borrow') }}">
                    <i class="bi bi-cart-check"></i> {{ _('inventory.stock.bulk_selection.borrow') }}
                </button>
                <button id="bulkDeleteBtn" class="btn btn-sm btn-danger" title="{{ _('inventory.stock.bulk_selection.delete') }}">
                    <i class="bi bi-trash"></i> {{ _('inventory.stock.bulk_selection.delete') }}
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Produktliste -->
<div class="card">
    <div class="card-body">
        <div class="mb-3 d-flex justify-content-between align-items-center flex-wrap gap-2">
            <div class="d-flex gap-2">
                {% if current_folder %}
                <a href="{{ url_for('inventory.stock') }}" class="btn btn-sm btn-outline-secondary">
                    <i class="bi bi-arrow-left"></i> Zurück
                </a>
                {% endif %}
            </div>
            <div class="d-flex gap-2 align-items-center">
                <!-- View Toggle -->
                <div class="btn-group" role="group">
                    <button class="btn btn-sm btn-outline-secondary" id="listViewBtn" title="{{ _('inventory.stock.views.list') }}">
                        <i class="bi bi-list"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-secondary active" id="gridViewBtn" title="{{ _('inventory.stock.views.grid') }}">
                        <i class="bi bi-grid-3x3-gap"></i>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Grid View Container -->
        <div id="gridViewContainer">
            <!-- Ordner Grid View -->
            <div id="foldersGridView" class="row g-3 mb-4" style="display: none;">
                <!-- Wird dynamisch gefüllt -->
            </div>
            
            <!-- Produkte Grid View -->
            <div id="productsGridContainer">
                <div id="productsContainer" class="row g-3">
                    <div class="text-center py-5 col-12">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Lädt...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- List View Container -->
        <div id="listViewContainer" style="display: none;">
            <!-- Ordner List View -->
            <div id="foldersListView" class="list-group mb-4" style="display: none;">
                <!-- Wird dynamisch gefüllt -->
            </div>
            
            <!-- Produkte List View -->
            <div id="productsListContainer">
                <div id="productsList" class="list-group">
                    <!-- Wird dynamisch gefüllt -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Produkt-Detail-Modal -->
<div class="modal fade" id="productDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">{{ _('inventory.stock.modals.product_details.title') }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="productDetailContent">
                <!-- Wird dynamisch gefüllt -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _('inventory.stock.modals.product_details.close') }}</button>
            </div>
        </div>
    </div>
</div>

<!-- Bulk-Delete-Bestätigungs-Modal -->
<div class="modal fade" id="bulkDeleteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">
                    <i class="bi bi-exclamation-triangle"></i> {{ _('inventory.stock.modals.bulk_delete.title') }}
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle"></i> 
                    <strong>{{ _('inventory.stock.modals.bulk_delete.warning') }}</strong>
                </div>
                <p>{{ _('inventory.stock.modals.bulk_delete.message', count='<strong id="bulkDeleteProductCount">0</strong>')|safe }}</p>
                <p class="text-muted small mb-0">{{ _('inventory.stock.modals.bulk_delete.note') }}</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _('inventory.stock.modals.bulk_delete.cancel') }}</button>
                <button type="button" class="btn btn-danger" id="bulkDeleteConfirmBtn">
                    <i class="bi bi-trash"></i> {{ _('inventory.stock.modals.bulk_delete.confirm') }}
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Bulk-Edit-Modal -->
<div class="modal fade" id="bulkEditModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-pencil"></i> {{ _('inventory.stock.modals.bulk_edit.title') }}
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i> 
                    <strong id="bulkEditProductCount">0</strong> {{ _('inventory.stock.modals.bulk_edit.info', count='0') }}
                </div>
                
                <form id="bulkEditForm">
                    <div class="mb-3">
                        <label for="bulkEditAttribute" class="form-label">{{ _('inventory.stock.modals.bulk_edit.attribute_label') }} <span class="text-danger">*</span></label>
                        <select class="form-select" id="bulkEditAttribute" required>
                            <option value="">{{ _('inventory.stock.modals.bulk_edit.select_attribute') }}</option>
                            <option value="location">{{ _('inventory.stock.modals.bulk_edit.location') }}</option>
                            <option value="length">{{ _('inventory.stock.modals.bulk_edit.length') }}</option>
                            <option value="condition">{{ _('inventory.stock.modals.bulk_edit.condition') }}</option>
                            <option value="category">{{ _('inventory.stock.modals.bulk_edit.category') }}</option>
                            <option value="folder_id">{{ _('inventory.stock.modals.bulk_edit.folder') }}</option>
                            <option value="remove_image">{{ _('inventory.stock.modals.bulk_edit.remove_image') }}</option>
                        </select>
                    </div>
                    
                    <!-- Dynamische Eingabefelder -->
                    <div id="bulkEditFields">
                        <!-- Wird dynamisch gefüllt -->
                    </div>
                    
                    <div class="alert alert-warning mt-3">
                        <i class="bi bi-exclamation-triangle"></i> 
                        {{ _('inventory.stock.modals.bulk_edit.warning') }}
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _('inventory.stock.modals.bulk_edit.cancel') }}</button>
                <button type="button" class="btn btn-primary" id="bulkEditSubmitBtn">
                    <i class="bi bi-check-circle"></i> {{ _('inventory.stock.modals.bulk_edit.update') }}
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/inventory.js') }}"></script>
<script>
// Bestandsübersicht-Initialisierung
document.addEventListener('DOMContentLoaded', function() {
    try {
        if (typeof StockManager === 'undefined') {
            console.error('StockManager ist nicht definiert!');
            document.getElementById('productsContainer').innerHTML = `
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle"></i> 
                    Fehler beim Laden der Bestandsverwaltung. Bitte Seite neu laden.
                </div>
            `;
            return;
        }
        
        window.stockManager = new StockManager();
        if (window.stockManager && typeof window.stockManager.init === 'function') {
            window.stockManager.init().catch(error => {
                console.error('Fehler bei der Initialisierung:', error);
                const container = document.getElementById('productsContainer');
                if (container) {
                    container.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="bi bi-exclamation-triangle"></i> 
                            Fehler beim Laden der Produkte: ${error.message || 'Unbekannter Fehler'}
                        </div>
                    `;
                }
            });
        } else {
            console.error('stockManager oder init() ist nicht verfügbar');
            const container = document.getElementById('productsContainer');
            if (container) {
                container.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle"></i> 
                        Fehler: StockManager konnte nicht initialisiert werden.
                    </div>
                `;
            }
        }
    } catch (error) {
        console.error('Kritischer Fehler:', error);
        document.getElementById('productsContainer').innerHTML = `
            <div class="alert alert-danger">
                <i class="bi bi-exclamation-triangle"></i> 
                Kritischer Fehler: ${error.message}
            </div>
        `;
    }
});

// Favoriten-Funktionen
let favorites = new Set();

async function loadFavorites() {
    try {
        const response = await fetch('/inventory/api/favorites');
        if (response.ok) {
            const data = await response.json();
            favorites = new Set(data.map(p => p.id));
            updateFavoriteButtons();
        }
    } catch (error) {
        console.error('Fehler beim Laden der Favoriten:', error);
    }
}

async function toggleFavorite(productId) {
    try {
        const isFavorite = favorites.has(productId);
        const method = isFavorite ? 'DELETE' : 'POST';
        
        const response = await fetch(`/inventory/api/favorites/${productId}`, {
            method: method,
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        if (response.ok) {
            if (isFavorite) {
                favorites.delete(productId);
            } else {
                favorites.add(productId);
            }
            updateFavoriteButtons();
        }
    } catch (error) {
        console.error('Fehler beim Toggle der Favoriten:', error);
    }
}

function updateFavoriteButtons() {
    document.querySelectorAll('.favorite-btn').forEach(btn => {
        const productId = parseInt(btn.dataset.productId);
        if (favorites.has(productId)) {
            btn.classList.add('active');
            btn.innerHTML = '<i class="bi bi-star-fill"></i>';
        } else {
            btn.classList.remove('active');
            btn.innerHTML = '<i class="bi bi-star"></i>';
        }
    });
}

// Schnellfilter
document.addEventListener('click', function(e) {
    if (e.target.closest('.quick-filter')) {
        const btn = e.target.closest('.quick-filter');
        const filter = btn.dataset.filter;
        
        // Entferne active-Klasse von allen Schnellfilter-Buttons
        document.querySelectorAll('.quick-filter').forEach(b => {
            b.classList.remove('active');
        });
        
        // Füge active-Klasse zum geklickten Button hinzu
        btn.classList.add('active');
        
        if (filter === 'all') {
            // Alle anzeigen - Filter zurücksetzen
            if (window.stockManager) {
                window.stockManager.activeQuickFilter = null;
                document.getElementById('statusFilter').value = '';
                document.getElementById('searchInput').value = '';
                window.stockManager.applyFilters();
                window.stockManager.renderFolders(); // Zeige Ordner wieder an
            }
        } else if (filter === 'favorites') {
            // Nur Favoriten anzeigen
            if (window.stockManager) {
                window.stockManager.activeQuickFilter = 'favorites';
                window.stockManager.filteredProducts = window.stockManager.products.filter(p => favorites.has(p.id));
                window.stockManager.sortFilteredProducts();
                window.stockManager.renderProducts();
            }
        } else if (filter === 'available') {
            if (window.stockManager) {
                window.stockManager.activeQuickFilter = 'available';
                document.getElementById('statusFilter').value = 'available';
                window.stockManager.applyFilters();
            }
        } else if (filter === 'borrowed') {
            if (window.stockManager) {
                window.stockManager.activeQuickFilter = 'borrowed';
                document.getElementById('statusFilter').value = 'borrowed';
                window.stockManager.applyFilters();
            }
        }
    }
    
    if (e.target.closest('.favorite-btn')) {
        const productId = parseInt(e.target.closest('.favorite-btn').dataset.productId);
        toggleFavorite(productId);
    }
});

// Initialisierung
document.addEventListener('DOMContentLoaded', function() {
    loadFavorites();
});
</script>
{% endblock %}

