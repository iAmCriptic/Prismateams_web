<!DOCTYPE html>
{% set _lang_code = (current_language or 'en') %}
{% set _lang_prefix = _lang_code[:2] %}
{% set excalidraw_lang_map = {'de': 'de', 'en': 'en', 'es': 'es', 'pt': 'pt', 'ru': 'ru'} %}
{% set excalidraw_lang = excalidraw_lang_map.get(_lang_prefix, 'en') %}
<html lang="{{ current_language or 'de' }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ canvas.name }} - {{ _('canvas.edit.page_title_suffix', default='Canvas Editor') }}</title>
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }
        
        .excalidraw-editor-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            background: #fff;
        }
    
        .excalidraw-editor-toolbar {
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            padding: 0.5rem 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex-shrink: 0;
            z-index: 1000;
        }
        
        .excalidraw-editor-toolbar button {
            padding: 0.375rem 0.75rem;
            font-size: 0.875rem;
            border: 1px solid #dee2e6;
            background: #fff;
            border-radius: 0.25rem;
            cursor: pointer;
            color: #495057;
        }
        
        .excalidraw-editor-toolbar button:hover {
            background: #e9ecef;
        }
        
        .excalidraw-editor-content {
            flex: 1;
            overflow: hidden;
            position: relative;
        }
        
        #excalidraw-iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
        
        /* Zurück-Button oben rechts */
        .excalidraw-back-button {
            position: absolute;
            top: 0;
            right: 0;
            z-index: 10001;
            background: #000;
            border: none;
            border-bottom: 2px solid {{ current_user.accent_color if current_user.is_authenticated and current_user.accent_color else '#0d6efd' }};
            border-left: 2px solid {{ current_user.accent_color if current_user.is_authenticated and current_user.accent_color else '#0d6efd' }};
            padding: 4px 12px;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            transition: all 0.2s;
            border-radius: 0 0 0 8px;
            height: 27px;
            min-width: 100px;
        }
        
        .excalidraw-back-button:hover {
            background: #1a1a1a;
        }
        
        .excalidraw-back-button:active {
            background: #333;
        }
        
        .excalidraw-back-button .button-text {
            background: {{ current_user.accent_style if current_user.is_authenticated and current_user.accent_style else 'linear-gradient(90deg, #0d6efd, #0dcaf0)' }};
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 500;
        }
        
        .excalidraw-back-button i {
            font-size: 16px;
            color: {{ current_user.accent_color if current_user.is_authenticated and current_user.accent_color else '#0d6efd' }};
        }
        
        .excalidraw-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #6c757d;
            font-size: 0.875rem;
        }
        
        .excalidraw-status .badge {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
        }
        
    </style>
</head>
<body>
<div class="excalidraw-editor-container">
    <button class="excalidraw-back-button" onclick="goBack()" title="{{ _('canvas.edit.back_button_title', default='Zurück zum Teamportal') }}">
        <i class="bi bi-arrow-left"></i>
        <span class="button-text">{{ _('canvas.edit.back_button_label', default='Zurück') }}</span>
    </button>
    
    <div class="excalidraw-editor-content">
        <iframe id="excalidraw-iframe" src="{{ excalidraw_url }}?mode=embed&locale={{ excalidraw_lang }}&roomId={{ room_id }}&roomKey={{ canvas.id }}&canvasData={{ excalidraw_data | tojson | urlencode if excalidraw_data else '' }}"></iframe>
    </div>
</div>

<script>
let saveTimeout = null;
let isSaving = false;

function goBack() {
    // Speichere vor dem Verlassen
    saveCanvas();
    
    // Warte kurz auf Speicherung
    setTimeout(() => {
        window.location.href = '{{ url_for("canvas.index") }}';
    }, 500);
}

function saveCanvas() {
    if (isSaving) return;
    
    isSaving = true;
    
    try {
        // Hole Excalidraw-Daten aus iframe (wenn möglich)
        const iframe = document.getElementById('excalidraw-iframe');
        
        // Versuche Excalidraw-Daten zu bekommen
        // Excalidraw speichert Daten normalerweise automatisch
        // Wir können auch über postMessage kommunizieren
        
        // Für jetzt: Einfache Speicherung über Fetch
        // In Produktion sollte dies über Excalidraw API erfolgen
        
        // Speichere nach kurzer Verzögerung
        if (saveTimeout) {
            clearTimeout(saveTimeout);
        }
        
        saveTimeout = setTimeout(async () => {
            try {
                // Excalidraw lädt/speichert über die URLs die wir bereitstellen
                // Der Excalidraw-Container sollte die Daten automatisch laden/speichern
                console.log('Canvas wird gespeichert...');
            } catch (error) {
                console.error('Fehler beim Speichern:', error);
            } finally {
                isSaving = false;
            }
        }, 1000);
    } catch (error) {
        console.error('Fehler beim Speichern:', error);
        isSaving = false;
    }
}

// Speichere automatisch beim Verlassen
window.addEventListener('beforeunload', function(e) {
    saveCanvas();
});

// Keyboard shortcut: Escape to go back
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        goBack();
    }
});

// Kommunikation mit Excalidraw iframe (wenn nötig)
window.addEventListener('message', function(event) {
    // Nur Nachrichten von Excalidraw akzeptieren
    if (event.origin !== window.location.origin) {
        return;
    }
    
    // Handle Excalidraw messages
    if (event.data && event.data.type === 'excalidraw-save') {
        saveCanvas();
    }
});

// Automatisches Speichern alle 30 Sekunden
setInterval(() => {
    saveCanvas();
}, 30000);

console.log('Excalidraw Canvas Editor geladen');
console.log('Canvas ID:', {{ canvas.id }});
console.log('Room ID:', '{{ room_id }}');
console.log('Document URL:', '{{ document_url }}');
console.log('Save URL:', '{{ save_url }}');
</script>
</body>
</html>
