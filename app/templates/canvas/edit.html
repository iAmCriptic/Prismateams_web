<!DOCTYPE html>
{% set _lang_code = (current_language or 'en') %}
{% set _lang_prefix = _lang_code[:2] %}
{% set excalidraw_lang_map = {'de': 'de', 'en': 'en', 'es': 'es', 'pt': 'pt', 'ru': 'ru'} %}
{% set excalidraw_lang = excalidraw_lang_map.get(_lang_prefix, 'en') %}
<html lang="{{ current_language or 'de' }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ canvas.name }} - {{ _('canvas.edit.page_title_suffix', default='Canvas Editor') }}</title>
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }
        
        .excalidraw-editor-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            background: #fff;
        }
        
        .excalidraw-editor-content {
            flex: 1;
            overflow: hidden;
            position: relative;
        }
        
        #excalidraw-iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
        
        /* Zurück-Button oben links */
        .excalidraw-back-button {
            position: absolute;
            top: 0;
            left: 0;
            z-index: 10001;
            background: #000;
            border: none;
            border-bottom: 2px solid {{ current_user.accent_color if current_user.is_authenticated and current_user.accent_color else '#0d6efd' }};
            border-right: 2px solid {{ current_user.accent_color if current_user.is_authenticated and current_user.accent_color else '#0d6efd' }};
            padding: 4px 12px;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            transition: all 0.2s;
            border-radius: 0 0 8px 0;
            height: 27px;
            min-width: 100px;
        }
        
        .excalidraw-back-button:hover {
            background: #1a1a1a;
        }
        
        .excalidraw-back-button:active {
            background: #333;
        }
        
        .excalidraw-back-button .button-text {
            background: {{ current_user.accent_style if current_user.is_authenticated and current_user.accent_style else 'linear-gradient(90deg, #0d6efd, #0dcaf0)' }};
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 500;
        }
        
        .excalidraw-back-button i {
            font-size: 16px;
            color: {{ current_user.accent_color if current_user.is_authenticated and current_user.accent_color else '#0d6efd' }};
        }
        
    </style>
</head>
<body>
<div class="excalidraw-editor-container">
    <button class="excalidraw-back-button" onclick="goBack()" title="{{ _('canvas.edit.back_button_title', default='Zurück zum Teamportal') }}">
        <i class="bi bi-arrow-left"></i>
        <span class="button-text">{{ _('canvas.edit.back_button_label', default='Zurück') }}</span>
    </button>
    
    <div class="excalidraw-editor-content">
        <iframe id="excalidraw-iframe" allow="clipboard-read; clipboard-write"></iframe>
    </div>
</div>

<script>
const CANVAS_ID = {{ canvas.id }};
const ROOM_ID = '{{ room_id }}';
const LOAD_URL = '{{ document_url }}';
const SAVE_URL = '{{ save_url }}';
const EXCALIDRAW_URL = '{{ excalidraw_url }}';
const ROOM_URL = '{{ room_url }}';
const EXCALIDRAW_LANG = '{{ excalidraw_lang }}';

let activeUsers = new Set();
let saveTimeout = null;
let isSaving = false;
let hasChanges = false;
let iframeWindow = null;

// Baue die Excalidraw-URL mit allen Parametern
function buildExcalidrawURL() {
    // Validiere EXCALIDRAW_URL
    if (!EXCALIDRAW_URL || EXCALIDRAW_URL.trim() === '') {
        console.error('EXCALIDRAW_URL ist nicht definiert');
        return '';
    }
    
    // Stelle sicher, dass die URL mit / beginnt, wenn sie relativ ist
    let baseUrl = EXCALIDRAW_URL;
    if (!baseUrl.startsWith('http://') && !baseUrl.startsWith('https://') && !baseUrl.startsWith('/')) {
        baseUrl = '/' + baseUrl;
    }
    
    const params = new URLSearchParams();
    
    // Modus: embed
    params.append('mode', 'embed');
    
    // Sprache
    if (EXCALIDRAW_LANG) {
        params.append('locale', EXCALIDRAW_LANG);
    }
    
    // Room-Integration für Kollaboration
    if (ROOM_ID && ROOM_URL) {
        // Stelle sicher, dass ROOM_URL absolut ist oder mit / beginnt
        let roomUrl = ROOM_URL;
        if (!roomUrl.startsWith('http://') && !roomUrl.startsWith('https://') && !roomUrl.startsWith('/')) {
            roomUrl = '/' + roomUrl;
        }
        
        params.append('roomId', ROOM_ID);
        params.append('roomKey', String(CANVAS_ID));
        params.append('roomServerUrl', roomUrl);
    }
    
    // Benutzer-Informationen
    params.append('username', encodeURIComponent('{{ current_user.full_name }}'));
    params.append('userId', String('{{ current_user.id }}'));
    
    // Füge Load- und Save-URLs hinzu
    if (LOAD_URL) {
        params.append('loadUrl', LOAD_URL);
    }
    if (SAVE_URL) {
        params.append('saveUrl', SAVE_URL);
    }
    
    const queryString = params.toString();
    return queryString ? `${baseUrl}?${queryString}` : baseUrl;
}

// Lade Excalidraw im Iframe
function loadExcalidraw() {
    const iframe = document.getElementById('excalidraw-iframe');
    const url = buildExcalidrawURL();
    
    console.log('Lade Excalidraw:', url);
    
    // Validiere URL
    if (!url || url.trim() === '') {
        console.error('Excalidraw URL ist leer oder ungültig');
        showError('Excalidraw URL ist nicht konfiguriert. Bitte überprüfen Sie die Einstellungen.');
        return;
    }
    
    // Fehlerbehandlung für Iframe-Laden
    iframe.addEventListener('error', function(e) {
        console.error('Fehler beim Laden des Excalidraw-Iframes:', e);
        showError('Excalidraw konnte nicht geladen werden. Bitte überprüfen Sie, ob Excalidraw erreichbar ist.');
    });
    
    // Timeout für Iframe-Laden
    const loadTimeout = setTimeout(() => {
        try {
            // Prüfe, ob Iframe geladen wurde
            if (!iframe.contentWindow || !iframe.contentDocument) {
                console.warn('Excalidraw Iframe lädt länger als erwartet...');
            }
        } catch (error) {
            // CORS-Fehler sind normal bei Cross-Origin Iframes
            console.log('CORS-Prüfung (normal bei Cross-Origin):', error.message);
        }
    }, 5000);
    
    iframe.src = url;
    
    // Warte auf das Laden des Iframes
    iframe.addEventListener('load', function() {
        clearTimeout(loadTimeout);
        try {
            iframeWindow = iframe.contentWindow;
            console.log('Excalidraw geladen');
            
            // Warte kurz, dann lade die initialen Daten
            setTimeout(() => {
                loadAndSendInitialData();
            }, 1000);
        } catch (error) {
            // CORS-Fehler sind normal bei Cross-Origin Iframes
            console.log('CORS-Prüfung beim Zugriff auf Iframe (normal bei Cross-Origin):', error.message);
            
            // Versuche trotzdem, die Daten zu laden
            setTimeout(() => {
                loadAndSendInitialData();
            }, 1000);
        }
    });
}

// Zeige Fehlermeldung an
function showError(message) {
    const container = document.querySelector('.excalidraw-editor-container');
    if (container) {
        const errorDiv = document.createElement('div');
        errorDiv.className = 'alert alert-danger';
        errorDiv.style.cssText = 'position: absolute; top: 40px; left: 50%; transform: translateX(-50%); z-index: 10002; max-width: 600px;';
        errorDiv.innerHTML = `
            <i class="bi bi-exclamation-triangle"></i> <strong>Fehler:</strong> ${message}
            <br><small>Bitte überprüfen Sie die Excalidraw-Konfiguration in den Einstellungen.</small>
        `;
        container.appendChild(errorDiv);
        
        // Entferne Fehlermeldung nach 10 Sekunden
        setTimeout(() => {
            if (errorDiv.parentNode) {
                errorDiv.parentNode.removeChild(errorDiv);
            }
        }, 10000);
    }
}

// Lade initiale Daten und sende sie an Excalidraw
async function loadAndSendInitialData() {
    try {
        const response = await fetch(LOAD_URL, {
            method: 'GET',
            credentials: 'include',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        if (response.ok) {
            const data = await response.json();
            // Wenn Daten vorhanden sind, sende sie an Excalidraw über postMessage
            if (data && iframeWindow) {
                try {
                    // Versuche, Daten an Excalidraw zu senden
                    iframeWindow.postMessage({
                        type: 'excalidraw-load',
                        data: data
                    }, '*');
                } catch (error) {
                    console.error('Fehler beim Senden der Daten an Excalidraw:', error);
                }
            }
        }
    } catch (error) {
        console.error('Fehler beim Laden der initialen Daten:', error);
    }
}

// Speichere Canvas-Daten
async function saveCanvasData(data, force = false) {
    if (isSaving && !force) return;
    
    isSaving = true;
    
    try {
        const response = await fetch(SAVE_URL, {
            method: 'POST',
            credentials: 'include',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        });
        
        if (response.ok) {
            const result = await response.json();
            hasChanges = false;
            console.log('Canvas erfolgreich gespeichert');
            return true;
        } else {
            console.error('Fehler beim Speichern:', response.status);
            return false;
        }
    } catch (error) {
        console.error('Fehler beim Speichern:', error);
        return false;
    } finally {
        isSaving = false;
    }
}

// Debounced save
function debouncedSave(data) {
    if (saveTimeout) {
        clearTimeout(saveTimeout);
    }
    
    hasChanges = true;
    
    saveTimeout = setTimeout(() => {
        saveCanvasData(data);
    }, 2000); // 2 Sekunden Verzögerung
}

function goBack() {
    // Speichere vor dem Verlassen, wenn Änderungen vorhanden
    if (hasChanges) {
        // Force save vor dem Verlassen
        if (saveTimeout) {
            clearTimeout(saveTimeout);
            // Warte auf Speicherung
            setTimeout(() => {
                window.location.href = '{{ url_for("canvas.index") }}';
            }, 500);
        } else {
            window.location.href = '{{ url_for("canvas.index") }}';
        }
    } else {
        window.location.href = '{{ url_for("canvas.index") }}';
    }
}

// Überwache Änderungen von Excalidraw über postMessage
window.addEventListener('message', function(event) {
    // Akzeptiere Nachrichten von Excalidraw (kann von verschiedenen Origins kommen)
    // Prüfe, ob die Nachricht von unserem Iframe kommt
    try {
        const iframe = document.getElementById('excalidraw-iframe');
        if (event.source !== iframe.contentWindow) {
            // Prüfe, ob es eine Excalidraw-Nachricht ist
            if (!event.data || typeof event.data !== 'object' || !event.data.type) {
                return;
            }
        }
    } catch (error) {
        // CORS-Fehler sind normal bei Cross-Origin Iframes
        // Prüfe trotzdem, ob es eine Excalidraw-Nachricht ist
        if (!event.data || typeof event.data !== 'object' || !event.data.type) {
            return;
        }
    }
    
    // Behandle Excalidraw-Nachrichten
    if (event.data && typeof event.data === 'object') {
        // Verschiedene Excalidraw-Nachrichtentypen
        if (event.data.type === 'excalidraw-change' || 
            event.data.type === 'excalidraw-update' || 
            event.data.type === 'excalidraw-export' ||
            event.data.type === 'excalidraw-save') {
            const data = event.data.data || event.data;
            if (data && (data.elements || data.appState)) {
                hasChanges = true;
                debouncedSave(data);
            }
        }
    }
});

// Automatisches Speichern beim Verlassen (wenn letzter Nutzer)
let isUnloading = false;

window.addEventListener('beforeunload', function(e) {
    isUnloading = true;
    
    if (hasChanges) {
        // Versuche, finales Speichern durchzuführen
        if (saveTimeout) {
            clearTimeout(saveTimeout);
        }
        
        // Versuche, die aktuellen Daten vom Iframe zu bekommen und zu speichern
        try {
            if (iframeWindow) {
                // Sende Request an Excalidraw, um aktuelle Daten zu erhalten
                iframeWindow.postMessage({
                    type: 'excalidraw-request-export'
                }, '*');
                
                // Warte kurz auf Antwort, dann speichere
                setTimeout(() => {
                    // Fallback: Speichere auch ohne Antwort, wenn wir Änderungen haben
                    // Dies wird durch den unload-Event-Handler gemacht
                }, 100);
            }
        } catch (error) {
            console.error('Fehler beim Request der finalen Daten:', error);
        }
    }
});

window.addEventListener('unload', function(e) {
    if (hasChanges && activeUsers.size <= 1) {
        // Versuche, finales Speichern durchzuführen
        // Nutze sendBeacon für synchrones Speichern beim Verlassen
        try {
            // Versuche, die aktuellen Daten zu bekommen
            // Da wir die Daten vom Iframe nicht direkt bekommen können,
            // müssen wir auf Excalidraw's eigene Save-Funktionalität vertrauen
            // oder die zuletzt gespeicherten Daten verwenden
            
            // Sende Signal an Excalidraw zum Speichern
            if (iframeWindow) {
                iframeWindow.postMessage({
                    type: 'excalidraw-force-save'
                }, '*');
            }
        } catch (error) {
            console.error('Fehler beim finalen Speichern:', error);
        }
    }
});

// Keyboard shortcut: Escape to go back
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && !e.target.closest('.excalidraw-container')) {
        goBack();
    }
});

// Initialisiere nach dem Laden
window.addEventListener('DOMContentLoaded', function() {
    loadExcalidraw();
    
    // Füge aktuellen Benutzer zu aktiven Benutzern hinzu
    activeUsers.add('{{ current_user.id }}');
    
    console.log('Excalidraw Canvas Editor geladen');
    console.log('Canvas ID:', CANVAS_ID);
    console.log('Room ID:', ROOM_ID);
    console.log('Load URL:', LOAD_URL);
    console.log('Save URL:', SAVE_URL);
    console.log('Room URL:', ROOM_URL);
});

// Tracke Benutzer-Verbindungen
// Versuche, aktive Benutzer über Room-Server oder WebSocket zu tracken
// Für jetzt: Vereinfachtes Tracking über Focus/Blur

const currentUserId = '{{ current_user.id }}';

window.addEventListener('focus', function() {
    activeUsers.add(currentUserId);
    console.log('Benutzer aktiv:', currentUserId, 'Aktive Benutzer:', activeUsers.size);
});

window.addEventListener('blur', function() {
    // Entferne Benutzer nach kurzer Verzögerung (nur wenn nicht unload)
    if (!isUnloading) {
        setTimeout(() => {
            activeUsers.delete(currentUserId);
            console.log('Benutzer inaktiv:', currentUserId, 'Aktive Benutzer:', activeUsers.size);
        }, 5000);
    }
});

// Initialisiere Benutzer
activeUsers.add(currentUserId);

// Sende regelmäßige Heartbeats, um zu zeigen, dass der Benutzer aktiv ist
setInterval(() => {
    if (!isUnloading) {
        activeUsers.add(currentUserId);
    }
}, 30000); // Alle 30 Sekunden
</script>
</body>
</html>
