{% extends "base.html" %}

{% block title %}{{ get_chat_display_name(chat) }} - {{ _('chat.view.page_title_suffix') }}{% endblock %}

{% block content %}
<!-- Desktop Header -->
<div class="desktop-chat-header d-none d-md-flex">
    <div class="desktop-chat-info">
        <nav aria-label="breadcrumb" class="mb-2">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{{ url_for('chat.index') }}"><i class="bi bi-arrow-left me-1"></i>{{ _('chat.view.breadcrumb_chats') }}</a></li>
                <li class="breadcrumb-item active">{{ get_chat_display_name(chat) }}</li>
            </ol>
        </nav>
        
        <div class="desktop-chat-title-section">
            <div class="chat-avatar-section">
                {% if chat.is_main_chat %}
                    {% if portal_logo_filename %}
                    <img src="{{ url_for('settings.portal_logo', filename=portal_logo_filename) }}" 
                         class="chat-avatar" 
                         alt="{{ _('chat.view.team_logo_alt') }}">
                    {% else %}
                    <img src="{{ url_for('static', filename='img/logo.png') }}" 
                         class="chat-avatar" 
                         alt="{{ _('chat.view.team_logo_alt') }}">
                    {% endif %}
                {% elif chat.is_direct_message %}
                    {% set other_user = get_other_chat_user(chat) %}
                    {% if other_user and other_user.profile_picture %}
                    <img src="{{ url_for('settings.profile_picture', filename=other_user.profile_picture) }}" 
                         class="chat-avatar rounded-circle" 
                         alt="{{ get_chat_display_name(chat) }}">
                    {% elif other_user %}
                    <div class="chat-avatar chat-avatar-initial rounded-circle">
                        {{ other_user.full_name[0].upper() }}
                    </div>
                    {% else %}
                    <div class="chat-avatar chat-avatar-group">
                        <i class="bi bi-person-circle"></i>
                    </div>
                    {% endif %}
                {% else %}
                    {% if chat.group_avatar %}
                    <img src="{{ url_for('chat.serve_media', filename='avatars/' + chat.group_avatar) }}" 
                         class="chat-avatar rounded-circle" 
                         alt="{{ chat.name }}">
                    {% else %}
                    <div class="chat-avatar chat-avatar-group">
                        <i class="bi bi-people-fill"></i>
                    </div>
                    {% endif %}
                {% endif %}
            </div>
            
            <div class="chat-title-info">
                <h2 class="chat-title">{{ get_chat_display_name(chat) }}</h2>
                <div class="chat-members-info">
                    <span class="member-count">{{ _('chat.view.member_count').format(count=members|length) }}</span>
                    <div class="member-avatars">
                        {% for member in members[:4] %}
                        <div class="member-avatar clickable-member" 
                             title="{{ member.full_name }}"
                             data-member-id="{{ member.id }}"
                             data-member-name="{{ member.full_name }}"
                             data-member-email="{{ member.email }}"
                             data-member-phone="{{ member.phone or '' }}"
                             data-member-picture="{{ member.profile_picture or '' }}"
                             onclick="showMemberModal(this)">
                            {% if member.profile_picture %}
                                <img src="{{ url_for('settings.profile_picture', filename=member.profile_picture) }}" 
                                     alt="{{ member.full_name }}" 
                                     class="rounded-circle">
                            {% else %}
                                <div class="member-avatar-initial">{{ member.full_name[0].upper() }}</div>
                            {% endif %}
                        </div>
                        {% endfor %}
                        {% if members|length > 4 %}
                        <div class="member-avatar member-avatar-more clickable-member" 
                             title="{{ _('chat.view.member_more') }}"
                             onclick="showAllMembersModal()">
                            +{{ members|length - 4 }}
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="desktop-chat-actions">
        <div class="dropdown">
            <button class="btn btn-outline-secondary btn-sm" data-bs-toggle="dropdown">
                <i class="bi bi-three-dots-vertical"></i>
            </button>
            <ul class="dropdown-menu dropdown-menu-end">
                <li><a class="dropdown-item" href="#" onclick="toggleNotifications()">
                    <i class="bi bi-bell me-2" id="notification-icon"></i>
                    <span id="notification-text">{{ _('chat.view.dropdown.mute') }}</span>
                </a></li>
                <li><a class="dropdown-item" href="#" onclick="showChatInfoModal(); return false;"><i class="bi bi-info-circle me-2"></i>{{ _('chat.view.dropdown.info') }}</a></li>
                {% if not chat.is_main_chat and not chat.is_direct_message %}
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item" href="{{ url_for('chat.chat_settings', chat_id=chat.id) }}"><i class="bi bi-gear me-2"></i>{{ _('chat.view.dropdown.settings') }}</a></li>
                {% endif %}
                {% if not chat.is_main_chat %}
                <li><a class="dropdown-item text-danger" href="#" onclick="deleteChat({{ chat.id }}); return false;"><i class="bi bi-trash me-2"></i>Chat löschen</a></li>
                {% endif %}
            </ul>
        </div>
    </div>
</div>

<!-- Mobile Header - New Design -->
<div class="mobile-chat-header d-md-none">
    <a href="{{ url_for('chat.index') }}" class="btn btn-link text-white p-1 me-2">
        <i class="bi bi-arrow-left fs-4"></i>
    </a>
    
    <!-- Chat Info -->
    <div class="d-flex align-items-center flex-grow-1">
        {% if chat.is_main_chat %}
            {% if portal_logo_filename %}
            <img src="{{ url_for('settings.portal_logo', filename=portal_logo_filename) }}" 
                 class="rounded-circle me-2" 
                 style="width: 32px; height: 32px; object-fit: cover;" 
                 alt="{{ _('chat.view.team_logo_alt') }}">
            {% else %}
            <img src="{{ url_for('static', filename='img/logo.png') }}" 
                 class="rounded-circle me-2" 
                 style="width: 32px; height: 32px; object-fit: cover;" 
                 alt="{{ _('chat.view.team_logo_alt') }}">
            {% endif %}
        {% elif chat.is_direct_message %}
            {% set other_user = get_other_chat_user(chat) %}
            {% if other_user and other_user.profile_picture %}
            <img src="{{ url_for('settings.profile_picture', filename=other_user.profile_picture) }}" 
                 class="rounded-circle me-2" 
                 style="width: 32px; height: 32px; object-fit: cover;" 
                 alt="{{ get_chat_display_name(chat) }}">
            {% elif other_user %}
            <div class="rounded-circle bg-white bg-opacity-20 d-flex align-items-center justify-content-center me-2" 
                 style="width: 32px; height: 32px;">
                <span class="text-white fw-bold">{{ other_user.full_name[0].upper() }}</span>
            </div>
            {% else %}
            <div class="rounded-circle bg-white bg-opacity-20 d-flex align-items-center justify-content-center me-2" 
                 style="width: 32px; height: 32px;">
                <i class="bi bi-person-circle text-white fs-6"></i>
            </div>
            {% endif %}
        {% else %}
            {% if chat.group_avatar %}
            <img src="{{ url_for('chat.serve_media', filename='avatars/' + chat.group_avatar) }}" 
                 class="rounded-circle me-2" 
                 style="width: 32px; height: 32px; object-fit: cover;" 
                 alt="{{ chat.name }}">
            {% else %}
            <div class="rounded-circle bg-white bg-opacity-20 d-flex align-items-center justify-content-center me-2" 
                 style="width: 32px; height: 32px;">
                <i class="bi bi-people-fill text-white fs-6"></i>
            </div>
            {% endif %}
        {% endif %}
        
        <div>
            <h6 class="mb-0 fw-bold text-white">{{ get_chat_display_name(chat) }}</h6>
            <small class="text-white-50">{{ _('chat.view.member_count').format(count=members|length) }}</small>
        </div>
    </div>
    
    <!-- Actions -->
    <div class="dropdown">
        <button class="btn btn-link text-white p-1" data-bs-toggle="dropdown">
            <i class="bi bi-three-dots-vertical fs-5"></i>
        </button>
        <ul class="dropdown-menu dropdown-menu-end">
            <li><a class="dropdown-item" href="#" onclick="toggleNotifications()">
                <i class="bi bi-bell me-2" id="notification-icon-mobile"></i>
                <span id="notification-text-mobile">{{ _('chat.view.dropdown.mute') }}</span>
            </a></li>
            <li><a class="dropdown-item" href="#" onclick="showChatInfoModal(); return false;">
                <i class="bi bi-info-circle me-2"></i>
                <span>{{ _('chat.view.dropdown.info') }}</span>
            </a></li>
            <li><a class="dropdown-item" href="#" onclick="showAllMembersModal()">
                <i class="bi bi-people me-2"></i>
                <span>{{ _('chat.view.mobile_members') }}</span>
            </a></li>
            {% if not chat.is_main_chat and not chat.is_direct_message %}
            <li><hr class="dropdown-divider"></li>
            <li><a class="dropdown-item" href="{{ url_for('chat.chat_settings', chat_id=chat.id) }}">
                <i class="bi bi-gear me-2"></i>
                <span>{{ _('chat.view.dropdown.settings') }}</span>
            </a></li>
            {% endif %}
            {% if not chat.is_main_chat %}
            <li><hr class="dropdown-divider"></li>
            <li><a class="dropdown-item text-danger" href="#" onclick="deleteChat({{ chat.id }}); return false;">
                <i class="bi bi-trash me-2"></i>
                <span>Chat löschen</span>
            </a></li>
            {% endif %}
        </ul>
    </div>
</div>

<!-- Messages Container -->
<div class="chat-container">
    <div class="desktop-chat-sidebar d-none d-md-block">
        <div class="sidebar-header">
            <h6 class="sidebar-title">{{ _('chat.view.members_title') }}</h6>
        </div>
        <div class="sidebar-members">
            {% for member in members %}
            <div class="sidebar-member clickable-member" 
                 data-member-id="{{ member.id }}"
                 data-member-name="{{ member.full_name }}"
                 data-member-email="{{ member.email }}"
                 data-member-phone="{{ member.phone or '' }}"
                 data-member-picture="{{ member.profile_picture or '' }}"
                 onclick="showMemberModal(this)">
                <div class="member-info">
                    {% if member.profile_picture %}
                        <img src="{{ url_for('settings.profile_picture', filename=member.profile_picture) }}" 
                             alt="{{ member.full_name }}" 
                             class="member-avatar-small">
                    {% else %}
                        <div class="member-avatar-small member-avatar-initial">{{ member.full_name[0].upper() }}</div>
                    {% endif %}
                    <div class="member-details">
                        <span class="member-name">{{ member.full_name }}</span>
                        <small class="member-role text-muted">
                            {% if member.id == chat.created_by %}
                                {{ _('chat.view.member_role_admin') }}
                            {% else %}
                                {{ _('chat.view.member_role_member') }}
                            {% endif %}
                        </small>
                    </div>
                </div>
                <div class="member-status">
                    <span class="status-indicator {% if member.is_online() %}online{% else %}offline{% endif %}"></span>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    
    <div class="messages-area" id="messages-container" style="display: flex; flex-direction: column; min-height: 200px;">
        {% if messages %}
            {% for message in messages %}
            <div class="chat-message {% if message.sender_id == current_user.id %}own{% else %}other{% endif %}">
                {% if message.message_type == 'text' %}
                    <div class="message-header">
                        <strong>{% if message.sender_id == current_user.id %}{{ _('chat.view.message.you') }}{% else %}{{ message.sender.full_name if message.sender else _('chat.view.message.unknown_user') }}{% endif %}</strong>
                    </div>
                    <div class="message-content">
                        {{ message.content }}
                    </div>
                    <div class="message-time">
                        <small class="text-muted" style="font-size: 0.7rem; opacity: 0.7;">
                            {{ message.created_at | smart_datetime }}
                        </small>
                    </div>
                {% elif message.message_type == 'image' %}
                    <div class="message-header">
                        <strong>{% if message.sender_id == current_user.id %}{{ _('chat.view.message.you') }}{% else %}{{ message.sender.full_name if message.sender else _('chat.view.message.unknown_user') }}{% endif %}</strong>
                    </div>
                    <img src="{{ url_for('chat.serve_media', filename=message.media_url) }}" class="img-fluid rounded" style="max-width: 300px;">
                    {% if message.content %}
                    <p class="mt-2 mb-0">{{ message.content }}</p>
                    {% endif %}
                    <div class="message-time">
                        <small class="text-muted" style="font-size: 0.7rem; opacity: 0.7;">
                            {{ message.created_at | smart_datetime }}
                        </small>
                    </div>
                {% elif message.message_type == 'video' %}
                    <div class="message-header">
                        <strong>{% if message.sender_id == current_user.id %}{{ _('chat.view.message.you') }}{% else %}{{ message.sender.full_name if message.sender else _('chat.view.message.unknown_user') }}{% endif %}</strong>
                    </div>
                    <video controls class="rounded" style="max-width: 300px;">
                        <source src="{{ url_for('chat.serve_media', filename=message.media_url) }}">
                    </video>
                    {% if message.content %}
                    <p class="mt-2 mb-0">{{ message.content }}</p>
                    {% endif %}
                    <div class="message-time">
                        <small class="text-muted" style="font-size: 0.7rem; opacity: 0.7;">
                            {{ message.created_at | smart_datetime }}
                        </small>
                    </div>
                {% elif message.message_type == 'voice' %}
                    <div class="message-header">
                        <strong>{% if message.sender_id == current_user.id %}{{ _('chat.view.message.you') }}{% else %}{{ message.sender.full_name if message.sender else _('chat.view.message.unknown_user') }}{% endif %}</strong>
                    </div>
                    <audio controls>
                        <source src="{{ url_for('chat.serve_media', filename=message.media_url) }}">
                    </audio>
                    {% if message.content %}
                    <p class="mt-2 mb-0">{{ message.content }}</p>
                    {% endif %}
                    <div class="message-time">
                        <small class="text-muted" style="font-size: 0.7rem; opacity: 0.7;">
                            {{ message.created_at | smart_datetime }}
                        </small>
                    </div>
                {% endif %}
            </div>
            {% endfor %}
        {% else %}
            <div style="flex: 1; display: flex; align-items: center; justify-content: center; color: #6c757d; padding: 2rem;">
                <div style="text-align: center;">
                    <i class="bi bi-chat-dots" style="font-size: 3rem; opacity: 0.5; margin-bottom: 1rem;"></i>
                    <p style="margin: 0;">{{ _('chat.view.no_messages.title') }}</p>
                    <p style="margin: 0.5rem 0 0 0; font-size: 0.9rem;">{{ _('chat.view.no_messages.hint') }}</p>
                </div>
            </div>
        {% endif %}
    </div>
</div>

<!-- Mobile Message Input - New Design -->
<div class="chat-input-container d-md-none">
    <form id="message-form" method="POST" action="{{ url_for('chat.send_message', chat_id=1 if chat.is_main_chat else chat.id) }}" enctype="multipart/form-data">
        <div class="mobile-input-group">
            <button class="btn" type="button" onclick="document.getElementById('file-upload').click()" title="{{ _('chat.view.input.attach') }}">
                <i class="bi bi-paperclip"></i>
            </button>
            <button class="btn" type="button" data-request-microphone onclick="startVoiceRecording()" title="{{ _('chat.view.input.voice') }}">
                <i class="bi bi-mic" id="mic-icon"></i>
            </button>
            <input type="file" id="file-upload" name="file" class="d-none" accept="image/*,video/*,audio/*">
            <input type="text" id="message-input" class="form-control" name="content" 
                   placeholder="{{ _('chat.view.input.placeholder') }}" autocomplete="off">
            <button class="btn" type="submit" id="send-button" title="{{ _('chat.view.input.send') }}">
                <i class="bi bi-send-fill"></i>
            </button>
        </div>
        <div class="file-info mt-2" id="file-info" style="display: none;">
            <small class="text-muted" id="file-name"></small>
        </div>
    </form>
</div>

<!-- Desktop Message Input -->
<div class="chat-input-container d-none d-md-block">
    <form id="message-form-desktop" method="POST" action="{{ url_for('chat.send_message', chat_id=1 if chat.is_main_chat else chat.id) }}" enctype="multipart/form-data">
        <div class="input-group">
            <button class="btn btn-outline-secondary" type="button" onclick="document.getElementById('file-upload-desktop').click()" title="{{ _('chat.view.input.attach') }}">
                <i class="bi bi-paperclip"></i>
            </button>
            <button class="btn btn-outline-secondary" type="button" data-request-microphone onclick="startVoiceRecording()" title="{{ _('chat.view.input.voice') }}">
                <i class="bi bi-mic" id="mic-icon-desktop"></i>
            </button>
            <input type="file" id="file-upload-desktop" name="file" class="d-none" accept="image/*,video/*,audio/*">
            <input type="text" id="message-input-desktop" class="form-control" name="content" placeholder="{{ _('chat.view.input.placeholder') }}" autocomplete="off">
            <button class="btn btn-accent" type="submit" id="send-button-desktop" title="{{ _('chat.view.input.send') }}">
                <i class="bi bi-send"></i>
            </button>
        </div>
        <small class="text-muted" id="file-name-desktop"></small>
    </form>
</div>
{% endblock %}

{% block extra_js %}
{% set chat_view_js = current_translations.get('chat', {}).get('view', {}).get('js', {}) %}
<script>
    const chatId = {{ 1 if chat.is_main_chat else chat.id }};
    const currentUserId = {{ current_user.id }};
    let lastMessageId = {{ messages[-1].id if messages else 0 }};
    let isPolling = true;
    let currentMemberCount = {{ members|length }};
    let isSendingMessage = false; // Flag to prevent duplicate message sending
    const CHAT_I18N = {{ chat_view_js|tojson }};
    const CHAT_TEXT = {
        you: "{{ _('chat.view.message.you') }}",
        unknownUser: "{{ _('chat.view.message.unknown_user') }}",
        memberCount: "{{ _('chat.view.member_count') }}",
        memberMore: "{{ _('chat.view.member_more') }}",
        memberRoleAdmin: "{{ _('chat.view.member_role_admin') }}",
        memberRoleMember: "{{ _('chat.view.member_role_member') }}"
    };
    
    // Auto-scroll to bottom
    function scrollToBottom() {
        const container = document.getElementById('messages-container');
        if (container) {
            // Use requestAnimationFrame to ensure DOM is updated
            requestAnimationFrame(() => {
                container.scrollTop = container.scrollHeight;
                // Double-check after a short delay to ensure it scrolled
                setTimeout(() => {
                    container.scrollTop = container.scrollHeight;
                }, 50);
            });
        }
    }
    
    // Initial scroll
    setTimeout(scrollToBottom, 100);
    
    // Show selected file name
    document.getElementById('file-upload').addEventListener('change', function(e) {
        const fileName = e.target.files[0]?.name;
        document.getElementById('file-name').textContent = fileName ? CHAT_I18N.file_label.replace('{filename}', fileName) : '';
    });
    
    // Send message via AJAX
    document.getElementById('message-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        // Prevent duplicate submissions
        if (isSendingMessage) {
            return;
        }
        
        const formData = new FormData(this);
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        
        if (!messageInput.value.trim() && !formData.get('file').name) {
            return;
        }
        
        // Set flag to prevent duplicate submissions
        isSendingMessage = true;
        
        // Disable send button
        sendButton.disabled = true;
        sendButton.innerHTML = '<i class="bi bi-hourglass-split"></i>';
        
        try {
            const response = await fetch(`/chat/${chatId}/send`, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            });
            
            if (response.ok) {
                const data = await response.json();
                addMessageToChat(data);
                messageInput.value = '';
                document.getElementById('file-upload').value = '';
                document.getElementById('file-name').textContent = '';
                lastMessageId = data.id;
                scrollToBottom();
            } else {
                const error = await response.json();
                alert(CHAT_I18N.send_error_prefix.replace('{error}', error.error || ''));
            }
        } catch (error) {
            console.error('Error:', error);
            alert(CHAT_I18N.send_error_generic);
        } finally {
            // Re-enable send button and reset flag
            isSendingMessage = false;
            sendButton.disabled = false;
            sendButton.innerHTML = '<i class="bi bi-send"></i>';
        }
    });
    
    // Add new message to chat
    function formatTime(value) {
        const messageDate = new Date(value);
        const now = new Date();
        const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        const msgDate = new Date(messageDate.getFullYear(), messageDate.getMonth(), messageDate.getDate());
        
        const diffTime = today - msgDate;
        const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
        
        const localeMap = { de: 'de-DE', en: 'en-US' };
        const currentLocale = "{{ current_language }}";
        const locale = localeMap[currentLocale] || currentLocale || 'en-US';
        
        if (diffDays === 0) {
            // Today: show only time
            return messageDate.toLocaleTimeString(locale, {
                hour: '2-digit',
                minute: '2-digit'
            });
        } else if (diffDays === 1) {
            // Yesterday: show "Gestern HH:MM"
            const timeStr = messageDate.toLocaleTimeString(locale, {
                hour: '2-digit',
                minute: '2-digit'
            });
            return `Gestern ${timeStr}`;
        } else {
            // Older: show date and time
            return messageDate.toLocaleString(locale, {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
    }

    function addMessageToChat(message) {
        const container = document.getElementById('messages-container');
        const messageDiv = document.createElement('div');
        messageDiv.className = `chat-message ${parseInt(message.sender_id) === parseInt(currentUserId) ? 'own' : 'other'}`;
        
        // Parse the ISO string which should now be in local timezone
        const time = formatTime(message.created_at);
        const isOwnMessage = parseInt(message.sender_id) === parseInt(currentUserId);
        const senderName = isOwnMessage ? CHAT_TEXT.you : (message.sender ? escapeHtml(message.sender) : CHAT_TEXT.unknownUser);
        
        let contentHtml = '';
        if (message.message_type === 'text') {
            contentHtml = `
                <div class="message-header">
                    <strong>${senderName}</strong>
                </div>
                <div class="message-content">
                    ${escapeHtml(message.content)}
                </div>
                <div class="message-time">
                    <small class="text-muted" style="font-size: 0.7rem; opacity: 0.7;">
                        ${time}
                    </small>
                </div>
            `;
        } else if (message.message_type === 'image') {
            const mediaUrl = `/chat/media/${encodeURIComponent(message.media_url)}`;
            contentHtml = `
                <div class="message-header">
                    <strong>${senderName}</strong>
                </div>
                <img src="${mediaUrl}" class="img-fluid rounded" style="max-width: 300px;">
                ${message.content ? `<p class="mt-2 mb-0">${escapeHtml(message.content)}</p>` : ''}
                <div class="message-time">
                    <small class="text-muted" style="font-size: 0.7rem; opacity: 0.7;">
                        ${time}
                    </small>
                </div>
            `;
        } else if (message.message_type === 'video') {
            const mediaUrl = `/chat/media/${encodeURIComponent(message.media_url)}`;
            contentHtml = `
                <div class="message-header">
                    <strong>${senderName}</strong>
                </div>
                <video controls class="rounded" style="max-width: 300px;"><source src="${mediaUrl}"></video>
                ${message.content ? `<p class="mt-2 mb-0">${escapeHtml(message.content)}</p>` : ''}
                <div class="message-time">
                    <small class="text-muted" style="font-size: 0.7rem; opacity: 0.7;">
                        ${time}
                    </small>
                </div>
            `;
        } else if (message.message_type === 'voice') {
            const mediaUrl = `/chat/media/${encodeURIComponent(message.media_url)}`;
            contentHtml = `
                <div class="message-header">
                    <strong>${senderName}</strong>
                </div>
                <audio controls><source src="${mediaUrl}"></audio>
                ${message.content ? `<p class="mt-2 mb-0">${escapeHtml(message.content)}</p>` : ''}
                <div class="message-time">
                    <small class="text-muted" style="font-size: 0.7rem; opacity: 0.7;">
                        ${time}
                    </small>
                </div>
            `;
        }
        
        messageDiv.innerHTML = contentHtml;
        
        container.appendChild(messageDiv);
    }
    
    // Escape HTML to prevent XSS
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    // Update members list
    async function updateMembersList() {
        try {
            const response = await fetch(`/api/chats/${chatId}/members`, {
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            });
            
            if (response.ok) {
                const members = await response.json();
                
                // Update member count if it changed
                if (members.length !== currentMemberCount) {
                    currentMemberCount = members.length;
                    
                    // Update member count in header
                    const memberCountElements = document.querySelectorAll('.member-count');
                    memberCountElements.forEach(el => {
                        el.textContent = CHAT_TEXT.memberCount.replace('{count}', members.length);
                    });
                    
                    // Update desktop sidebar
                    updateDesktopSidebar(members);
                    
                    // Update mobile member avatars
                    updateMobileMemberAvatars(members);
                    
                    // Update all members modal
                    updateAllMembersModal(members);
                }
            }
        } catch (error) {
            console.error('Error updating members:', error);
        }
    }
    
    // Update desktop sidebar members
    function updateDesktopSidebar(members) {
        const sidebar = document.querySelector('.sidebar-members');
        if (!sidebar) return;
        
        sidebar.innerHTML = members.map(member => {
            const avatarHtml = member.profile_picture 
                ? `<img src="${escapeHtml(member.profile_picture)}" alt="${escapeHtml(member.full_name)}" class="member-avatar-small">`
                : `<div class="member-avatar-small member-avatar-initial">${escapeHtml(member.full_name[0].toUpperCase())}</div>`;
            
            const role = member.is_creator ? CHAT_TEXT.memberRoleAdmin : CHAT_TEXT.memberRoleMember;
            
            const statusClass = member.is_online ? 'online' : 'offline';
            return `
                <div class="sidebar-member clickable-member" 
                     data-member-id="${member.id}"
                     data-member-name="${escapeHtml(member.full_name)}"
                     data-member-email="${escapeHtml(member.email)}"
                     data-member-phone="${escapeHtml(member.phone || '')}"
                     data-member-picture="${escapeHtml(member.profile_picture || '')}"
                     onclick="showMemberModal(this)">
                    <div class="member-info">
                        ${avatarHtml}
                        <div class="member-details">
                            <span class="member-name">${escapeHtml(member.full_name)}</span>
                            <small class="member-role text-muted">${role}</small>
                        </div>
                    </div>
                    <div class="member-status">
                        <span class="status-indicator ${statusClass}"></span>
                    </div>
                </div>
            `;
        }).join('');
    }
    
    // Update mobile member avatars in header
    function updateMobileMemberAvatars(members) {
        const memberAvatars = document.querySelector('.member-avatars');
        if (!memberAvatars) return;
        
        memberAvatars.innerHTML = members.slice(0, 4).map(member => {
            const avatarHtml = member.profile_picture
                ? `<img src="${escapeHtml(member.profile_picture)}" alt="${escapeHtml(member.full_name)}" class="rounded-circle">`
                : `<div class="member-avatar-initial">${escapeHtml(member.full_name[0].toUpperCase())}</div>`;
            
            return `
                <div class="member-avatar clickable-member" 
                     title="${escapeHtml(member.full_name)}"
                     data-member-id="${member.id}"
                     data-member-name="${escapeHtml(member.full_name)}"
                     data-member-email="${escapeHtml(member.email)}"
                     data-member-phone="${escapeHtml(member.phone || '')}"
                     data-member-picture="${escapeHtml(member.profile_picture || '')}"
                     onclick="showMemberModal(this)">
                    ${avatarHtml}
                </div>
            `;
        }).join('') + (members.length > 4 ? `
            <div class="member-avatar member-avatar-more clickable-member" 
                 title="${CHAT_TEXT.memberMore}"
                 onclick="showAllMembersModal()">
                +${members.length - 4}
            </div>
        ` : '');
    }
    
    // Update all members modal
    function updateAllMembersModal(members) {
        const membersGrid = document.querySelector('.members-grid');
        if (!membersGrid) return;
        
        membersGrid.innerHTML = members.map(member => {
            const avatarHtml = member.profile_picture
                ? `<img src="${escapeHtml(member.profile_picture)}" alt="${escapeHtml(member.full_name)}" class="rounded-circle">`
                : `<div class="member-avatar-initial">${escapeHtml(member.full_name[0].toUpperCase())}</div>`;
            
            return `
                <div class="member-card clickable-member" 
                     data-member-id="${member.id}"
                     data-member-name="${escapeHtml(member.full_name)}"
                     data-member-email="${escapeHtml(member.email)}"
                     data-member-phone="${escapeHtml(member.phone || '')}"
                     data-member-picture="${escapeHtml(member.profile_picture || '')}"
                     onclick="showMemberModal(this)">
                    <div class="member-card-avatar">
                        ${avatarHtml}
                    </div>
                    <div class="member-card-info">
                        <h6 class="member-card-name">${escapeHtml(member.full_name)}</h6>
                        <small class="member-card-email">${escapeHtml(member.email)}</small>
                        ${member.phone ? `<small class="member-card-phone text-muted d-block">${escapeHtml(member.phone)}</small>` : ''}
                    </div>
                    <div class="member-card-arrow">
                        <i class="bi bi-chevron-right"></i>
                    </div>
                </div>
            `;
        }).join('');
    }
    
    // Poll for new messages
    async function pollForNewMessages() {
        if (!isPolling) return;
        
        try {
            const response = await fetch(`/api/chats/${chatId}/messages?since=${lastMessageId}`, {
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            });
            
            if (response.ok) {
                const messages = await response.json();
                if (messages.length > 0) {
                    messages.forEach(message => {
                        if (message.id > lastMessageId) {
                            addMessageToChat(message);
                            lastMessageId = message.id;
                        }
                    });
                    scrollToBottom();
                }
            }
        } catch (error) {
            console.error('Error polling messages:', error);
        }
        
        // Poll again after 2 seconds
        setTimeout(pollForNewMessages, 2000);
    }
    
    // Poll for member updates
    async function pollForMembers() {
        if (!isPolling) return;
        
        await updateMembersList();
        
        // Poll again after 5 seconds
        setTimeout(pollForMembers, 5000);
    }
    
    // Update last_seen periodically
    async function updateLastSeen() {
        if (!isPolling) return;
        
        try {
            await fetch('/api/users/update-last-seen', {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            });
        } catch (error) {
            console.error('Error updating last_seen:', error);
        }
        
        // Update every 2 minutes
        setTimeout(updateLastSeen, 120000);
    }
    
    // Start polling when page loads
    pollForNewMessages();
    pollForMembers();
    updateLastSeen();
    
    // Stop polling when page is hidden
    document.addEventListener('visibilitychange', function() {
        isPolling = !document.hidden;
        if (isPolling) {
            pollForNewMessages();
            pollForMembers();
            updateLastSeen();
        }
    });
    
    // Send message on Enter key
    document.getElementById('message-input').addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            // Only trigger submit if not already sending
            if (!isSendingMessage) {
                document.getElementById('message-form').dispatchEvent(new Event('submit'));
            }
        }
    });
    
    // Desktop form handling
    document.getElementById('message-input-desktop').addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            // Only trigger submit if not already sending
            if (!isSendingMessage) {
                document.getElementById('message-form-desktop').dispatchEvent(new Event('submit'));
            }
        }
    });
    
    // Desktop file upload handling
    document.getElementById('file-upload-desktop').addEventListener('change', function(e) {
        const fileName = e.target.files[0]?.name;
        document.getElementById('file-name-desktop').textContent = fileName ? CHAT_I18N.file_label.replace('{filename}', fileName) : '';
    });
    
    // Desktop form submission
    document.getElementById('message-form-desktop').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        // Prevent duplicate submissions
        if (isSendingMessage) {
            return;
        }
        
        const formData = new FormData(this);
        const messageInput = document.getElementById('message-input-desktop');
        const sendButton = document.getElementById('send-button-desktop');
        
        if (!messageInput.value.trim() && !formData.get('file').name) {
            return;
        }
        
        // Set flag to prevent duplicate submissions
        isSendingMessage = true;
        
        // Disable send button
        sendButton.disabled = true;
        sendButton.innerHTML = '<i class="bi bi-hourglass-split"></i>';
        
        try {
            const response = await fetch(`/chat/${chatId}/send`, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            });
            
            if (response.ok) {
                const data = await response.json();
                addMessageToChat(data);
                messageInput.value = '';
                document.getElementById('file-upload-desktop').value = '';
                document.getElementById('file-name-desktop').textContent = '';
                lastMessageId = data.id;
                scrollToBottom();
            } else {
                const error = await response.json();
                alert(CHAT_I18N.send_error_prefix.replace('{error}', error.error || ''));
            }
        } catch (error) {
            console.error('Error:', error);
            alert(CHAT_I18N.send_error_generic);
        } finally {
            // Re-enable send button and reset flag
            isSendingMessage = false;
            sendButton.disabled = false;
            sendButton.innerHTML = '<i class="bi bi-send"></i>';
        }
    });
    
    // Notification toggle functionality
    let notificationsMuted = false;
    function toggleNotifications() {
        notificationsMuted = !notificationsMuted;
        const icon = document.getElementById('notification-icon');
        const text = document.getElementById('notification-text');
        const iconMobile = document.getElementById('notification-icon-mobile');
        const textMobile = document.getElementById('notification-text-mobile');
        
        if (notificationsMuted) {
            if (icon) icon.className = 'bi bi-bell-slash me-2';
            if (text) text.textContent = CHAT_I18N.unmute;
            if (iconMobile) iconMobile.className = 'bi bi-bell-slash me-2';
            if (textMobile) textMobile.textContent = CHAT_I18N.unmute;
        } else {
            if (icon) icon.className = 'bi bi-bell me-2';
            if (text) text.textContent = CHAT_I18N.mute;
            if (iconMobile) iconMobile.className = 'bi bi-bell me-2';
            if (textMobile) textMobile.textContent = CHAT_I18N.mute;
        }
        
        // Store preference in localStorage
        localStorage.setItem(`chat_${chatId}_notifications_muted`, notificationsMuted);
    }
    
    // Load notification preference
    const savedMuteState = localStorage.getItem(`chat_${chatId}_notifications_muted`);
    if (savedMuteState === 'true') {
        toggleNotifications();
    }
    
    // Voice recording functionality
    let mediaRecorder;
    let audioChunks = [];
    
    async function startVoiceRecording() {
        const micIcon = document.getElementById('mic-icon');
        const micIconDesktop = document.getElementById('mic-icon-desktop');
        
        if (mediaRecorder && mediaRecorder.state === 'recording') {
            // Stop recording
            mediaRecorder.stop();
            micIcon.className = 'bi bi-mic fs-5';
            if (micIconDesktop) micIconDesktop.className = 'bi bi-mic';
            return;
        }
        
        try {
            // Prüfe Mikrofon-Berechtigung
            if (typeof permissionManager !== 'undefined') {
                const hasPermission = await permissionManager.requestMicrophonePermission();
                if (!hasPermission) {
                    return;
                }
            }
            
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            
            // Determine the best MIME type for audio recording
            let mimeType = 'audio/webm';
            if (MediaRecorder.isTypeSupported('audio/webm;codecs=opus')) {
                mimeType = 'audio/webm;codecs=opus';
            } else if (MediaRecorder.isTypeSupported('audio/ogg;codecs=opus')) {
                mimeType = 'audio/ogg;codecs=opus';
            } else if (MediaRecorder.isTypeSupported('audio/webm')) {
                mimeType = 'audio/webm';
            } else if (MediaRecorder.isTypeSupported('audio/ogg')) {
                mimeType = 'audio/ogg';
            }
            
            mediaRecorder = new MediaRecorder(stream, { mimeType: mimeType });
            audioChunks = [];
            
            mediaRecorder.ondataavailable = function(event) {
                if (event.data.size > 0) {
                    audioChunks.push(event.data);
                }
            };
            
            mediaRecorder.onstop = function() {
                const audioBlob = new Blob(audioChunks, { type: mimeType });
                sendVoiceMessage(audioBlob, mimeType);
                stream.getTracks().forEach(track => track.stop());
            };
            
            mediaRecorder.start();
            micIcon.className = 'bi bi-stop-circle fs-5 text-danger';
            if (micIconDesktop) micIconDesktop.className = 'bi bi-stop-circle text-danger';
            
        } catch (error) {
            console.error('Error accessing microphone:', error);
            
            // Zeige benutzerfreundliche Fehlermeldung
            if (typeof permissionManager !== 'undefined') {
                permissionManager.showPermissionInfo(CHAT_I18N.permission_title, CHAT_I18N.permission_message);
            } else {
                alert(CHAT_I18N.microphone_denied);
            }
        }
    }
    
    async function sendVoiceMessage(audioBlob, mimeType) {
        // Prevent duplicate submissions
        if (isSendingMessage) {
            return;
        }
        
        // Determine file extension based on MIME type
        let extension = 'webm';
        if (mimeType.includes('ogg')) {
            extension = 'ogg';
        } else if (mimeType.includes('wav')) {
            extension = 'wav';
        } else if (mimeType.includes('m4a')) {
            extension = 'm4a';
        }
        
        const formData = new FormData();
        formData.append('file', audioBlob, `voice_message.${extension}`);
        formData.append('content', '');
        
        // Set flag to prevent duplicate submissions
        isSendingMessage = true;
        
        try {
            const response = await fetch(`/chat/${chatId}/send`, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            });
            
            if (response.ok) {
                const data = await response.json();
                addMessageToChat(data);
                lastMessageId = data.id;
                scrollToBottom();
            } else {
                const error = await response.json();
                alert(CHAT_I18N.send_error_prefix.replace('{error}', error.error || CHAT_I18N.voice_error));
            }
        } catch (error) {
            console.error('Error sending voice message:', error);
            alert(CHAT_I18N.voice_error);
        } finally {
            // Reset flag
            isSendingMessage = false;
        }
    }
</script>

<!-- Member Profile Modal -->
<div class="modal fade" id="memberModal" tabindex="-1" aria-labelledby="memberModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="memberModalLabel">{{ _('chat.view.modals.member_profile.title') }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{{ _('chat.view.modals.member_profile.close') }}"></button>
            </div>
            <div class="modal-body">
                <div class="member-profile">
                    <div class="member-profile-avatar">
                        <img id="modal-member-avatar" src="" alt="" class="rounded-circle">
                        <div id="modal-member-initial" class="member-avatar-initial-large" style="display: none;"></div>
                    </div>
                    <div class="member-profile-info">
                        <h4 id="modal-member-name" class="member-name-large"></h4>
                        <div class="member-contact-info">
                            <div class="contact-item" id="modal-member-email-container">
                                <i class="bi bi-envelope me-2"></i>
                                <span id="modal-member-email"></span>
                            </div>
                            <div class="contact-item" id="modal-member-phone-container" style="display: none;">
                                <i class="bi bi-telephone me-2"></i>
                                <span id="modal-member-phone"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _('chat.view.modals.member_profile.close') }}</button>
            </div>
        </div>
    </div>
</div>

<!-- All Members Modal -->
<div class="modal fade" id="allMembersModal" tabindex="-1" aria-labelledby="allMembersModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="allMembersModalLabel">
                    <i class="bi bi-people me-2"></i>
                    {{ _('chat.view.modals.all_members.title') }}
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{{ _('chat.view.modals.all_members.close') }}"></button>
            </div>
            <div class="modal-body">
                <div class="members-grid">
                    {% for member in members %}
                    <div class="member-card clickable-member" 
                         data-member-id="{{ member.id }}"
                         data-member-name="{{ member.full_name }}"
                         data-member-email="{{ member.email }}"
                         data-member-phone="{{ member.phone or '' }}"
                         data-member-picture="{{ member.profile_picture or '' }}"
                         onclick="showMemberModal(this)">
                        <div class="member-card-avatar">
                            {% if member.profile_picture %}
                                <img src="{{ url_for('settings.profile_picture', filename=member.profile_picture) }}" 
                                     alt="{{ member.full_name }}" 
                                     class="rounded-circle">
                            {% else %}
                                <div class="member-avatar-initial">{{ member.full_name[0].upper() }}</div>
                            {% endif %}
                        </div>
                        <div class="member-card-info">
                            <h6 class="member-card-name">{{ member.full_name }}</h6>
                            <small class="member-card-email">{{ member.email }}</small>
                            {% if member.phone %}
                            <small class="member-card-phone text-muted d-block">{{ member.phone }}</small>
                            {% endif %}
                        </div>
                        <div class="member-card-arrow">
                            <i class="bi bi-chevron-right"></i>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _('chat.view.modals.all_members.close') }}</button>
            </div>
        </div>
    </div>
</div>

<script>
// Member Modal Functions
function showMemberModal(element) {
    const memberId = element.getAttribute('data-member-id');
    const memberName = element.getAttribute('data-member-name');
    const memberEmail = element.getAttribute('data-member-email');
    const memberPhone = element.getAttribute('data-member-phone');
    const memberPicture = element.getAttribute('data-member-picture');
    
    // Set modal content
    document.getElementById('modal-member-name').textContent = memberName;
    document.getElementById('modal-member-email').textContent = memberEmail;
    
    // Handle profile picture
    const avatarImg = document.getElementById('modal-member-avatar');
    const avatarInitial = document.getElementById('modal-member-initial');
    
    if (memberPicture) {
        // Verwende die richtige Route zum Ausliefern der Profilbilder
        avatarImg.src = "{{ url_for('settings.profile_picture', filename='__FILENAME__') }}".replace('__FILENAME__', encodeURIComponent(memberPicture));
        avatarImg.style.display = 'block';
        avatarInitial.style.display = 'none';
    } else {
        avatarImg.style.display = 'none';
        avatarInitial.style.display = 'flex';
        avatarInitial.textContent = memberName[0].toUpperCase();
    }
    
    // Handle phone number
    const phoneContainer = document.getElementById('modal-member-phone-container');
    if (memberPhone && memberPhone.trim() !== '') {
        document.getElementById('modal-member-phone').textContent = memberPhone;
        phoneContainer.style.display = 'block';
    } else {
        phoneContainer.style.display = 'none';
    }
    
    // Close all members modal if it's open
    const allMembersModalElement = document.getElementById('allMembersModal');
    if (allMembersModalElement) {
        const allMembersModal = bootstrap.Modal.getInstance(allMembersModalElement);
        if (allMembersModal) {
            allMembersModal.hide();
            // Wait for the modal to close before opening the member modal
            allMembersModalElement.addEventListener('hidden.bs.modal', function showMemberModalAfterClose() {
                const memberModal = new bootstrap.Modal(document.getElementById('memberModal'));
                memberModal.show();
                // Remove event listener to avoid memory leaks
                allMembersModalElement.removeEventListener('hidden.bs.modal', showMemberModalAfterClose);
            }, { once: true });
            return;
        }
    }
    
    // Show modal (if all members modal wasn't open)
    const modal = new bootstrap.Modal(document.getElementById('memberModal'));
    modal.show();
}

function showAllMembersModal() {
    const modal = new bootstrap.Modal(document.getElementById('allMembersModal'));
    modal.show();
}

function showChatInfoModal() {
    const modal = new bootstrap.Modal(document.getElementById('chatInfoModal'));
    modal.show();
}

async function deleteChat(chatId) {
    if (!confirm('Möchten Sie diesen Chat wirklich löschen? Diese Aktion kann nicht rückgängig gemacht werden.')) {
        return;
    }
    
    try {
        const response = await fetch(`/chat/${chatId}/delete`, {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        });
        
        if (response.ok) {
            const data = await response.json();
            if (data.success) {
                window.location.href = '/chat/';
            }
        } else {
            const error = await response.json();
            alert('Fehler beim Löschen: ' + (error.error || 'Unbekannter Fehler'));
        }
    } catch (error) {
        console.error('Error deleting chat:', error);
        alert('Fehler beim Löschen des Chats');
    }
}
</script>

<!-- Chat Info Modal -->
<div class="modal fade" id="chatInfoModal" tabindex="-1" aria-labelledby="chatInfoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="chatInfoModalLabel">
                    <i class="bi bi-info-circle me-2"></i>
                    Chat-Informationen
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Schließen"></button>
            </div>
            <div class="modal-body">
                <div class="chat-info">
                    <div class="chat-info-avatar mb-3 text-center">
                        {% if chat.is_main_chat %}
                            {% if portal_logo_filename %}
                            <img src="{{ url_for('settings.portal_logo', filename=portal_logo_filename) }}" 
                                 alt="Team Logo" 
                                 class="rounded-circle" 
                                 style="width: 80px; height: 80px; object-fit: cover;">
                            {% else %}
                            <img src="{{ url_for('static', filename='img/logo.png') }}" 
                                 alt="Team Logo" 
                                 class="rounded-circle" 
                                 style="width: 80px; height: 80px; object-fit: cover;">
                            {% endif %}
                        {% elif chat.group_avatar %}
                            {% set avatar_path = 'avatars/' + chat.group_avatar %}
                            <img src="{{ url_for('chat.serve_media', filename=avatar_path) }}" 
                                 alt="Chat Avatar" 
                                 class="rounded-circle" 
                                 style="width: 80px; height: 80px; object-fit: cover;">
                        {% else %}
                            <div class="rounded-circle bg-primary d-flex align-items-center justify-content-center mx-auto" 
                                 style="width: 80px; height: 80px;">
                                <i class="bi bi-people-fill text-white fs-1"></i>
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="chat-info-details">
                        <h4 class="text-center mb-3">{{ get_chat_display_name(chat) }}</h4>
                        
                        {% if chat.description %}
                        <div class="mb-3">
                            <strong>Beschreibung:</strong>
                            <p class="mb-0">{{ chat.description }}</p>
                        </div>
                        {% endif %}
                        
                        <div class="mb-3">
                            <strong>Mitglieder:</strong>
                            <p class="mb-0">{{ members|length }} Mitglieder</p>
                        </div>
                        
                        <div class="mb-3">
                            <strong>Erstellt am:</strong>
                            <p class="mb-0">{{ chat.created_at | localdatetime }}</p>
                        </div>
                        
                        {% if chat.created_by %}
                        <div class="mb-3">
                            <strong>Erstellt von:</strong>
                            <p class="mb-0">
                                {% set creator = members|selectattr('id', 'equalto', chat.created_by)|first %}
                                {% if creator %}
                                    {{ creator.full_name }}
                                {% else %}
                                    Unbekannt
                                {% endif %}
                            </p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Schließen</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}



