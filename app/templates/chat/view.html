{% extends "base.html" %}

{% block title %}{{ chat.name }} - Chats{% endblock %}

{% block content %}
<!-- Desktop Header -->
<div class="row mb-3 d-none d-md-flex">
    <div class="col">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{{ url_for('chat.index') }}">Chats</a></li>
                <li class="breadcrumb-item active">{{ chat.name }}</li>
            </ol>
        </nav>
        <h2>{{ chat.name }}</h2>
        <p class="text-muted">{{ members|length }} Mitglieder</p>
    </div>
</div>

<!-- Mobile Header -->
<div class="mobile-chat-header d-md-none">
    <div class="d-flex align-items-center">
        <a href="{{ url_for('chat.index') }}" class="btn btn-link p-2 me-2">
            <i class="bi bi-arrow-left fs-4"></i>
        </a>
        
        <!-- Group Avatar -->
        <div class="me-3">
            {% if chat.group_avatar %}
                <img src="{{ url_for('static', filename='../' + chat.group_avatar) }}" 
                     class="rounded-circle" 
                     style="width: 40px; height: 40px; object-fit: cover;" 
                     alt="Gruppenbild">
            {% else %}
                <div class="rounded-circle bg-primary d-flex align-items-center justify-content-center" 
                     style="width: 40px; height: 40px;">
                    <i class="bi bi-people-fill text-white fs-5"></i>
                </div>
            {% endif %}
        </div>
        
        <div class="flex-grow-1">
            <h5 class="mb-0 fw-bold">{{ chat.name }}</h5>
            <small class="text-muted">{{ members|length }} Mitglieder</small>
        </div>
        
        <div class="dropdown">
            <button class="btn btn-link p-2" data-bs-toggle="dropdown">
                <i class="bi bi-three-dots-vertical fs-5"></i>
            </button>
            <ul class="dropdown-menu dropdown-menu-end">
                <li><a class="dropdown-item" href="#" onclick="toggleNotifications()">
                    <i class="bi bi-bell" id="notification-icon"></i>
                    <span id="notification-text">Benachrichtigungen stummschalten</span>
                </a></li>
                <li><a class="dropdown-item" href="#"><i class="bi bi-info-circle me-2"></i>Chat-Info</a></li>
                <li><a class="dropdown-item" href="#"><i class="bi bi-gear me-2"></i>Einstellungen</a></li>
            </ul>
        </div>
    </div>
</div>

<!-- Messages Container -->
<div class="chat-container">
    <div class="messages-area" id="messages-container">
        {% for message in messages %}
        <div class="chat-message {% if message.sender_id == current_user.id %}own{% else %}other{% endif %}">
            {% if message.message_type == 'text' %}
                <div class="message-header">
                    <strong>{% if message.sender_id == current_user.id %}Du{% else %}{{ message.sender.full_name }}{% endif %}</strong>
                </div>
                <div class="message-content">
                    {{ message.content }}
                </div>
                <div class="message-time">
                    <small class="text-muted" style="font-size: 0.7rem; opacity: 0.7;">
                        {{ message.created_at | localtime('%H:%M') }}
                    </small>
                </div>
            {% elif message.message_type == 'image' %}
                <img src="{{ url_for('static', filename='../' + message.media_url) }}" class="img-fluid rounded" style="max-width: 300px;">
                {% if message.content %}
                <p class="mt-2 mb-0">{{ message.content }}</p>
                {% endif %}
            {% elif message.message_type == 'video' %}
                <video controls class="rounded" style="max-width: 300px;">
                    <source src="{{ url_for('static', filename='../' + message.media_url) }}">
                </video>
                {% if message.content %}
                <p class="mt-2 mb-0">{{ message.content }}</p>
                {% endif %}
            {% elif message.message_type == 'voice' %}
                <audio controls>
                    <source src="{{ url_for('static', filename='../' + message.media_url) }}">
                </audio>
                {% if message.content %}
                <p class="mt-2 mb-0">{{ message.content }}</p>
                {% endif %}
            {% endif %}
        </div>
        {% endfor %}
    </div>
</div>

<!-- Message Input -->
<div class="chat-input-container d-md-none">
    <form id="message-form" method="POST" action="{{ url_for('chat.send_message', chat_id=chat.id) }}" enctype="multipart/form-data">
        <div class="input-group mobile-input-group">
            <button class="btn btn-link p-2" type="button" onclick="document.getElementById('file-upload').click()">
                <i class="bi bi-paperclip fs-5"></i>
            </button>
            <button class="btn btn-link p-2" type="button" onclick="startVoiceRecording()">
                <i class="bi bi-mic fs-5" id="mic-icon"></i>
            </button>
            <input type="file" id="file-upload" name="file" class="d-none" accept="image/*,video/*,audio/*">
            <input type="text" id="message-input" class="form-control border-0" name="content" 
                   placeholder="Nachricht schreiben..." autocomplete="off" style="background: transparent;">
            <button class="btn btn-link p-2" type="submit" id="send-button">
                <i class="bi bi-send-fill fs-5 text-primary"></i>
            </button>
        </div>
        <div class="file-info" id="file-info" style="display: none;">
            <small class="text-muted" id="file-name"></small>
        </div>
    </form>
</div>

<!-- Desktop Message Input -->
<div class="chat-input-container d-none d-md-block">
    <form id="message-form-desktop" method="POST" action="{{ url_for('chat.send_message', chat_id=chat.id) }}" enctype="multipart/form-data">
        <div class="input-group">
            <button class="btn btn-outline-secondary" type="button" onclick="document.getElementById('file-upload-desktop').click()">
                <i class="bi bi-paperclip"></i>
            </button>
            <input type="file" id="file-upload-desktop" name="file" class="d-none" accept="image/*,video/*,audio/*">
            <input type="text" id="message-input-desktop" class="form-control" name="content" placeholder="Nachricht schreiben..." autocomplete="off">
            <button class="btn btn-accent" type="submit" id="send-button-desktop">
                <i class="bi bi-send"></i>
            </button>
        </div>
        <small class="text-muted" id="file-name-desktop"></small>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const chatId = {{ chat.id }};
    const currentUserId = {{ current_user.id }};
    let lastMessageId = {{ messages[-1].id if messages else 0 }};
    let isPolling = true;
    
    // Auto-scroll to bottom
    function scrollToBottom() {
        const container = document.getElementById('messages-container');
        container.scrollTop = container.scrollHeight;
    }
    
    // Initial scroll
    scrollToBottom();
    
    // Show selected file name
    document.getElementById('file-upload').addEventListener('change', function(e) {
        const fileName = e.target.files[0]?.name;
        document.getElementById('file-name').textContent = fileName ? `Datei: ${fileName}` : '';
    });
    
    // Send message via AJAX
    document.getElementById('message-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        
        if (!messageInput.value.trim() && !formData.get('file').name) {
            return;
        }
        
        // Disable send button
        sendButton.disabled = true;
        sendButton.innerHTML = '<i class="bi bi-hourglass-split"></i>';
        
        try {
            const response = await fetch(`/chat/${chatId}/send`, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            });
            
            if (response.ok) {
                const data = await response.json();
                addMessageToChat(data);
                messageInput.value = '';
                document.getElementById('file-upload').value = '';
                document.getElementById('file-name').textContent = '';
                lastMessageId = data.id;
                scrollToBottom();
            } else {
                const error = await response.json();
                alert('Fehler beim Senden: ' + error.error);
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Fehler beim Senden der Nachricht');
        } finally {
            // Re-enable send button
            sendButton.disabled = false;
            sendButton.innerHTML = '<i class="bi bi-send"></i>';
        }
    });
    
    // Add new message to chat
    function addMessageToChat(message) {
        const container = document.getElementById('messages-container');
        const messageDiv = document.createElement('div');
        messageDiv.className = `chat-message ${parseInt(message.sender_id) === parseInt(currentUserId) ? 'own' : 'other'}`;
        
        // Parse the ISO string which should now be in local timezone
        const time = new Date(message.created_at).toLocaleTimeString('de-DE', {
            hour: '2-digit',
            minute: '2-digit'
        });
        
        let contentHtml = '';
        if (message.message_type === 'text') {
            contentHtml = `
                <div class="message-header">
                    <strong>${parseInt(message.sender_id) === parseInt(currentUserId) ? 'Du' : escapeHtml(message.sender)}</strong>
                </div>
                <div class="message-content">
                    ${escapeHtml(message.content)}
                </div>
                <div class="message-time">
                    <small class="text-muted" style="font-size: 0.7rem; opacity: 0.7;">
                        ${time}
                    </small>
                </div>
            `;
        } else if (message.message_type === 'image') {
            contentHtml = `
                <img src="/static/../${message.media_url}" class="img-fluid rounded" style="max-width: 300px;">
                ${message.content ? `<p class="mt-2 mb-0">${escapeHtml(message.content)}</p>` : ''}
                <div class="message-time">
                    <small class="text-muted" style="font-size: 0.7rem; opacity: 0.7;">
                        ${time}
                    </small>
                </div>
            `;
        } else if (message.message_type === 'video') {
            contentHtml = `
                <video controls class="rounded" style="max-width: 300px;"><source src="/static/../${message.media_url}"></video>
                ${message.content ? `<p class="mt-2 mb-0">${escapeHtml(message.content)}</p>` : ''}
                <div class="message-time">
                    <small class="text-muted" style="font-size: 0.7rem; opacity: 0.7;">
                        ${time}
                    </small>
                </div>
            `;
        } else if (message.message_type === 'voice') {
            contentHtml = `
                <audio controls><source src="/static/../${message.media_url}"></audio>
                ${message.content ? `<p class="mt-2 mb-0">${escapeHtml(message.content)}</p>` : ''}
                <div class="message-time">
                    <small class="text-muted" style="font-size: 0.7rem; opacity: 0.7;">
                        ${time}
                    </small>
                </div>
            `;
        }
        
        messageDiv.innerHTML = contentHtml;
        
        container.appendChild(messageDiv);
    }
    
    // Escape HTML to prevent XSS
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    // Poll for new messages
    async function pollForNewMessages() {
        if (!isPolling) return;
        
        try {
            const response = await fetch(`/api/chats/${chatId}/messages?since=${lastMessageId}`, {
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            });
            
            if (response.ok) {
                const messages = await response.json();
                if (messages.length > 0) {
                    messages.forEach(message => {
                        if (message.id > lastMessageId) {
                            addMessageToChat(message);
                            lastMessageId = message.id;
                        }
                    });
                    scrollToBottom();
                }
            }
        } catch (error) {
            console.error('Error polling messages:', error);
        }
        
        // Poll again after 2 seconds
        setTimeout(pollForNewMessages, 2000);
    }
    
    // Start polling when page loads
    pollForNewMessages();
    
    // Stop polling when page is hidden
    document.addEventListener('visibilitychange', function() {
        isPolling = !document.hidden;
        if (isPolling) {
            pollForNewMessages();
        }
    });
    
    // Send message on Enter key
    document.getElementById('message-input').addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            document.getElementById('message-form').dispatchEvent(new Event('submit'));
        }
    });
    
    // Desktop form handling
    document.getElementById('message-input-desktop').addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            document.getElementById('message-form-desktop').dispatchEvent(new Event('submit'));
        }
    });
    
    // Desktop file upload handling
    document.getElementById('file-upload-desktop').addEventListener('change', function(e) {
        const fileName = e.target.files[0]?.name;
        document.getElementById('file-name-desktop').textContent = fileName ? `Datei: ${fileName}` : '';
    });
    
    // Desktop form submission
    document.getElementById('message-form-desktop').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        const messageInput = document.getElementById('message-input-desktop');
        const sendButton = document.getElementById('send-button-desktop');
        
        if (!messageInput.value.trim() && !formData.get('file').name) {
            return;
        }
        
        // Disable send button
        sendButton.disabled = true;
        sendButton.innerHTML = '<i class="bi bi-hourglass-split"></i>';
        
        try {
            const response = await fetch(`/chat/${chatId}/send`, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            });
            
            if (response.ok) {
                const data = await response.json();
                addMessageToChat(data);
                messageInput.value = '';
                document.getElementById('file-upload-desktop').value = '';
                document.getElementById('file-name-desktop').textContent = '';
                lastMessageId = data.id;
                scrollToBottom();
            } else {
                const error = await response.json();
                alert('Fehler beim Senden: ' + error.error);
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Fehler beim Senden der Nachricht');
        } finally {
            // Re-enable send button
            sendButton.disabled = false;
            sendButton.innerHTML = '<i class="bi bi-send"></i>';
        }
    });
    
    // Notification toggle functionality
    let notificationsMuted = false;
    function toggleNotifications() {
        notificationsMuted = !notificationsMuted;
        const icon = document.getElementById('notification-icon');
        const text = document.getElementById('notification-text');
        
        if (notificationsMuted) {
            icon.className = 'bi bi-bell-slash';
            text.textContent = 'Benachrichtigungen aktivieren';
        } else {
            icon.className = 'bi bi-bell';
            text.textContent = 'Benachrichtigungen stummschalten';
        }
        
        // Store preference in localStorage
        localStorage.setItem(`chat_${chatId}_notifications_muted`, notificationsMuted);
    }
    
    // Load notification preference
    const savedMuteState = localStorage.getItem(`chat_${chatId}_notifications_muted`);
    if (savedMuteState === 'true') {
        toggleNotifications();
    }
    
    // Voice recording functionality
    let mediaRecorder;
    let audioChunks = [];
    
    async function startVoiceRecording() {
        const micIcon = document.getElementById('mic-icon');
        
        if (mediaRecorder && mediaRecorder.state === 'recording') {
            // Stop recording
            mediaRecorder.stop();
            micIcon.className = 'bi bi-mic fs-5';
            return;
        }
        
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);
            audioChunks = [];
            
            mediaRecorder.ondataavailable = function(event) {
                audioChunks.push(event.data);
            };
            
            mediaRecorder.onstop = function() {
                const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                sendVoiceMessage(audioBlob);
                stream.getTracks().forEach(track => track.stop());
            };
            
            mediaRecorder.start();
            micIcon.className = 'bi bi-stop-circle fs-5 text-danger';
            
        } catch (error) {
            console.error('Error accessing microphone:', error);
            alert('Mikrofonzugriff wurde verweigert');
        }
    }
    
    async function sendVoiceMessage(audioBlob) {
        const formData = new FormData();
        formData.append('file', audioBlob, 'voice_message.wav');
        formData.append('content', '');
        
        try {
            const response = await fetch(`/chat/${chatId}/send`, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            });
            
            if (response.ok) {
                const data = await response.json();
                addMessageToChat(data);
                lastMessageId = data.id;
                scrollToBottom();
            }
        } catch (error) {
            console.error('Error sending voice message:', error);
            alert('Fehler beim Senden der Sprachnachricht');
        }
    }
</script>
{% endblock %}



