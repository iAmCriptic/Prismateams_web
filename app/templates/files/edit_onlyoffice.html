<!DOCTYPE html>
{% set _lang_code = (current_language or 'en') %}
{% set _lang_prefix = _lang_code[:2] %}
{% set onlyoffice_lang_map = {'de': 'de', 'en': 'en', 'es': 'es', 'pt': 'pt', 'ru': 'ru'} %}
{% set onlyoffice_lang = onlyoffice_lang_map.get(_lang_prefix, 'en') %}
<html lang="{{ current_language or 'de' }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ file.name }} - {{ _('files.onlyoffice.page_title_suffix') }}</title>
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }
        
        .onlyoffice-editor-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            background: #fff;
        }
    
        .onlyoffice-editor-toolbar {
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            padding: 0.5rem 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex-shrink: 0;
            z-index: 1000;
        }
        
        .onlyoffice-editor-toolbar button {
            padding: 0.375rem 0.75rem;
            font-size: 0.875rem;
            border: 1px solid #dee2e6;
            background: #fff;
            border-radius: 0.25rem;
            cursor: pointer;
            color: #495057;
        }
        
        .onlyoffice-editor-toolbar button:hover {
            background: #e9ecef;
        }
        
        .onlyoffice-editor-toolbar .vr {
            width: 1px;
            height: 1.5rem;
            background: #dee2e6;
        }
        
        .onlyoffice-editor-toolbar .text-muted {
            color: #6c757d;
            font-size: 0.875rem;
        }
        
        .onlyoffice-editor-toolbar .ms-auto {
            margin-left: auto;
        }
        
        .onlyoffice-editor-toolbar .badge {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            border-radius: 0.25rem;
            font-weight: 500;
        }
        
        .badge.bg-info {
            background-color: #0dcaf0;
            color: #000;
        }
        
        .badge.bg-success {
            background-color: #198754;
            color: #fff;
        }
        
        .badge.bg-warning {
            background-color: #ffc107;
            color: #000;
        }
        
        .badge.bg-danger {
            background-color: #dc3545;
            color: #fff;
        }
        
        .onlyoffice-editor-content {
            flex: 1;
            overflow: hidden;
            position: relative;
        }
        
        #onlyoffice-editor {
            width: 100%;
            height: 100%;
            border: none;
        }
        
        /* Zurück-Button im ONLYOFFICE-Branding-Bereich */
        .onlyoffice-back-button {
            position: absolute;
            top: 0;
            left: 0;
            z-index: 10001;
            background: #000;
            border: none;
            border-bottom: 2px solid {{ accent_color }};
            border-right: 2px solid {{ accent_color }};
            padding: 4px 12px;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            transition: all 0.2s;
            border-radius: 0 0 8px 0; /* Nur unten rechts abgerundet, stärker */
            height: 27px;
            min-width: 100px;
        }
        
        .onlyoffice-back-button:hover {
            background: #1a1a1a;
        }
        
        .onlyoffice-back-button:active {
            background: #333;
        }
        
        .onlyoffice-back-button .button-text {
            background: {{ accent_style }};
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 500;
        }
        
        .onlyoffice-back-button i {
            font-size: 16px;
            color: {{ accent_color }};
        }
        
    </style>
</head>
<body>
<div class="onlyoffice-editor-container">
    <button class="onlyoffice-back-button" onclick="goBack()" title="{{ _('files.onlyoffice.back_button_title') }}">
        <i class="bi bi-arrow-left"></i>
        <span class="button-text">{{ _('files.onlyoffice.back_button_label') }}</span>
    </button>
    <div id="onlyoffice-editor"></div>
</div>

<script>
let docEditor;
let isEditorReady = false;
let apiLoadAttempts = 0;
const MAX_API_LOAD_ATTEMPTS = 50; // 5 seconds total (50 * 100ms)

// Load OnlyOffice API script with error handling
const apiScript = document.createElement('script');
apiScript.src = "{{ onlyoffice_api_url }}";
apiScript.onerror = function() {
    console.error('Fehler beim Laden der OnlyOffice API:', "{{ onlyoffice_api_url }}");
    console.error('Mögliche Ursachen:');
    console.error('1. OnlyOffice Document Server läuft nicht auf Port 8080');
    console.error('2. Nginx-Konfiguration ist fehlerhaft (proxy_pass sollte ohne trailing slash sein)');
    console.error('3. OnlyOffice ist nicht unter /onlyoffice erreichbar');
    console.error('4. Firewall blockiert Port 8080');
    
    // Show user-friendly error message
    const editorDiv = document.getElementById('onlyoffice-editor');
    if (editorDiv) {
        editorDiv.innerHTML = '<div style="padding: 2rem; text-align: center; color: #dc3545;"><h3>OnlyOffice konnte nicht geladen werden</h3><p>Bitte überprüfen Sie:</p><ul style="text-align: left; display: inline-block;"><li>OnlyOffice Document Server läuft auf Port 8080</li><li>Nginx-Konfiguration ist korrekt</li><li>OnlyOffice ist unter /onlyoffice erreichbar</li></ul><p style="margin-top: 1rem;">API-URL: {{ onlyoffice_api_url }}</p></div>';
    }
};
apiScript.onload = function() {
    console.log('OnlyOffice API-Skript erfolgreich geladen');
};
document.head.appendChild(apiScript);

function waitForOnlyOfficeAPI(callback) {
    if (typeof DocsAPI !== 'undefined' && typeof DocsAPI.DocEditor !== 'undefined') {
        callback();
        return;
    }
    
    apiLoadAttempts++;
    if (apiLoadAttempts >= MAX_API_LOAD_ATTEMPTS) {
        console.error('ONLYOFFICE Document Server API konnte nicht geladen werden. Bitte stellen Sie sicher, dass ONLYOFFICE Document Server unter {{ onlyoffice_url }} erreichbar ist.');
        console.error('API-URL, die geladen werden sollte:', "{{ onlyoffice_api_url }}");
        
        // Show user-friendly error message
        const editorDiv = document.getElementById('onlyoffice-editor');
        if (editorDiv) {
            editorDiv.innerHTML = '<div style="padding: 2rem; text-align: center; color: #dc3545;"><h3>OnlyOffice API konnte nicht geladen werden</h3><p>Die API-Datei konnte nach 5 Sekunden nicht geladen werden.</p><p>Bitte überprüfen Sie die Browser-Konsole für weitere Details.</p><p style="margin-top: 1rem;">API-URL: {{ onlyoffice_api_url }}</p></div>';
        }
        return;
    }
    
    setTimeout(function() {
        waitForOnlyOfficeAPI(callback);
    }, 100);
}

document.addEventListener('DOMContentLoaded', function() {
    // Build editor configuration
    const config = {
        document: {
            fileType: "{{ file_type }}",
            key: "{{ document_key }}",
            title: "{{ file.name }}",
            url: "{{ document_url }}"
        },
        documentType: "{{ document_type }}",
        editorConfig: {
            callbackUrl: "{{ callback_url }}",
            mode: "edit",
            lang: "{{ onlyoffice_lang }}",
            coEditing: {
                mode: "fast",
                change: true
            },
            user: {
                id: "{{ guest_mode and share_token or current_user.id }}",
                name: "{{ guest_mode and guest_name or current_user.full_name }}"
            },
            customization: {
                autosave: true,
                forcesave: true,
                hideRightMenu: false,
                hideRulers: false,
                hideStatusBar: false,
                showReviewChanges: true
            }
        },
        width: "100%",
        height: "100%"
    };
    
    // Add token if available (OnlyOffice requires token when JWT is enabled)
    {% if token and token|length > 0 %}
    config.token = "{{ token }}";
    console.log('OnlyOffice JWT token added to config (length: {{ token|length }})');
    {% else %}
    console.warn('OnlyOffice JWT token not provided - JWT may be disabled or secret key not set');
    console.warn('If OnlyOffice Document Server has JWT_ENABLED=true, you must set ONLYOFFICE_SECRET_KEY in .env');
    {% endif %}
    
    // Log configuration for debugging
    console.log('OnlyOffice config:', {
        documentUrl: config.document.url,
        documentKey: config.document.key,
        documentType: config.documentType,
        callbackUrl: config.editorConfig.callbackUrl,
        hasToken: !!config.token
    });
    
    // Note: The document URL will be fetched by OnlyOffice Document Server, not by the browser
    // The browser cannot test this directly due to CORS - OnlyOffice Document Server must fetch it
    console.log('Document URL for OnlyOffice Document Server:', config.document.url);
    console.log('OnlyOffice Document Server will fetch this URL directly from its server');
    
    // Wait for ONLYOFFICE API to load
    waitForOnlyOfficeAPI(function() {
        // Initialize editor
        try {
            console.log('Initializing OnlyOffice editor...');
            docEditor = new DocsAPI.DocEditor("onlyoffice-editor", config);
            
            // Check if docEditor is available
            if (!docEditor) {
                console.error('OnlyOffice editor object is null');
                console.error('Fehler beim Initialisieren des Editors: Editor-Objekt konnte nicht erstellt werden.');
                return;
            }
            
            // Wait a bit for events to be available (OnlyOffice needs time to initialize)
            // OnlyOffice may need more time to fully initialize, especially when loading documents
            let eventsCheckAttempts = 0;
            const maxEventsCheckAttempts = 100; // 10 seconds total (100 * 100ms) - increased for slower connections
            
            function checkEventsAvailability() {
                if (docEditor && docEditor.events) {
                    console.log('OnlyOffice editor events available');
                    setupEventHandlers();
                } else {
                    eventsCheckAttempts++;
                    if (eventsCheckAttempts >= maxEventsCheckAttempts) {
                        console.error('OnlyOffice editor events object is null after waiting');
                        console.error('Fehler beim Initialisieren des Editors: Editor-Events konnten nicht initialisiert werden. Bitte laden Sie die Seite neu.');
                        // Don't show error to user - editor might still work
                        // Try to setup handlers anyway after a delay
                        setTimeout(function() {
                            if (docEditor && docEditor.events) {
                                console.log('OnlyOffice editor events became available after timeout');
                                setupEventHandlers();
                            }
                        }, 2000);
                        return;
                    }
                    // Check again in 100ms
                    setTimeout(checkEventsAvailability, 100);
                }
            }
            
            // Start checking for events availability
            checkEventsAvailability();
        } catch (error) {
            console.error('Error initializing ONLYOFFICE editor:', error);
            console.error('Fehler beim Initialisieren des Editors: ' + error.message);
        }
    });
});

function setupEventHandlers() {
    if (!docEditor || !docEditor.events) {
        return;
    }
    
    console.log('OnlyOffice editor initialized successfully');
            
    // Editor event handlers
    docEditor.events.on("onDocumentReady", function() {
        console.log('OnlyOffice document ready');
        isEditorReady = true;
    });
    
    docEditor.events.on("onInfo", function(data) {
        console.log('ONLYOFFICE Info:', data);
        // Handle version change notification
        if (data && data.event === 'documentStateChange' && data.data && data.data.version) {
            console.log('Document version changed:', data.data.version);
        }
    });
    
    docEditor.events.on("onError", function(error) {
        console.error('ONLYOFFICE Error:', error);
        // Log errors to console only, no user-facing error messages
        if (error && typeof error === 'object') {
            if (error.message) {
                console.error('Error message:', error.message);
            } else if (error.error) {
                console.error('Error:', error.error);
            } else {
                console.error('Error details:', JSON.stringify(error));
            }
        } else if (error) {
            console.error('Error:', String(error));
        }
    });
    
    docEditor.events.on("onRequestDocument", function() {
        console.log('OnlyOffice requesting document from:', config.document.url);
        console.log('Full document URL:', config.document.url);
    });
    
    // Track document state changes
    docEditor.events.on("onDocumentStateChange", function(data) {
        console.log('OnlyOffice document state changed:', data);
    });
    
    // Track warnings
    docEditor.events.on("onWarning", function(warning) {
        console.warn('OnlyOffice warning:', warning);
    });
    
    docEditor.events.on("onRequestSave", function() {
        console.log('OnlyOffice saving document...');
    });
}

function goBack() {
    if (isEditorReady && docEditor) {
        // Try to save if editor is ready
        try {
            docEditor.downloadAs();
        } catch (e) {
            console.error('Error saving before leaving:', e);
        }
    }
    
    // Redirect back using return_url
    {% if return_url %}
    window.location.href = '{{ return_url }}';
    {% elif file.folder_id %}
    window.location.href = '{{ url_for("files.browse_folder", folder_id=file.folder_id) }}';
    {% else %}
    window.location.href = '{{ url_for("files.index") }}';
    {% endif %}
}

// Warn before leaving if editor has unsaved changes
window.addEventListener('beforeunload', function(e) {
    if (isEditorReady && docEditor) {
        // Check if there are unsaved changes
        // Note: This is a simplified check - ONLYOFFICE handles saving internally
        e.preventDefault();
        e.returnValue = '';
    }
});

// Keyboard shortcut: Escape to go back
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        goBack();
    }
});

// Hide toolbar by default for fullscreen experience
// Uncomment the line below if you want to show the toolbar
// document.getElementById('toolbar').style.display = 'flex';
</script>
</body>
</html>

