{% extends "base.html" %}

{% block title %}{{ file.name }} bearbeiten - Dateien{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/files.css') }}">
{% endblock %}

{% block content %}
<div class="markdown-editor-fullscreen">
    <div class="markdown-editor-toolbar">
        <button type="button" class="btn btn-outline-secondary" onclick="goBack()" id="backBtn">
            <i class="bi bi-arrow-left"></i> Zurück
        </button>
        <button type="button" class="btn btn-accent" onclick="saveFile()" id="saveBtn">
            <i class="bi bi-check-lg"></i> Speichern
        </button>
        
        <div class="vr"></div>
        
        <div class="btn-group" role="group">
            <button type="button" class="btn btn-outline-secondary" onclick="formatText('bold')" title="Fett">
                <i class="bi bi-type-bold"></i>
            </button>
            <button type="button" class="btn btn-outline-secondary" onclick="formatText('italic')" title="Kursiv">
                <i class="bi bi-type-italic"></i>
            </button>
            <button type="button" class="btn btn-outline-secondary" onclick="formatText('strikethrough')" title="Durchgestrichen">
                <i class="bi bi-type-strikethrough"></i>
            </button>
        </div>
        
        <div class="vr"></div>
        
        <div class="btn-group" role="group">
            <button type="button" class="btn btn-outline-secondary" onclick="formatText('heading1')" title="Überschrift 1">
                <i class="bi bi-type-h1"></i>
            </button>
            <button type="button" class="btn btn-outline-secondary" onclick="formatText('heading2')" title="Überschrift 2">
                <i class="bi bi-type-h2"></i>
            </button>
            <button type="button" class="btn btn-outline-secondary" onclick="formatText('heading3')" title="Überschrift 3">
                <i class="bi bi-type-h3"></i>
            </button>
        </div>
        
        <div class="vr"></div>
        
        <div class="btn-group" role="group">
            <button type="button" class="btn btn-outline-secondary" onclick="formatText('link')" title="Link">
                <i class="bi bi-link-45deg"></i>
            </button>
            <button type="button" class="btn btn-outline-secondary" onclick="formatText('image')" title="Bild">
                <i class="bi bi-image"></i>
            </button>
            <button type="button" class="btn btn-outline-secondary" onclick="formatText('code')" title="Inline Code">
                <i class="bi bi-code"></i>
            </button>
            <button type="button" class="btn btn-outline-secondary" onclick="formatText('codeBlock')" title="Code-Block">
                <i class="bi bi-code-square"></i>
            </button>
        </div>
        
        <div class="vr"></div>
        
        <div class="btn-group" role="group">
            <button type="button" class="btn btn-outline-secondary" onclick="formatText('list')" title="Unsortierte Liste">
                <i class="bi bi-list-ul"></i>
            </button>
            <button type="button" class="btn btn-outline-secondary" onclick="formatText('orderedList')" title="Nummerierte Liste">
                <i class="bi bi-list-ol"></i>
            </button>
            <button type="button" class="btn btn-outline-secondary" onclick="formatText('blockquote')" title="Zitat">
                <i class="bi bi-quote"></i>
            </button>
        </div>
        
        <div class="vr"></div>
        
        <div class="btn-group" role="group">
            <button type="button" class="btn btn-outline-secondary" onclick="formatText('superscript')" title="Hochgestellt">
                <i class="bi bi-superscript"></i>
            </button>
            <button type="button" class="btn btn-outline-secondary" onclick="formatText('subscript')" title="Tiefgestellt">
                <i class="bi bi-subscript"></i>
            </button>
            <button type="button" class="btn btn-outline-secondary" onclick="formatText('footnote')" title="Fußnote">
                <i class="bi bi-asterisk"></i>
            </button>
        </div>
        
        <div class="vr"></div>
        
        <div class="btn-group" role="group">
            <button type="button" class="btn btn-outline-secondary" onclick="insertTable()" title="Tabelle">
                <i class="bi bi-table"></i>
            </button>
            <button type="button" class="btn btn-outline-secondary" onclick="insertHorizontalRule()" title="Horizontale Linie">
                <i class="bi bi-hr"></i>
            </button>
        </div>
        
        <div class="vr"></div>
        
        <div class="btn-group" role="group">
            <button type="button" class="btn btn-outline-secondary" onclick="formatText('mathInline')" title="Inline-Formel ($...$)">
                <i class="bi bi-calculator"></i>
            </button>
            <button type="button" class="btn btn-outline-secondary" onclick="formatText('mathBlock')" title="Block-Formel ($$...$$)">
                <i class="bi bi-calculator-fill"></i>
            </button>
        </div>
        
        <div class="ms-auto">
            <div class="btn-group" role="group">
                <button type="button" class="btn btn-outline-secondary" onclick="togglePreview()" id="previewBtn">
                    <i class="bi bi-eye"></i> Vorschau
                </button>
            </div>
        </div>
    </div>
    
    <div class="markdown-editor-content">
        <div class="row g-0 h-100">
            <div class="col-12" id="editorColumn">
                <form method="POST" id="editForm">
                    <textarea 
                        class="markdown-editor-textarea" 
                        name="content" 
                        id="markdownEditor"
                        placeholder="Beginnen Sie mit dem Schreiben...">{{ content }}</textarea>
                </form>
            </div>
            <div class="col-12" id="previewColumn" style="display: none;">
                <div class="markdown-editor-preview markdown-content" id="markdownPreview">
                    <!-- Vorschau wird hier angezeigt -->
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let isPreviewMode = false;
let hasUnsavedChanges = false;

document.addEventListener('DOMContentLoaded', function() {
    const editor = document.getElementById('markdownEditor');
    const form = document.getElementById('editForm');
    
    // Auto-save functionality
    let autoSaveTimeout;
    editor.addEventListener('input', function() {
        hasUnsavedChanges = true;
        
        // Auto-save nach 30 Sekunden Inaktivität
        clearTimeout(autoSaveTimeout);
        autoSaveTimeout = setTimeout(() => {
            if (hasUnsavedChanges) {
                saveFile(true); // Silent save
            }
        }, 30000);
    });
    
    // Warnung vor Verlassen bei ungespeicherten Änderungen
    window.addEventListener('beforeunload', function(e) {
        if (hasUnsavedChanges) {
            e.preventDefault();
            e.returnValue = '';
        }
    });
    
    // Keyboard shortcuts
    editor.addEventListener('keydown', function(e) {
        // Ctrl+S oder Cmd+S zum Speichern
        if ((e.ctrlKey || e.metaKey) && e.key === 's') {
            e.preventDefault();
            saveFile();
        }
        
        // Ctrl+Z oder Cmd+Z für Undo (Browser default)
        // Ctrl+Y oder Cmd+Y für Redo (Browser default)
    });
    
    // Focus auf Editor
    editor.focus();
});

function goBack() {
    if (hasUnsavedChanges) {
        if (confirm('Sie haben ungespeicherte Änderungen. Möchten Sie wirklich zurückgehen?')) {
            window.location.href = '{{ url_for("files.browse_folder", folder_id=file.folder_id) if file.folder_id else url_for("files.index") }}';
        }
    } else {
        window.location.href = '{{ url_for("files.browse_folder", folder_id=file.folder_id) if file.folder_id else url_for("files.index") }}';
    }
}

function saveFile(silent = false) {
    const form = document.getElementById('editForm');
    const saveBtn = document.getElementById('saveBtn');
    
    if (!silent) {
        saveBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Speichere...';
        saveBtn.disabled = true;
    }
    
    // Submit form
    fetch(form.action, {
        method: 'POST',
        body: new FormData(form)
    })
    .then(response => {
        if (response.ok) {
            hasUnsavedChanges = false;
            if (!silent) {
                saveBtn.innerHTML = '<i class="bi bi-check-lg"></i> Gespeichert!';
                setTimeout(() => {
                    saveBtn.innerHTML = '<i class="bi bi-check-lg"></i> Speichern';
                }, 2000);
            }
        } else {
            throw new Error('Fehler beim Speichern');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        if (!silent) {
            alert('Fehler beim Speichern der Datei. Bitte versuchen Sie es erneut.');
        }
    })
    .finally(() => {
        if (!silent) {
            saveBtn.disabled = false;
        }
    });
}

function formatText(type) {
    const editor = document.getElementById('markdownEditor');
    const start = editor.selectionStart;
    const end = editor.selectionEnd;
    const selectedText = editor.value.substring(start, end);
    const textBefore = editor.value.substring(0, start);
    const textAfter = editor.value.substring(end);
    const lineStart = textBefore.lastIndexOf('\n') + 1;
    const currentLine = editor.value.substring(lineStart, end);
    
    let replacement = '';
    let newCursorPos = start;
    
    switch(type) {
        case 'bold':
            replacement = `**${selectedText || 'Text'}**`;
            newCursorPos = start + replacement.length;
            break;
        case 'italic':
            replacement = `*${selectedText || 'Text'}*`;
            newCursorPos = start + replacement.length;
            break;
        case 'strikethrough':
            replacement = `~~${selectedText || 'Text'}~~`;
            newCursorPos = start + replacement.length;
            break;
        case 'heading1':
            replacement = `# ${selectedText || 'Überschrift'}`;
            newCursorPos = start + replacement.length;
            break;
        case 'heading2':
            replacement = `## ${selectedText || 'Überschrift'}`;
            newCursorPos = start + replacement.length;
            break;
        case 'heading3':
            replacement = `### ${selectedText || 'Überschrift'}`;
            newCursorPos = start + replacement.length;
            break;
        case 'link':
            replacement = `[${selectedText || 'Link-Text'}](URL)`;
            newCursorPos = start + replacement.length - 4; // Cursor vor "URL"
            break;
        case 'code':
            replacement = `\`${selectedText || 'Code'}\``;
            newCursorPos = start + replacement.length;
            break;
        case 'codeBlock':
            replacement = `\`\`\`\n${selectedText || 'Code'}\n\`\`\``;
            newCursorPos = start + replacement.length - 4; // Cursor vor schließenden ```
            break;
        case 'list':
            // Prüfe ob bereits eine Liste vorhanden ist
            if (currentLine.trim().startsWith('- ') || currentLine.trim().startsWith('* ')) {
                replacement = selectedText || 'Listenpunkt';
            } else {
                replacement = `- ${selectedText || 'Listenpunkt'}`;
            }
            newCursorPos = start + replacement.length;
            break;
        case 'orderedList':
            // Prüfe ob bereits eine nummerierte Liste vorhanden ist
            if (/^\d+\.\s/.test(currentLine.trim())) {
                replacement = selectedText || 'Listenpunkt';
            } else {
                replacement = `1. ${selectedText || 'Listenpunkt'}`;
            }
            newCursorPos = start + replacement.length;
            break;
        case 'blockquote':
            // Prüfe ob bereits ein Blockquote vorhanden ist
            if (currentLine.trim().startsWith('> ')) {
                replacement = selectedText || 'Zitat';
            } else {
                replacement = `> ${selectedText || 'Zitat'}`;
            }
            newCursorPos = start + replacement.length;
            break;
        case 'superscript':
            replacement = `^${selectedText || 'Text'}^`;
            newCursorPos = start + replacement.length;
            break;
        case 'subscript':
            replacement = `~${selectedText || 'Text'}~`;
            newCursorPos = start + replacement.length;
            break;
        case 'footnote':
            replacement = `[^${selectedText || '1'}]`;
            newCursorPos = start + replacement.length;
            break;
        case 'image':
            replacement = `![${selectedText || 'Alt-Text'}](${selectedText ? 'URL' : 'URL'})`;
            newCursorPos = start + replacement.length - 4; // Cursor vor "URL"
            break;
        case 'mathInline':
            replacement = `$${selectedText || 'E = mc^2'}$`;
            newCursorPos = start + replacement.length;
            break;
        case 'mathBlock':
            replacement = `$$\n${selectedText || '\\int_{0}^{\\infty} e^{-x^2} dx = \\frac{\\sqrt{\\pi}}{2}'}\n$$`;
            newCursorPos = start + replacement.length - 3; // Cursor vor schließenden $$
            break;
    }
    
    // Ersetze den ausgewählten Text
    editor.value = textBefore + replacement + textAfter;
    
    // Setze Cursor
    editor.setSelectionRange(newCursorPos, newCursorPos);
    editor.focus();
    
    // Trigger input event für Auto-save
    editor.dispatchEvent(new Event('input'));
}

function insertTable() {
    const editor = document.getElementById('markdownEditor');
    const start = editor.selectionStart;
    const end = editor.selectionEnd;
    
    // Standard-Tabelle mit 2 Spalten und 2 Zeilen
    const tableTemplate = `| Spalte 1 | Spalte 2 |
|----------|----------|
| Zeile 1  | Zeile 1  |
| Zeile 2  | Zeile 2  |
`;
    
    // Füge Tabelle ein
    editor.value = editor.value.substring(0, start) + tableTemplate + editor.value.substring(end);
    
    // Setze Cursor nach der Tabelle
    const newCursorPos = start + tableTemplate.length;
    editor.setSelectionRange(newCursorPos, newCursorPos);
    editor.focus();
    
    // Trigger input event
    editor.dispatchEvent(new Event('input'));
}

function insertHorizontalRule() {
    const editor = document.getElementById('markdownEditor');
    const start = editor.selectionStart;
    const end = editor.selectionEnd;
    const textBefore = editor.value.substring(0, start);
    const textAfter = editor.value.substring(end);
    
    // Füge horizontale Linie ein (mit Leerzeilen davor und danach)
    let hr = '\n---\n';
    
    // Prüfe ob bereits eine Leerzeile davor ist
    if (textBefore.length > 0 && textBefore[textBefore.length - 1] !== '\n') {
        hr = '\n' + hr;
    }
    
    // Prüfe ob bereits eine Leerzeile danach ist
    if (textAfter.length > 0 && textAfter[0] !== '\n') {
        hr = hr + '\n';
    }
    
    editor.value = textBefore + hr + textAfter;
    
    // Setze Cursor nach der Linie
    const newCursorPos = start + hr.length;
    editor.setSelectionRange(newCursorPos, newCursorPos);
    editor.focus();
    
    // Trigger input event
    editor.dispatchEvent(new Event('input'));
}

function togglePreview() {
    const editorColumn = document.getElementById('editorColumn');
    const previewColumn = document.getElementById('previewColumn');
    const previewBtn = document.getElementById('previewBtn');
    
    if (isPreviewMode) {
        // Zurück zum Editor
        editorColumn.style.display = 'block';
        previewColumn.style.display = 'none';
        previewBtn.innerHTML = '<i class="bi bi-eye"></i> Vorschau';
        isPreviewMode = false;
    } else {
        // Zeige Vorschau
        updatePreview();
        editorColumn.style.display = 'none';
        previewColumn.style.display = 'block';
        previewBtn.innerHTML = '<i class="bi bi-pencil"></i> Bearbeiten';
        isPreviewMode = true;
    }
}

function updatePreview() {
    const editor = document.getElementById('markdownEditor');
    const preview = document.getElementById('markdownPreview');
    
    // Nutze Preview-Endpoint für korrekte Markdown-Verarbeitung
    const formData = new FormData();
    formData.append('content', editor.value);
    
    fetch('{{ url_for("files.preview_file", file_id=file.id) }}', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        preview.innerHTML = data.html;
        
        // Triggere MathJax-Rendering nach Preview-Update
        if (window.MathJax && window.MathJax.typesetPromise) {
            window.MathJax.typesetPromise([preview]).catch(function(err) {
                console.error('MathJax rendering error:', err);
            });
        }
    })
    .catch(error => {
        console.error('Error:', error);
        // Fallback zu einfacher Konvertierung
        let html = editor.value
            .replace(/^# (.*$)/gim, '<h1>$1</h1>')
            .replace(/^## (.*$)/gim, '<h2>$1</h2>')
            .replace(/^### (.*$)/gim, '<h3>$1</h3>')
            .replace(/\*\*(.*?)\*\*/gim, '<strong>$1</strong>')
            .replace(/\*(.*?)\*/gim, '<em>$1</em>')
            .replace(/~~(.*?)~~/gim, '<del>$1</del>')
            .replace(/`(.*?)`/gim, '<code>$1</code>')
            .replace(/\[([^\]]+)\]\(([^)]+)\)/gim, '<a href="$2">$1</a>')
            .replace(/^- (.*$)/gim, '<li>$1</li>')
            .replace(/\n/gim, '<br>');
        preview.innerHTML = html;
    });
}

// Escape key zum Schließen
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        goBack();
    }
});
</script>

<!-- MathJax für LaTeX-Formeln in Preview -->
<script>
window.MathJax = {
    tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']],
        displayMath: [['$$', '$$'], ['\\[', '\\]']],
        processEscapes: true,
        processEnvironments: true,
        tags: 'ams'
    },
    options: {
        ignoreHtmlClass: 'tex2jax_ignore',
        processHtmlClass: 'tex2jax_process|markdown-content'
    }
};
</script>
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
{% endblock %}



