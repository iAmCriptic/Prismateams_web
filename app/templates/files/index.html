{% extends "base.html" %}

{% block title %}{{ _('files.index.page_title') }}{% endblock %}

{% block content %}
<div class="row mb-4 align-items-center g-3">
    <div class="col">
        <h1 class="mb-3"><i class="bi bi-folder"></i> {{ _('files.index.heading') }}</h1>
        {% if breadcrumb_folders %}
        <nav aria-label="breadcrumb" class="mb-3 mb-md-0">
            <ol class="breadcrumb mb-0">
                <li class="breadcrumb-item">
                    <a href="{{ url_for('files.index') }}">{{ _('files.index.breadcrumb_root') }}</a>
                </li>
                {% for breadcrumb in breadcrumb_folders %}
                    {% if loop.last %}
                    <li class="breadcrumb-item active" aria-current="page">{{ breadcrumb.name }}</li>
                    {% else %}
                    <li class="breadcrumb-item">
                        <a href="{{ breadcrumb.url }}">{{ breadcrumb.name }}</a>
                    </li>
                    {% endif %}
                {% endfor %}
            </ol>
        </nav>
        {% endif %}
    </div>
    <div class="col-auto">
        <div class="btn-group me-2" role="group">
            <button class="btn btn-outline-secondary" id="listViewBtn" title="{{ _('files.index.view_toggle.list') }}">
                <i class="bi bi-list"></i>
            </button>
            <button class="btn btn-outline-secondary active" id="gridViewBtn" title="{{ _('files.index.view_toggle.grid') }}">
                <i class="bi bi-grid-3x3-gap"></i>
            </button>
        </div>
        <div class="btn-group" role="group">
            <div class="dropdown" id="newButtonDropdown">
                <button class="btn btn-accent" type="button" id="newButton">
                    <i class="bi bi-plus-circle"></i> {{ _('files.index.new_button') }}
                </button>
                <ul class="dropdown-menu" id="newDropdownMenu" style="display: none;">
                    <li>
                        <a class="dropdown-item" href="#" id="uploadFileMenuItem">
                            <i class="bi bi-upload"></i> {{ _('files.index.dropdown.upload_files') }}
                        </a>
                    </li>
                    <li>
                        <a class="dropdown-item" href="#" id="uploadFolderMenuItem">
                            <i class="bi bi-folder-upload"></i> {{ _('files.index.dropdown.upload_folder') }}
                        </a>
                    </li>
                    <li><hr class="dropdown-divider"></li>
                    <li>
                        <a class="dropdown-item" href="#" id="createFolderMenuItem">
                            <i class="bi bi-folder-plus"></i> {{ _('files.index.dropdown.create_folder') }}
                        </a>
                    </li>
                    {% if onlyoffice_available %}
                    <li>
                        <a class="dropdown-item" href="#" data-create-type="docx">
                            <i class="bi bi-file-earmark-word"></i> {{ _('files.index.dropdown.create_word') }}
                        </a>
                    </li>
                    <li>
                        <a class="dropdown-item" href="#" data-create-type="xlsx">
                            <i class="bi bi-file-earmark-spreadsheet"></i> {{ _('files.index.dropdown.create_excel') }}
                        </a>
                    </li>
                    <li>
                        <a class="dropdown-item" href="#" data-create-type="pptx">
                            <i class="bi bi-file-earmark-slides"></i> {{ _('files.index.dropdown.create_powerpoint') }}
                        </a>
                    </li>
                    {% endif %}
                    <li>
                        <a class="dropdown-item" href="#" id="createMdMenuItem">
                            <i class="bi bi-file-earmark-text"></i> {{ _('files.index.dropdown.create_markdown') }}
                        </a>
                    </li>
                </ul>
            </div>
            <!-- Hidden file input for direct upload -->
            <input type="file" id="directFileUpload" name="file" style="display: none;" multiple>
            <input type="file" id="directFolderUpload" name="folder_upload" style="display: none;" webkitdirectory directory multiple>
        </div>
    </div>
</div>

<!-- ============================================ -->
<!-- GRID VIEW - ORDNER Sektion (IMMER sichtbar) -->
<!-- ============================================ -->
<div id="gridViewContainer" style="display: none;">
    <!-- Ordner Überschrift - IMMER anzeigen -->
    <h5 class="mb-3">{{ _('files.index.sections.folders') }}</h5>

    <!-- Inline Folder Creation (Grid View) -->
    <div id="inlineFolderCreateGrid" class="row g-3 mb-4" style="display: none;">
        <div class="col-12 col-md-6 col-lg-3">
            <div class="card folder-item">
                <div class="card-body">
                    <div class="text-center mb-3">
                        <i class="bi bi-folder-fill text-warning fs-1"></i>
                    </div>
                    <form method="POST" action="{{ url_for('files.create_folder') }}" class="inline-create-form">
                        <input type="hidden" name="parent_id" value="{{ current_folder.id if current_folder else '' }}">
                        <input type="text" class="form-control form-control-sm" name="folder_name" placeholder="{{ _('files.index.inline.folder_name_placeholder') }}" required autofocus>
                        <div class="d-flex gap-2 mt-2">
                            <button type="submit" class="btn btn-sm btn-accent flex-fill">
                                <i class="bi bi-check"></i> {{ _('common.create') }}
                            </button>
                            <button type="button" class="btn btn-sm btn-secondary cancel-inline-create">
                                <i class="bi bi-x"></i>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Folders Grid View - Nur anzeigen wenn Ordner vorhanden -->
    <div id="foldersGridView" class="row g-3 mb-4">
        {% if subfolders %}
        {% for folder in subfolders %}
        <div class="col-12 col-md-6 col-lg-3">
            <div class="card folder-item" onclick="location.href='{{ url_for('files.browse_folder', folder_id=folder.id) }}'">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <i class="bi bi-folder-fill text-warning fs-1"></i>
                            <h6 class="mt-2 mb-0">{{ folder.name }}</h6>
                        </div>
                        <div class="dropdown" onclick="event.stopPropagation()">
                            <button class="btn btn-sm btn-link" data-bs-toggle="dropdown">
                                <i class="bi bi-three-dots-vertical"></i>
                            </button>
                            <ul class="dropdown-menu">
                                {% if files_dropbox_enabled and folder.is_dropbox %}
                                <li>
                                    <a class="dropdown-item" href="#" onclick="openDropboxSettings({{ folder.id }}); return false;">
                                        <i class="bi bi-gear"></i> {{ _('files.index.folder_actions.dropbox_edit') }}
                                    </a>
                                </li>
                                {% elif files_dropbox_enabled %}
                                <li>
                                    <form method="POST" action="{{ url_for('files.make_dropbox', folder_id=folder.id) }}" class="d-inline">
                                        <button type="submit" class="dropdown-item">
                                            <i class="bi bi-mailbox"></i> {{ _('files.index.folder_actions.dropbox_make') }}
                                        </button>
                                    </form>
                                </li>
                                {% endif %}
                                {% if files_sharing_enabled %}
                                <li><hr class="dropdown-divider"></li>
                                {% if folder.share_enabled %}
                                <li>
                                    <a class="dropdown-item" href="#" onclick="openShareSettings('folder', {{ folder.id }}); return false;">
                                        <i class="bi bi-gear"></i> {{ _('files.index.folder_actions.share_edit') }}
                                    </a>
                                </li>
                                <li>
                                    <form method="POST" action="{{ url_for('files.update_folder_share', folder_id=folder.id) }}" class="d-inline">
                                        <input type="hidden" name="action" value="disable">
                                        <button type="submit" class="dropdown-item">
                                            <i class="bi bi-slash-circle"></i> {{ _('files.index.folder_actions.share_disable') }}
                                        </button>
                                    </form>
                                </li>
                                {% else %}
                                <li>
                                    <a class="dropdown-item" href="#" onclick="openShareDialog('folder', {{ folder.id }}); return false;">
                                        <i class="bi bi-share"></i> {{ _('files.index.folder_actions.share') }}
                                    </a>
                                </li>
                                {% endif %}
                                {% endif %}
                                <li><hr class="dropdown-divider"></li>
                                <li>
                                    <form method="POST" action="{{ url_for('files.rename_folder', folder_id=folder.id) }}" class="d-inline" onsubmit="return confirm('{{ _('files.index.alerts.rename_folder') }}');">
                                        <input type="hidden" name="new_name" value="{{ folder.name }}">
                                        <button type="submit" class="dropdown-item">
                                            <i class="bi bi-pencil"></i> {{ _('files.index.folder_actions.rename') }}
                                        </button>
                                    </form>
                                </li>
                                <li>
                                    <form method="POST" action="{{ url_for('files.delete_folder', folder_id=folder.id) }}" class="d-inline">
                                        <button type="submit" class="dropdown-item text-danger" data-confirm-delete="{{ _('files.index.alerts.delete_folder') }}">
                                            <i class="bi bi-trash"></i> {{ _('files.index.folder_actions.delete') }}
                                        </button>
                                    </form>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
        {% endif %}
    </div>

    <!-- ============================================ -->
    <!-- GRID VIEW - DATEIEN Sektion (IMMER sichtbar) -->
    <!-- ============================================ -->
    
    <!-- Dateien Überschrift - IMMER anzeigen -->
    <h5 class="mb-3">{{ _('files.index.sections.files') }}</h5>

    <!-- Inline File Creation (Grid View) -->
    <div id="inlineFileCreateGrid" class="row g-3 mb-4" style="display: none;">
        <div class="col-12 col-md-6 col-lg-3">
            <div class="card file-item">
                <div class="card-body">
                    <div class="text-center mb-3">
                        <i class="bi bi-file-earmark fs-1 text-primary" id="inlineFileIcon"></i>
                    </div>
                    <form method="POST" class="inline-create-form" id="inlineFileForm">
                        <input type="hidden" name="folder_id" value="{{ current_folder.id if current_folder else '' }}">
                        <input type="text" class="form-control form-control-sm" name="filename" placeholder="{{ _('files.index.inline.file_name_placeholder') }}" required autofocus>
                        <div class="d-flex gap-2 mt-2">
                            <button type="submit" class="btn btn-sm btn-accent flex-fill">
                                <i class="bi bi-check"></i> {{ _('common.create') }}
                            </button>
                            <button type="button" class="btn btn-sm btn-secondary cancel-inline-create">
                                <i class="bi bi-x"></i>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Files Grid View - Nur anzeigen wenn Dateien vorhanden -->
    <div id="gridView" class="row g-3">
        {% if files %}
        {% for file in files %}
        <div class="col-12 col-md-6 col-lg-4">
            <div class="card file-item h-100" 
                 {% set file_ext = file.name[file.name.rfind('.'):] if '.' in file.name else '' %}
                 {% if file.name.endswith(('.md', '.markdown')) %}
                 onclick="location.href='{{ url_for('files.view_file', file_id=file.id) }}'" style="cursor: pointer;"
                 {% elif onlyoffice_available and file_ext.lower() in ['.docx', '.doc', '.odt', '.rtf', '.txt', '.xlsx', '.xls', '.ods', '.csv', '.pptx', '.ppt', '.odp', '.pdf'] %}
                 onclick="location.href='{{ url_for('files.edit_onlyoffice', file_id=file.id) }}'" style="cursor: pointer;"
                 {% elif file.name.endswith('.txt') %}
                 onclick="location.href='{{ url_for('files.view_file', file_id=file.id) }}'" style="cursor: pointer;"
                 {% elif file.name.endswith('.pdf') %}
                 onclick="location.href='{{ url_for('files.view_file', file_id=file.id) }}'" style="cursor: pointer;"
                 {% else %}
                 onclick="location.href='{{ url_for('files.download_file', file_id=file.id) }}'" style="cursor: pointer;"
                 {% endif %}>
                <div class="card-body">
                    <!-- File Preview/Icon -->
                    <div class="text-center mb-3">
                        {% if file.name.endswith(('.jpg', '.jpeg', '.png', '.gif', '.webp')) %}
                            <img src="{{ url_for('files.download_file', file_id=file.id) }}" 
                                 class="file-preview img-fluid rounded" 
                                 style="max-height: 120px; max-width: 100%; object-fit: cover;"
                                 alt="Vorschau" 
                                 onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                            <i class="bi bi-file-earmark-image fs-1 text-success" style="display: none;"></i>
                        {% elif file.name.endswith('.pdf') %}
                            <div class="file-icon-preview bg-light rounded d-flex align-items-center justify-content-center" style="height: 120px;">
                                <img src="{{ url_for('static', filename='img/PDF.png') }}" alt="PDF" class="file-type-icon" style="max-height: 80px; max-width: 80px;" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                                <i class="bi bi-file-earmark-pdf fs-1 text-danger" style="display: none;"></i>
                            </div>
                        {% elif file.name.endswith(('.md', '.markdown')) %}
                            <div class="file-icon-preview bg-light rounded d-flex align-items-center justify-content-center" style="height: 120px;">
                                <img src="{{ url_for('static', filename='img/markdown.png') }}" alt="Markdown" class="file-type-icon" style="max-height: 80px; max-width: 80px;" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                                <i class="bi bi-file-earmark-text fs-1 text-info" style="display: none;"></i>
                            </div>
                        {% elif file.name.endswith('.txt') %}
                            <div class="text-preview bg-light rounded p-3" style="height: 120px; overflow: hidden;">
                                <i class="bi bi-file-earmark-text fs-1 text-secondary mb-2"></i>
                                <div class="text-muted small">{{ _('files.index.labels.text_file') }}</div>
                            </div>
                        {% elif file.name.endswith('.docx') %}
                            <div class="file-icon-preview bg-light rounded d-flex align-items-center justify-content-center" style="height: 120px;">
                                <img src="{{ url_for('static', filename='img/docx.png') }}" alt="DOCX" class="file-type-icon" style="max-height: 80px; max-width: 80px;" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                                <i class="bi bi-file-earmark-word fs-1 text-primary" style="display: none;"></i>
                            </div>
                        {% elif file.name.endswith('.xlsx') %}
                            <div class="file-icon-preview bg-light rounded d-flex align-items-center justify-content-center" style="height: 120px;">
                                <img src="{{ url_for('static', filename='img/xlsx.png') }}" alt="XLSX" class="file-type-icon" style="max-height: 80px; max-width: 80px;" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                                <i class="bi bi-file-earmark-spreadsheet fs-1 text-success" style="display: none;"></i>
                            </div>
                        {% elif file.name.endswith('.pptx') %}
                            <div class="file-icon-preview bg-light rounded d-flex align-items-center justify-content-center" style="height: 120px;">
                                <img src="{{ url_for('static', filename='img/pptx.png') }}" alt="PPTX" class="file-type-icon" style="max-height: 80px; max-width: 80px;" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                                <i class="bi bi-file-earmark-slides fs-1 text-warning" style="display: none;"></i>
                            </div>
                        {% else %}
                            <i class="bi bi-file-earmark fs-1 text-primary"></i>
                        {% endif %}
                    </div>
                    
                    <!-- File Info -->
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div class="flex-grow-1">
                            <h6 class="mb-1 text-truncate" title="{{ file.name }}">{{ file.name }}</h6>
                            {% if file.version_number > 1 %}
                            <span class="badge bg-info">v{{ file.version_number }}</span>
                            {% endif %}
                        </div>
                        <div class="dropdown" onclick="event.stopPropagation()">
                            <button class="btn btn-sm btn-link" data-bs-toggle="dropdown">
                                <i class="bi bi-three-dots-vertical"></i>
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="{{ url_for('files.download_file', file_id=file.id) }}">
                                    <i class="bi bi-download"></i> {{ _('files.index.file_actions.download') }}
                                </a></li>
                                {% if onlyoffice_available %}
                                    {% set file_ext = file.name[file.name.rfind('.'):] if '.' in file.name else '' %}
                                    {% if file_ext.lower() in ['.docx', '.doc', '.odt', '.rtf', '.txt', '.xlsx', '.xls', '.ods', '.csv', '.pptx', '.ppt', '.odp', '.pdf', '.md', '.markdown'] %}
                                <li><a class="dropdown-item" href="{{ url_for('files.edit_onlyoffice', file_id=file.id) }}">
                                    <i class="bi bi-file-earmark-text"></i> {{ _('files.index.file_actions.edit_onlyoffice') }}
                                </a></li>
                                <li><hr class="dropdown-divider"></li>
                                    {% endif %}
                                {% endif %}
                                {% if file.name.endswith('.pdf') %}
                                <li><a class="dropdown-item" href="{{ url_for('files.view_file', file_id=file.id) }}">
                                    <i class="bi bi-eye"></i> {{ _('files.index.file_actions.view') }}
                                </a></li>
                                {% endif %}
                                {% if file.name.endswith(('.txt', '.md')) %}
                                <li><a class="dropdown-item" href="{{ url_for('files.view_file', file_id=file.id) }}">
                                    <i class="bi bi-eye"></i> {{ _('files.index.file_actions.view') }}
                                </a></li>
                                <li><a class="dropdown-item" href="{{ url_for('files.edit_file', file_id=file.id) }}">
                                    <i class="bi bi-pencil"></i> {{ _('files.index.file_actions.edit') }}
                                </a></li>
                                {% endif %}
                                <li><hr class="dropdown-divider"></li>
                                {% if files_sharing_enabled %}
                                <li><hr class="dropdown-divider"></li>
                                {% if file.share_enabled %}
                                <li><a class="dropdown-item" href="#" onclick="openShareSettings('file', {{ file.id }}); return false;">
                                    <i class="bi bi-gear"></i> {{ _('files.index.file_actions.share_edit') }}
                                </a></li>
                                <li>
                                    <form method="POST" action="{{ url_for('files.update_file_share', file_id=file.id) }}" class="d-inline">
                                        <input type="hidden" name="action" value="disable">
                                        <button type="submit" class="dropdown-item">
                                            <i class="bi bi-slash-circle"></i> {{ _('files.index.file_actions.share_disable') }}
                                        </button>
                                    </form>
                                </li>
                                {% else %}
                                <li><a class="dropdown-item" href="#" onclick="openShareDialog('file', {{ file.id }}); return false;">
                                    <i class="bi bi-share"></i> {{ _('files.index.file_actions.share') }}
                                </a></li>
                                {% endif %}
                                {% endif %}
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="#" onclick="openFileDetails({{ file.id }})">
                                    <i class="bi bi-info-circle"></i> {{ _('files.index.file_actions.details') }}
                                </a></li>
                                <li>
                                    <form method="POST" action="{{ url_for('files.rename_file', file_id=file.id) }}" class="d-inline" onsubmit="return confirm('{{ _('files.index.alerts.rename_file') }}');">
                                        <input type="hidden" name="new_name" value="{{ file.name }}">
                                        <button type="submit" class="dropdown-item">
                                            <i class="bi bi-pencil"></i> {{ _('files.index.file_actions.rename') }}
                                        </button>
                                    </form>
                                </li>
                                <li><hr class="dropdown-divider"></li>
                                <li>
                                    <form method="POST" action="{{ url_for('files.delete_file', file_id=file.id) }}" class="d-inline">
                                        <button type="submit" class="dropdown-item text-danger" data-confirm-delete="{{ _('files.index.alerts.delete_file') }}">
                                            <i class="bi bi-trash"></i> {{ _('files.index.file_actions.delete') }}
                                        </button>
                                    </form>
                                </li>
                            </ul>
                        </div>
                    </div>
                    
                    <!-- File Details -->
                    <small class="text-muted">
                        {% if file.file_size > 1024*1024 %}
                            {{ (file.file_size / (1024*1024))|round(1) }} MB
                        {% else %}
                            {{ (file.file_size / 1024)|round(1) }} KB
                        {% endif %}
                        <br>
                        {{ _('files.index.labels.uploaded_by', name=file.uploader.full_name) }}<br>
                        {{ file.created_at.strftime('%d.%m.%Y %H:%M') }}
                    </small>
                </div>
            </div>
        </div>
        {% endfor %}
        {% endif %}
    </div>
</div>

<!-- Inline Folder Creation (List View) -->
<div id="inlineFolderCreateList" class="list-group mb-4" style="display: none;">
    <div class="list-group-item">
        <div class="d-flex align-items-center">
            <i class="bi bi-folder-fill text-warning fs-4 me-3"></i>
            <form method="POST" action="{{ url_for('files.create_folder') }}" class="inline-create-form d-flex flex-grow-1 align-items-center gap-2">
                <input type="hidden" name="parent_id" value="{{ current_folder.id if current_folder else '' }}">
                <input type="text" class="form-control form-control-sm" name="folder_name" placeholder="{{ _('files.index.inline.folder_name_placeholder') }}" required autofocus>
                <button type="submit" class="btn btn-sm btn-accent">
                    <i class="bi bi-check"></i> {{ _('common.create') }}
                </button>
                <button type="button" class="btn btn-sm btn-secondary cancel-inline-create">
                    <i class="bi bi-x"></i> {{ _('common.cancel') }}
                </button>
            </form>
        </div>
    </div>
</div>

<!-- Inline File Creation (List View) -->
<div id="inlineFileCreateList" class="list-group mb-4" style="display: none;">
    <div class="list-group-item">
        <div class="d-flex align-items-center">
            <i class="bi bi-file-earmark fs-4 text-primary me-3" id="inlineFileIconList"></i>
            <form method="POST" class="inline-create-form d-flex flex-grow-1 align-items-center gap-2" id="inlineFileFormList">
                <input type="hidden" name="folder_id" value="{{ current_folder.id if current_folder else '' }}">
                <input type="text" class="form-control form-control-sm" name="filename" placeholder="{{ _('files.index.inline.file_name_placeholder') }}" required autofocus>
                <button type="submit" class="btn btn-sm btn-accent">
                    <i class="bi bi-check"></i> {{ _('common.create') }}
                </button>
                <button type="button" class="btn btn-sm btn-secondary cancel-inline-create">
                    <i class="bi bi-x"></i> {{ _('common.cancel') }}
                </button>
            </form>
        </div>
    </div>
</div>

<!-- ============================================ -->
<!-- LIST VIEW - ORDNER Sektion (IMMER sichtbar) -->
<!-- ============================================ -->
<div id="listViewContainer" style="display: none;">
    <!-- Ordner Überschrift - IMMER anzeigen -->
    <h5 class="mb-3">{{ _('files.index.sections.folders') }}</h5>

    <!-- Folders List View -->
    <div id="foldersListView" class="list-group mb-4">
        {% if subfolders %}
        {% for folder in subfolders %}
        <div class="list-group-item d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center" onclick="location.href='{{ url_for('files.browse_folder', folder_id=folder.id) }}'" style="cursor: pointer;">
                <i class="bi bi-folder-fill text-warning fs-4 me-3"></i>
                <span class="fw-medium">{{ folder.name }}</span>
            </div>
            <div class="dropdown">
                <button class="btn btn-sm btn-link" data-bs-toggle="dropdown">
                    <i class="bi bi-three-dots-vertical"></i>
                </button>
                <ul class="dropdown-menu">
                    {% if files_dropbox_enabled and folder.is_dropbox %}
                    <li>
                        <a class="dropdown-item" href="#" onclick="openDropboxSettings({{ folder.id }}); return false;">
                            <i class="bi bi-gear"></i> {{ _('files.index.folder_actions.dropbox_edit') }}
                        </a>
                    </li>
                    {% elif files_dropbox_enabled %}
                    <li>
                        <form method="POST" action="{{ url_for('files.make_dropbox', folder_id=folder.id) }}" class="d-inline">
                            <button type="submit" class="dropdown-item">
                                <i class="bi bi-mailbox"></i> {{ _('files.index.folder_actions.dropbox_make') }}
                            </button>
                        </form>
                    </li>
                    {% endif %}
                    {% if files_sharing_enabled %}
                    <li><hr class="dropdown-divider"></li>
                    {% if folder.share_enabled %}
                    <li>
                        <a class="dropdown-item" href="#" onclick="openShareSettings('folder', {{ folder.id }}); return false;">
                            <i class="bi bi-gear"></i> {{ _('files.index.folder_actions.share_edit') }}
                        </a>
                    </li>
                    <li>
                        <form method="POST" action="{{ url_for('files.update_folder_share', folder_id=folder.id) }}" class="d-inline">
                            <input type="hidden" name="action" value="disable">
                            <button type="submit" class="dropdown-item">
                                <i class="bi bi-slash-circle"></i> {{ _('files.index.folder_actions.share_disable') }}
                            </button>
                        </form>
                    </li>
                    {% else %}
                    <li>
                        <a class="dropdown-item" href="#" onclick="openShareDialog('folder', {{ folder.id }}); return false;">
                            <i class="bi bi-share"></i> {{ _('files.index.folder_actions.share') }}
                        </a>
                    </li>
                    {% endif %}
                    {% endif %}
                    <li><hr class="dropdown-divider"></li>
                    <li>
                        <form method="POST" action="{{ url_for('files.rename_folder', folder_id=folder.id) }}" class="d-inline" onsubmit="return confirm('{{ _('files.index.alerts.rename_folder') }}');">
                            <input type="hidden" name="new_name" value="{{ folder.name }}">
                            <button type="submit" class="dropdown-item">
                                <i class="bi bi-pencil"></i> {{ _('files.index.folder_actions.rename') }}
                            </button>
                        </form>
                    </li>
                    <li>
                        <form method="POST" action="{{ url_for('files.delete_folder', folder_id=folder.id) }}" class="d-inline">
                            <button type="submit" class="dropdown-item text-danger" data-confirm-delete="{{ _('files.index.alerts.delete_folder') }}">
                                <i class="bi bi-trash"></i> {{ _('files.index.folder_actions.delete') }}
                            </button>
                        </form>
                    </li>
                </ul>
            </div>
        </div>
        {% endfor %}
        {% endif %}
    </div>

    <!-- ============================================ -->
    <!-- LIST VIEW - DATEIEN Sektion (IMMER sichtbar) -->
    <!-- ============================================ -->
    
    <!-- Dateien Überschrift - IMMER anzeigen -->
    <h5 class="mb-3">{{ _('files.index.sections.files') }}</h5>

    <!-- List View -->
    <div id="listView" class="list-group">
    {% if files %}
    {% for file in files %}
        <div class="list-group-item">
            <div class="d-flex w-100 justify-content-between align-items-center">
                <div class="d-flex align-items-center flex-grow-1" 
                 {% set file_ext = file.name[file.name.rfind('.'):] if '.' in file.name else '' %}
                 {% if file.name.endswith(('.md', '.markdown')) %}
                 onclick="location.href='{{ url_for('files.view_file', file_id=file.id) }}'" style="cursor: pointer;"
                 {% elif onlyoffice_available and file_ext.lower() in ['.docx', '.doc', '.odt', '.rtf', '.txt', '.xlsx', '.xls', '.ods', '.csv', '.pptx', '.ppt', '.odp', '.pdf'] %}
                 onclick="location.href='{{ url_for('files.edit_onlyoffice', file_id=file.id) }}'" style="cursor: pointer;"
                 {% elif file.name.endswith('.txt') %}
                 onclick="location.href='{{ url_for('files.view_file', file_id=file.id) }}'" style="cursor: pointer;"
                 {% elif file.name.endswith('.pdf') %}
                 onclick="location.href='{{ url_for('files.view_file', file_id=file.id) }}'" style="cursor: pointer;"
                 {% else %}
                 onclick="location.href='{{ url_for('files.download_file', file_id=file.id) }}'" style="cursor: pointer;"
                 {% endif %}>
                <!-- File Icon -->
                <div class="me-3">
                    {% if file.name.endswith(('.md', '.markdown')) %}
                    <img src="{{ url_for('static', filename='img/markdown.png') }}" alt="Markdown" class="file-type-icon-small" style="height: 32px; width: auto;" onerror="this.style.display='none'; this.nextElementSibling.style.display='inline-block';">
                    <i class="bi bi-file-earmark-text fs-4 text-info" style="display: none;"></i>
                    {% elif file.name.endswith('.txt') %}
                    <i class="bi bi-file-earmark-text fs-4 text-secondary"></i>
                    {% elif file.name.endswith(('.jpg', '.jpeg', '.png', '.gif', '.webp')) %}
                    <img src="{{ url_for('files.download_file', file_id=file.id) }}" alt="Bild" class="file-thumbnail" style="height: 32px; width: auto; max-width: 48px; object-fit: cover; border-radius: 4px;" onerror="this.style.display='none'; this.nextElementSibling.style.display='inline-block';">
                    <i class="bi bi-file-earmark-image fs-4 text-success" style="display: none;"></i>
                    {% elif file.name.endswith('.pdf') %}
                    <img src="{{ url_for('static', filename='img/PDF.png') }}" alt="PDF" class="file-type-icon-small" style="height: 32px; width: auto;" onerror="this.style.display='none'; this.nextElementSibling.style.display='inline-block';">
                    <i class="bi bi-file-earmark-pdf fs-4 text-danger" style="display: none;"></i>
                    {% elif file.name.endswith('.docx') %}
                    <img src="{{ url_for('static', filename='img/docx.png') }}" alt="DOCX" class="file-type-icon-small" style="height: 32px; width: auto;" onerror="this.style.display='none'; this.nextElementSibling.style.display='inline-block';">
                    <i class="bi bi-file-earmark-word fs-4 text-primary" style="display: none;"></i>
                    {% elif file.name.endswith('.xlsx') %}
                    <img src="{{ url_for('static', filename='img/xlsx.png') }}" alt="XLSX" class="file-type-icon-small" style="height: 32px; width: auto;" onerror="this.style.display='none'; this.nextElementSibling.style.display='inline-block';">
                    <i class="bi bi-file-earmark-spreadsheet fs-4 text-success" style="display: none;"></i>
                    {% elif file.name.endswith('.pptx') %}
                    <img src="{{ url_for('static', filename='img/pptx.png') }}" alt="PPTX" class="file-type-icon-small" style="height: 32px; width: auto;" onerror="this.style.display='none'; this.nextElementSibling.style.display='inline-block';">
                    <i class="bi bi-file-earmark-slides fs-4 text-warning" style="display: none;"></i>
                    {% else %}
                    <i class="bi bi-file-earmark fs-4 text-primary"></i>
                    {% endif %}
                </div>
                
                <!-- File Name -->
                <div class="flex-grow-1">
                    <h6 class="mb-0 fw-medium">
                        {{ file.name }}
                        {% if file.version_number > 1 %}
                        <span class="badge bg-info ms-1">v{{ file.version_number }}</span>
                        {% endif %}
                    </h6>
                </div>
            </div>
            
            <!-- Details Button -->
            <div class="dropdown" onclick="event.stopPropagation()">
                <button class="btn btn-sm btn-link" data-bs-toggle="dropdown">
                    <i class="bi bi-three-dots-vertical"></i>
                </button>
                <ul class="dropdown-menu dropdown-menu-end">
                    <li><a class="dropdown-item" href="{{ url_for('files.download_file', file_id=file.id) }}">
                        <i class="bi bi-download"></i> {{ _('files.index.file_actions.download') }}
                    </a></li>
                    {% if onlyoffice_available %}
                        {% set file_ext = file.name[file.name.rfind('.'):] if '.' in file.name else '' %}
                        {% if file_ext.lower() in ['.docx', '.doc', '.odt', '.rtf', '.txt', '.xlsx', '.xls', '.ods', '.csv', '.pptx', '.ppt', '.odp', '.pdf', '.md', '.markdown'] %}
                    <li><a class="dropdown-item" href="{{ url_for('files.edit_onlyoffice', file_id=file.id) }}" target="_blank" rel="noopener noreferrer">
                        <i class="bi bi-file-earmark-text"></i> {{ _('files.index.file_actions.edit_onlyoffice') }}
                    </a></li>
                    <li><hr class="dropdown-divider"></li>
                        {% endif %}
                    {% endif %}
                    {% if file.name.endswith('.pdf') %}
                    <li><a class="dropdown-item" href="{{ url_for('files.view_file', file_id=file.id) }}">
                        <i class="bi bi-eye"></i> {{ _('files.index.file_actions.view') }}
                    </a></li>
                    {% endif %}
                    {% if file.name.endswith(('.txt', '.md')) %}
                    <li><a class="dropdown-item" href="{{ url_for('files.view_file', file_id=file.id) }}">
                        <i class="bi bi-eye"></i> {{ _('files.index.file_actions.view') }}
                    </a></li>
                    <li><a class="dropdown-item" href="{{ url_for('files.edit_file', file_id=file.id) }}">
                        <i class="bi bi-pencil"></i> {{ _('files.index.file_actions.edit') }}
                    </a></li>
                    {% endif %}
                    <li><hr class="dropdown-divider"></li>
                    {% if files_sharing_enabled %}
                    {% if file.share_enabled %}
                    <li><a class="dropdown-item" href="#" onclick="openShareSettings('file', {{ file.id }}); return false;">
                        <i class="bi bi-gear"></i> {{ _('files.index.file_actions.share_edit') }}
                    </a></li>
                    <li>
                        <form method="POST" action="{{ url_for('files.update_file_share', file_id=file.id) }}" class="d-inline">
                            <input type="hidden" name="action" value="disable">
                            <button type="submit" class="dropdown-item">
                                <i class="bi bi-slash-circle"></i> {{ _('files.index.file_actions.share_disable') }}
                            </button>
                        </form>
                    </li>
                    {% else %}
                    <li><a class="dropdown-item" href="#" onclick="openShareDialog('file', {{ file.id }}); return false;">
                        <i class="bi bi-share"></i> {{ _('files.index.file_actions.share') }}
                    </a></li>
                    {% endif %}
                    {% endif %}
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item" href="#" onclick="openFileDetails({{ file.id }})">
                        <i class="bi bi-info-circle"></i> {{ _('files.index.file_actions.details') }}
                    </a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li>
                        <form method="POST" action="{{ url_for('files.delete_file', file_id=file.id) }}" class="d-inline">
                            <button type="submit" class="dropdown-item text-danger" data-confirm-delete="{{ _('files.index.alerts.delete_file') }}">
                                <i class="bi bi-trash"></i> {{ _('files.index.file_actions.delete') }}
                            </button>
                        </form>
                    </li>
                </ul>
            </div>
        </div>
    </div>
    {% endfor %}
    {% endif %}
    </div>
</div>

{% if not subfolders and not files %}
<div class="alert alert-info">
    <i class="bi bi-info-circle"></i>
    {{ _('files.index.labels.empty_folder') }}
</div>
{% endif %}

<!-- Create Modal -->
<div class="modal fade" id="createModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">{{ _('files.index.modals.create_entry.title') }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="d-grid gap-2">
                    <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#createFileModal" data-bs-dismiss="modal">
                        <i class="bi bi-file-earmark-text"></i> {{ _('files.index.modals.create_entry.markdown_button') }}
                    </button>
                    <button class="btn btn-outline-warning" data-bs-toggle="modal" data-bs-target="#newFolderModal" data-bs-dismiss="modal">
                        <i class="bi bi-folder-plus"></i> {{ _('files.index.modals.create_entry.folder_button') }}
                    </button>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _('common.cancel') }}</button>
            </div>
        </div>
    </div>
</div>

<!-- Create MD File Modal -->
<div class="modal fade" id="createFileModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">{{ _('files.index.modals.markdown.title') }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('files.create_file') }}">
                <div class="modal-body">
                    <input type="hidden" name="folder_id" value="{{ current_folder.id if current_folder else '' }}">
                    <input type="hidden" name="file_type" value="md">
                    <div class="mb-3">
                        <label for="md_filename" class="form-label">{{ _('files.index.modals.markdown.filename_label') }}</label>
                        <input type="text" class="form-control" id="md_filename" name="filename" required>
                    </div>
                    <div class="mb-3">
                        <label for="md_content" class="form-label">{{ _('files.index.modals.markdown.content_label') }}</label>
                        <textarea class="form-control" id="md_content" name="content" rows="8" placeholder="{{ _('files.index.modals.markdown.placeholder') }}"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _('common.cancel') }}</button>
                    <button type="submit" class="btn btn-accent">{{ _('common.create') }}</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Upload Modal -->
<div class="modal fade" id="uploadModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">{{ _('files.index.modals.upload.title') }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('files.upload_file') }}" enctype="multipart/form-data" id="uploadForm">
                <div class="modal-body">
                    <input type="hidden" name="folder_id" value="{{ current_folder.id if current_folder else '' }}">
                    <div class="mb-3">
                        <label for="file" class="form-label">{{ _('files.index.modals.upload.file_label') }}</label>
                        <input type="file" class="form-control" id="file" name="file">
                        <div class="form-text">{{ _('files.index.modals.upload.file_help') }}</div>
                    </div>
                    <div class="mb-3">
                        <label for="folder_upload" class="form-label">{{ _('files.index.modals.upload.folder_label') }}</label>
                        <input type="file" class="form-control" id="folder_upload" name="folder_upload" webkitdirectory directory multiple>
                        <div class="form-text">{{ _('files.index.modals.upload.folder_help') }}</div>
                    </div>
                    <div class="progress mb-3" style="display: none;" id="uploadProgress">
                        <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _('common.cancel') }}</button>
                    <button type="submit" class="btn btn-accent" id="uploadBtn">{{ _('files.index.buttons.upload') }}</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- New Folder Modal -->
<div class="modal fade" id="newFolderModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">{{ _('files.index.modals.new_folder.title') }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('files.create_folder') }}">
                <div class="modal-body">
                    <input type="hidden" name="parent_id" value="{{ current_folder.id if current_folder else '' }}">
                    <div class="mb-3">
                        <label for="folder_name" class="form-label">{{ _('files.index.modals.new_folder.name_label') }}</label>
                        <input type="text" class="form-control" id="folder_name" name="folder_name" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _('common.cancel') }}</button>
                    <button type="submit" class="btn btn-accent">{{ _('common.create') }}</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Side Menu für Datei-Details -->
<div class="side-menu-backdrop" id="sideMenuBackdrop" onclick="closeFileDetails()"></div>
<div class="side-menu" id="sideMenu">
    <div class="side-menu-header">
        <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0" id="sideMenuTitle">{{ _('files.index.modals.side_menu.title') }}</h5>
            <button type="button" class="btn-close" onclick="closeFileDetails()"></button>
        </div>
    </div>
    <div class="side-menu-content" id="sideMenuContent">
        <!-- Inhalt wird dynamisch geladen -->
    </div>
</div>

<!-- Briefkasten Einstellungen Modal -->
<div class="modal fade" id="dropboxSettingsModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Briefkasten bearbeiten</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="dropboxSettingsContent">
                <div class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">{{ _('files.index.messages.progress') }}</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* Dropdown Menu Positioning */
#newButtonDropdown {
    position: relative;
}

#newDropdownMenu {
    position: absolute;
    top: 100%;
    left: 0;
    margin-top: 0.5rem;
    min-width: 200px;
    z-index: 1000;
    background: white;
    border: 1px solid rgba(0,0,0,.15);
    border-radius: 0.375rem;
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
    padding: 0.5rem 0;
    max-height: calc(100vh - 100px);
    overflow-y: auto;
}

/* Dark Mode Dropdown Menu */
[data-bs-theme="dark"] #newDropdownMenu {
    background: #2d3748;
    border-color: #4a5568;
    color: #e2e8f0;
}

/* OLED Mode - Dropdown Menu (Neu-Menü) */
[data-oled-mode="true"] #newDropdownMenu {
    background: #000000 !important;
    border: 1px solid #1a1a1a !important;
    color: #ffffff !important;
}

[data-oled-mode="true"] #newDropdownMenu .dropdown-item {
    color: #ffffff !important;
    background-color: transparent !important;
}

[data-oled-mode="true"] #newDropdownMenu .dropdown-item:hover {
    background-color: #0a0a0a !important;
    color: #ffffff !important;
}

/* Hauptmenü nach rechts positionieren wenn kein Platz links */
#newDropdownMenu.position-right {
    left: auto;
    right: 0;
}
</style>

<script>
const FILES_I18N = {{ current_translations.get('files', {}).get('index', {})|tojson }};
document.addEventListener('DOMContentLoaded', function() {
    // NEU Button Dropdown mit Hover-Funktionalität
    const newButton = document.getElementById('newButton');
    const newDropdownMenu = document.getElementById('newDropdownMenu');
    const uploadFileMenuItem = document.getElementById('uploadFileMenuItem');
    const uploadFolderMenuItem = document.getElementById('uploadFolderMenuItem');
    const directFileUpload = document.getElementById('directFileUpload');
    const directFolderUpload = document.getElementById('directFolderUpload');
    
    let hoverTimeout = null;
    let isMenuOpen = false;
    
    // Funktion zur Anpassung der Menü-Positionierung
    function adjustMenuPosition() {
        if (!newDropdownMenu || !newButton) return;
        
        // Positioniere Hauptmenü horizontal
        const buttonRect = newButton.getBoundingClientRect();
        const menuWidth = newDropdownMenu.offsetWidth || 200;
        const menuHeight = newDropdownMenu.offsetHeight || 300;
        const viewportWidth = window.innerWidth;
        const viewportHeight = window.innerHeight;
        
        // Horizontal: Wenn nicht genug Platz rechts ist, positioniere nach rechts
        if (buttonRect.left + menuWidth > viewportWidth - 20) {
            newDropdownMenu.classList.add('position-right');
        } else {
            newDropdownMenu.classList.remove('position-right');
        }
        
        // Vertikal: Wenn nicht genug Platz unten ist, positioniere nach oben
        if (buttonRect.bottom + menuHeight > viewportHeight - 20) {
            newDropdownMenu.style.top = 'auto';
            newDropdownMenu.style.bottom = '100%';
            newDropdownMenu.style.marginTop = '0';
            newDropdownMenu.style.marginBottom = '0.5rem';
        } else {
            newDropdownMenu.style.top = '100%';
            newDropdownMenu.style.bottom = 'auto';
            newDropdownMenu.style.marginTop = '0.5rem';
            newDropdownMenu.style.marginBottom = '0';
        }
    }
    
    // Hover-Timeout für 2 Sekunden
    if (newButton && newDropdownMenu) {
        newButton.addEventListener('mouseenter', function() {
            clearTimeout(hoverTimeout);
            hoverTimeout = setTimeout(function() {
                if (!isMenuOpen) {
                    newDropdownMenu.style.display = 'block';
                    isMenuOpen = true;
                    // Position anpassen nach dem Anzeigen
                    setTimeout(adjustMenuPosition, 10);
                }
            }, 2000); // 2 Sekunden
        });
        
        newButton.addEventListener('mouseleave', function() {
            clearTimeout(hoverTimeout);
        });
        
        // Menü offen halten beim Hovern über das Menü
        newDropdownMenu.addEventListener('mouseenter', function() {
            clearTimeout(hoverTimeout);
        });
        
        newDropdownMenu.addEventListener('mouseleave', function() {
            hoverTimeout = setTimeout(function() {
                newDropdownMenu.style.display = 'none';
                isMenuOpen = false;
            }, 300);
        });
        
        // Klick auf Button öffnet/schließt auch das Menü
        newButton.addEventListener('click', function(e) {
            e.stopPropagation();
            if (isMenuOpen) {
                newDropdownMenu.style.display = 'none';
                isMenuOpen = false;
            } else {
                newDropdownMenu.style.display = 'block';
                isMenuOpen = true;
                // Position anpassen nach dem Anzeigen
                setTimeout(adjustMenuPosition, 10);
            }
        });
        
        // Schließe Menü beim Klicken außerhalb
        document.addEventListener('click', function(e) {
            if (!newButtonDropdown.contains(e.target)) {
                newDropdownMenu.style.display = 'none';
                isMenuOpen = false;
            }
        });
    }
    
    // Position beim Resize anpassen
    window.addEventListener('resize', function() {
        if (isMenuOpen) {
            adjustMenuPosition();
        }
    });
    
    // Position beim Scroll anpassen
    window.addEventListener('scroll', function() {
        if (isMenuOpen) {
            adjustMenuPosition();
        }
    }, true);
    
    // Regelmäßige Position-Überprüfung wenn Menü geöffnet ist
    setInterval(function() {
        if (isMenuOpen && newDropdownMenu.style.display === 'block') {
            adjustMenuPosition();
        }
    }, 100);
    
    // Direkter Upload-Dialog beim Klick auf "Dateien hochladen"
    if (uploadFileMenuItem) {
        uploadFileMenuItem.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            // Schließe das Dropdown-Menü
            newDropdownMenu.style.display = 'none';
            isMenuOpen = false;
            
            // Öffne direkt den File-Dialog für Dateien
            directFileUpload.click();
        });
    }
    
    // Direkter Upload-Dialog beim Klick auf "Ordner hochladen"
    if (uploadFolderMenuItem) {
        uploadFolderMenuItem.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            // Schließe das Dropdown-Menü
            newDropdownMenu.style.display = 'none';
            isMenuOpen = false;
            
            // Öffne direkt den File-Dialog für Ordner
            directFolderUpload.click();
        });
    }
    
    // Handle file upload - verwende FormData für direkten Upload
    if (directFileUpload) {
        directFileUpload.addEventListener('change', function() {
            if (this.files.length > 0) {
                // Erstelle FormData für Upload
                const formData = new FormData();
                formData.append('folder_id', '{{ current_folder.id if current_folder else "" }}');
                
                // Füge alle Dateien hinzu
                for (let i = 0; i < this.files.length; i++) {
                    formData.append('file', this.files[i]);
                }
                
                // Sende via Fetch
                fetch('{{ url_for("files.upload_file") }}', {
                    method: 'POST',
                    body: formData
                }).then(response => {
                    if (response.redirected) {
                        window.location.href = response.url;
                    } else {
                        return response.text();
                    }
                }).then(html => {
                    if (html) {
                        // Wenn keine Weiterleitung, Seite neu laden
                        window.location.reload();
                    }
                }).catch(error => {
                    console.error('Upload error:', error);
                    alert(FILES_I18N.messages.upload_error);
                });
                
                // Reset input
                this.value = '';
            }
        });
    }
    
    // Handle folder upload - verwende FormData für direkten Upload
    if (directFolderUpload) {
        directFolderUpload.addEventListener('change', function() {
            if (this.files.length > 0) {
                // Erstelle FormData für Upload
                const formData = new FormData();
                formData.append('folder_id', '{{ current_folder.id if current_folder else "" }}');
                
                // Füge alle Dateien hinzu (Ordner-Upload)
                for (let i = 0; i < this.files.length; i++) {
                    formData.append('folder_upload', this.files[i]);
                }
                
                // Sende via Fetch
                fetch('{{ url_for("files.upload_file") }}', {
                    method: 'POST',
                    body: formData
                }).then(response => {
                    if (response.redirected) {
                        window.location.href = response.url;
                    } else {
                        return response.text();
                    }
                }).then(html => {
                    if (html) {
                        // Wenn keine Weiterleitung, Seite neu laden
                        window.location.reload();
                    }
                }).catch(error => {
                    console.error('Upload error:', error);
                    alert(FILES_I18N.messages.upload_folder_error);
                });
                
                // Reset input
                this.value = '';
            }
        });
    }
    
    // Inline-Erstellung Funktionen
    function showInlineCreate(type, fileType) {
        // Schließe Dropdown-Menü
        newDropdownMenu.style.display = 'none';
        isMenuOpen = false;
        
        // Bestimme aktuelle Ansicht
        const isGridView = gridViewBtn.classList.contains('active');
        
        if (type === 'folder') {
            // Zeige Inline-Ordner-Erstellung
            if (isGridView) {
                document.getElementById('inlineFolderCreateGrid').style.display = 'block';
            } else {
                document.getElementById('inlineFolderCreateList').style.display = 'block';
            }
            // Fokus auf Eingabefeld
            setTimeout(function() {
                const input = document.querySelector('#inlineFolderCreateGrid input[name="folder_name"], #inlineFolderCreateList input[name="folder_name"]');
                if (input) input.focus();
            }, 100);
        } else if (type === 'file') {
            // Zeige Inline-Datei-Erstellung
            const formGrid = document.getElementById('inlineFileForm');
            const formList = document.getElementById('inlineFileFormList');
            const iconGrid = document.getElementById('inlineFileIcon');
            const iconList = document.getElementById('inlineFileIconList');
            
            // Setze Formular-Action und Icon basierend auf Dateityp
            let actionUrl = '';
            let iconClass = '';
            let placeholder = FILES_I18N.inline.file_name_placeholder;
            
            if (fileType === 'docx') {
                actionUrl = '{{ url_for("files.create_office_file") }}';
                iconClass = 'bi-file-earmark-word text-primary';
                placeholder = FILES_I18N.inline.word_name_placeholder;
            } else if (fileType === 'xlsx') {
                actionUrl = '{{ url_for("files.create_office_file") }}';
                iconClass = 'bi-file-earmark-spreadsheet text-success';
                placeholder = FILES_I18N.inline.excel_name_placeholder;
            } else if (fileType === 'pptx') {
                actionUrl = '{{ url_for("files.create_office_file") }}';
                iconClass = 'bi-file-earmark-slides text-warning';
                placeholder = FILES_I18N.inline.powerpoint_name_placeholder;
            } else if (fileType === 'md') {
                actionUrl = '{{ url_for("files.create_file") }}';
                iconClass = 'bi-file-earmark-text text-info';
                placeholder = FILES_I18N.inline.markdown_name_placeholder;
            }
            
            if (formGrid && formList) {
                formGrid.action = actionUrl;
                formList.action = actionUrl;
                
                // Füge file_type hinzu wenn Office-Datei
                if (fileType === 'docx' || fileType === 'xlsx' || fileType === 'pptx') {
                    let typeInputGrid = formGrid.querySelector('input[name="file_type"]');
                    let typeInputList = formList.querySelector('input[name="file_type"]');
                    if (!typeInputGrid) {
                        typeInputGrid = document.createElement('input');
                        typeInputGrid.type = 'hidden';
                        typeInputGrid.name = 'file_type';
                        formGrid.appendChild(typeInputGrid);
                    }
                    if (!typeInputList) {
                        typeInputList = document.createElement('input');
                        typeInputList.type = 'hidden';
                        typeInputList.name = 'file_type';
                        formList.appendChild(typeInputList);
                    }
                    typeInputGrid.value = fileType;
                    typeInputList.value = fileType;
                } else if (fileType === 'md') {
                    let typeInputGrid = formGrid.querySelector('input[name="file_type"]');
                    let typeInputList = formList.querySelector('input[name="file_type"]');
                    if (!typeInputGrid) {
                        typeInputGrid = document.createElement('input');
                        typeInputGrid.type = 'hidden';
                        typeInputGrid.name = 'file_type';
                        formGrid.appendChild(typeInputGrid);
                    }
                    if (!typeInputList) {
                        typeInputList = document.createElement('input');
                        typeInputList.type = 'hidden';
                        typeInputList.name = 'file_type';
                        formList.appendChild(typeInputList);
                    }
                    typeInputGrid.value = 'md';
                    typeInputList.value = 'md';
                }
                
                // Setze Placeholder
                formGrid.querySelector('input[name="filename"]').placeholder = placeholder;
                formList.querySelector('input[name="filename"]').placeholder = placeholder;
                
                // Setze Icon
                if (iconGrid) iconGrid.className = 'bi ' + iconClass + ' fs-1';
                if (iconList) iconList.className = 'bi ' + iconClass + ' fs-4';
            }
            
            if (isGridView) {
                document.getElementById('inlineFileCreateGrid').style.display = 'block';
            } else {
                document.getElementById('inlineFileCreateList').style.display = 'block';
            }
            
            // Fokus auf Eingabefeld
            setTimeout(function() {
                const input = document.querySelector('#inlineFileCreateGrid input[name="filename"], #inlineFileCreateList input[name="filename"]');
                if (input) input.focus();
            }, 100);
        }
    }
    
    // Event Listener für Erstellungs-Optionen
    document.getElementById('createFolderMenuItem')?.addEventListener('click', function(e) {
        e.preventDefault();
        showInlineCreate('folder');
    });
    
    document.getElementById('createMdMenuItem')?.addEventListener('click', function(e) {
        e.preventDefault();
        showInlineCreate('file', 'md');
    });
    
    // Office-Dateien
    document.querySelectorAll('[data-create-type]').forEach(function(item) {
        item.addEventListener('click', function(e) {
            e.preventDefault();
            const fileType = this.getAttribute('data-create-type');
            showInlineCreate('file', fileType);
        });
    });
    
    // Abbrechen-Buttons
    document.querySelectorAll('.cancel-inline-create').forEach(function(btn) {
        btn.addEventListener('click', function() {
            document.getElementById('inlineFolderCreateGrid').style.display = 'none';
            document.getElementById('inlineFolderCreateList').style.display = 'none';
            document.getElementById('inlineFileCreateGrid').style.display = 'none';
            document.getElementById('inlineFileCreateList').style.display = 'none';
        });
    });
    
    // ESC-Taste zum Abbrechen
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            const isVisible = document.getElementById('inlineFolderCreateGrid').style.display === 'block' ||
                             document.getElementById('inlineFolderCreateList').style.display === 'block' ||
                             document.getElementById('inlineFileCreateGrid').style.display === 'block' ||
                             document.getElementById('inlineFileCreateList').style.display === 'block';
            if (isVisible) {
                document.getElementById('inlineFolderCreateGrid').style.display = 'none';
                document.getElementById('inlineFolderCreateList').style.display = 'none';
                document.getElementById('inlineFileCreateGrid').style.display = 'none';
                document.getElementById('inlineFileCreateList').style.display = 'none';
            }
        }
    });
    
    // View mode toggle
    const listViewBtn = document.getElementById('listViewBtn');
    const gridViewBtn = document.getElementById('gridViewBtn');
    const listViewContainer = document.getElementById('listViewContainer');
    const gridViewContainer = document.getElementById('gridViewContainer');
    
    if (listViewBtn && gridViewBtn) {
        listViewBtn.addEventListener('click', function() {
            // List View Container ANZEIGEN
            if (listViewContainer) {
                listViewContainer.style.display = 'block';
            }
            
            // Grid View Container AUSBLENDEN
            if (gridViewContainer) {
                gridViewContainer.style.display = 'none';
            }
            
            // Switch inline creation views
            const inlineFolderGrid = document.getElementById('inlineFolderCreateGrid');
            const inlineFolderList = document.getElementById('inlineFolderCreateList');
            const inlineFileGrid = document.getElementById('inlineFileCreateGrid');
            const inlineFileList = document.getElementById('inlineFileCreateList');
            
            if (inlineFolderGrid && inlineFolderGrid.style.display === 'block') {
                inlineFolderGrid.style.display = 'none';
                if (inlineFolderList) inlineFolderList.style.display = 'block';
            }
            if (inlineFileGrid && inlineFileGrid.style.display === 'block') {
                inlineFileGrid.style.display = 'none';
                if (inlineFileList) inlineFileList.style.display = 'block';
            }
            
            listViewBtn.classList.add('active');
            gridViewBtn.classList.remove('active');
            localStorage.setItem('filesViewMode', 'list');
        });
        
        gridViewBtn.addEventListener('click', function() {
            // Grid View Container ANZEIGEN - IMMER anzeigen, unabhängig von Ordnern oder Dateien!
            if (gridViewContainer) {
                gridViewContainer.style.display = 'block';
            }
            
            // List View Container AUSBLENDEN
            if (listViewContainer) {
                listViewContainer.style.display = 'none';
            }
            
            // Switch inline creation views
            const inlineFolderGrid = document.getElementById('inlineFolderCreateGrid');
            const inlineFolderList = document.getElementById('inlineFolderCreateList');
            const inlineFileGrid = document.getElementById('inlineFileCreateGrid');
            const inlineFileList = document.getElementById('inlineFileCreateList');
            
            if (inlineFolderList && inlineFolderList.style.display === 'block') {
                inlineFolderList.style.display = 'none';
                if (inlineFolderGrid) inlineFolderGrid.style.display = 'block';
            }
            if (inlineFileList && inlineFileList.style.display === 'block') {
                inlineFileList.style.display = 'none';
                if (inlineFileGrid) inlineFileGrid.style.display = 'block';
            }
            
            gridViewBtn.classList.add('active');
            listViewBtn.classList.remove('active');
            localStorage.setItem('filesViewMode', 'grid');
        });
        
        // Initialisiere Standard-Ansicht: Grid View ist Standard
        const savedViewMode = localStorage.getItem('filesViewMode');
        
        if (savedViewMode === 'list') {
            // List View aktivieren
            if (listViewContainer) {
                listViewContainer.style.display = 'block';
            }
            if (gridViewContainer) {
                gridViewContainer.style.display = 'none';
            }
            // Buttons
            listViewBtn.classList.add('active');
            gridViewBtn.classList.remove('active');
        } else {
            // Grid View ist Standard - IMMER anzeigen, unabhängig von Ordnern oder Dateien!
            if (gridViewContainer) {
                gridViewContainer.style.display = 'block';
            }
            if (listViewContainer) {
                listViewContainer.style.display = 'none';
            }
            // Buttons
            gridViewBtn.classList.add('active');
            listViewBtn.classList.remove('active');
        }
    }
    
    // File size validation
    const fileInput = document.getElementById('file');
    const folderInput = document.getElementById('folder_upload');
    const uploadForm = document.getElementById('uploadForm');
    const uploadBtn = document.getElementById('uploadBtn');
    const uploadProgress = document.getElementById('uploadProgress');
    const maxSize = 100 * 1024 * 1024; // 100MB in bytes
    
    function validateUpload() {
        let hasValidInput = false;
        
        // Check single file input
        if (fileInput && fileInput.files.length > 0) {
            const file = fileInput.files[0];
            if (file.size > maxSize) {
                alert(FILES_I18N.messages.file_too_large);
                fileInput.value = '';
                uploadBtn.disabled = true;
                return;
            }
            hasValidInput = true;
        }
        
        // Check folder input
        if (folderInput && folderInput.files.length > 0) {
            hasValidInput = true;
        }
        
        uploadBtn.disabled = !hasValidInput;
    }
    
    if (fileInput) {
        fileInput.addEventListener('change', function() {
            if (folderInput && folderInput.files.length > 0) {
                folderInput.value = '';
            }
            validateUpload();
        });
    }
    
    if (folderInput) {
        folderInput.addEventListener('change', function() {
            if (fileInput && fileInput.files.length > 0) {
                fileInput.value = '';
            }
            validateUpload();
        });
    }
    
    // Upload progress simulation
    if (uploadForm) {
        uploadForm.addEventListener('submit', function(e) {
            // Validate that at least one input has files
            if ((!fileInput || fileInput.files.length === 0) && 
                (!folderInput || folderInput.files.length === 0)) {
                e.preventDefault();
                alert(FILES_I18N.messages.select_prompt);
                return;
            }
            
            uploadProgress.style.display = 'block';
            uploadBtn.disabled = true;
            uploadBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Hochladen...';
            
            // Simulate progress (since we can't get real progress without AJAX)
            let progress = 0;
            const interval = setInterval(function() {
                progress += Math.random() * 15;
                if (progress >= 100) {
                    progress = 100;
                    clearInterval(interval);
                }
                uploadProgress.querySelector('.progress-bar').style.width = progress + '%';
            }, 200);
        });
    }
    
    // Mobile Optimierungen
    if (window.innerWidth <= 768) {
        // Größere Touch-Targets für mobile Geräte
        const dropdownToggles = document.querySelectorAll('button[data-bs-toggle="dropdown"], .dropdown-toggle');
        dropdownToggles.forEach(toggle => {
            toggle.style.minWidth = '44px';
            toggle.style.minHeight = '44px';
            toggle.style.padding = '8px 12px';
        });
        
        // Bessere Scroll-Performance auf mobilen Geräten
        document.body.style.webkitOverflowScrolling = 'touch';
        
        // Hinweis: Kein globales preventDefault auf Buttons –
        // das blockiert Click/Modal-Trigger auf mobilen Geräten.
        // Doppeltap-Zoom wird stattdessen über CSS `touch-action: manipulation` gelöst.
        
        // Mobile Dropdown - Komplett Custom Implementation
        const dropdowns = document.querySelectorAll('.dropdown');
        dropdowns.forEach(dropdown => {
            // Suche nach Button mit data-bs-toggle="dropdown" ODER .dropdown-toggle
            const toggle = dropdown.querySelector('button[data-bs-toggle="dropdown"], .dropdown-toggle');
            const menu = dropdown.querySelector('.dropdown-menu');
            
            if (toggle && menu) {
                // Bootstrap komplett deaktivieren
                toggle.removeAttribute('data-bs-toggle');
                toggle.removeAttribute('data-bs-auto-close');
                toggle.removeAttribute('data-bs-offset');
                
                // Custom Touch Handler
                let touchStartTime = 0;
                let touchStartY = 0;
                let touchStartX = 0;
                
                // Touch Start
                toggle.addEventListener('touchstart', function(e) {
                    touchStartTime = Date.now();
                    touchStartY = e.touches[0].clientY;
                    touchStartX = e.touches[0].clientX;
                    e.preventDefault();
                }, { passive: false });
                
                // Speichere ursprüngliches Parent-Element
                let originalParent = null;
                
                // Funktion zum Verschieben des Menüs an den Body (außerhalb des Stacking Contexts)
                function moveMenuToBody() {
                    if (menu.parentNode !== document.body) {
                        // Speichere die ursprüngliche Position für später
                        originalParent = menu.parentNode;
                        // Verschiebe das Menü an den Body
                        document.body.appendChild(menu);
                    }
                }
                
                // Funktion zum Zurückverschieben des Menüs
                function restoreMenuPosition() {
                    if (originalParent && menu.parentNode === document.body && !menu.classList.contains('show')) {
                        // Verschiebe das Menü zurück zum ursprünglichen Parent
                        originalParent.appendChild(menu);
                        originalParent = null;
                    }
                }
                
                // Touch End
                toggle.addEventListener('touchend', function(e) {
                    const touchEndTime = Date.now();
                    const touchDuration = touchEndTime - touchStartTime;
                    const touchEndY = e.changedTouches[0].clientY;
                    const touchEndX = e.changedTouches[0].clientX;
                    const touchDistance = Math.sqrt(
                        Math.pow(touchEndX - touchStartX, 2) + 
                        Math.pow(touchEndY - touchStartY, 2)
                    );
                    
                    // Nur bei kurzem Touch (< 300ms) und kleiner Bewegung (< 10px)
                    if (touchDuration < 300 && touchDistance < 10) {
                        e.preventDefault();
                        e.stopPropagation();
                        
                        // Toggle Menu
                        if (menu.classList.contains('show')) {
                            menu.classList.remove('show');
                            setTimeout(restoreMenuPosition, 300); // Warte auf Animation
                        } else {
                            // Schließe andere Dropdowns
                            document.querySelectorAll('.dropdown-menu.show').forEach(otherMenu => {
                                if (otherMenu !== menu) {
                                    otherMenu.classList.remove('show');
                                }
                            });
                            
                            // Verschiebe Menü an Body vor dem Öffnen
                            moveMenuToBody();
                            // Öffne dieses Dropdown
                            menu.classList.add('show');
                        }
                    }
                }, { passive: false });
                
                // Click Handler als Fallback
                toggle.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    // Toggle Menu
                    if (menu.classList.contains('show')) {
                        menu.classList.remove('show');
                        setTimeout(restoreMenuPosition, 300); // Warte auf Animation
                    } else {
                        // Schließe andere Dropdowns
                        document.querySelectorAll('.dropdown-menu.show').forEach(otherMenu => {
                            if (otherMenu !== menu) {
                                otherMenu.classList.remove('show');
                            }
                        });
                        
                        // Verschiebe Menü an Body vor dem Öffnen
                        moveMenuToBody();
                        // Öffne dieses Dropdown
                        menu.classList.add('show');
                    }
                });
                
                // Verhindere dass Menu schließt beim Klicken auf Items
                menu.addEventListener('click', function(e) {
                    e.stopPropagation();
                    // Wenn ein Dropdown-Item geklickt wird, Menü nach kurzer Verzögerung zurücksetzen
                    if (e.target.closest('.dropdown-item')) {
                        setTimeout(function() {
                            menu.classList.remove('show');
                            setTimeout(restoreMenuPosition, 300);
                        }, 100);
                    }
                });
                
                // Schließe beim Klicken außerhalb
                document.addEventListener('click', function(e) {
                    if (!dropdown.contains(e.target) && !menu.contains(e.target)) {
                        menu.classList.remove('show');
                        setTimeout(restoreMenuPosition, 300); // Warte auf Animation
                    }
                });
                
                // Schließe beim Touch außerhalb
                document.addEventListener('touchstart', function(e) {
                    if (!dropdown.contains(e.target) && !menu.contains(e.target)) {
                        menu.classList.remove('show');
                        setTimeout(restoreMenuPosition, 300); // Warte auf Animation
                    }
                });
            }
        });
    }
});

// Side Menu Funktionen
function openFileDetails(fileId) {
    const sideMenu = document.getElementById('sideMenu');
    const backdrop = document.getElementById('sideMenuBackdrop');
    const content = document.getElementById('sideMenuContent');
    const title = document.getElementById('sideMenuTitle');
    
    // Zeige Loading-Status
    content.innerHTML = `
        <div class="text-center py-4">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">{{ _('files.index.messages.progress') }}</span>
            </div>
            <p class="mt-2 text-muted">Lade Datei-Details...</p>
        </div>
    `;
    
    // Zeige das Side-Menü
    sideMenu.classList.add('show');
    backdrop.classList.add('show');
    document.body.style.overflow = 'hidden';
    
    // Lade echte Datei-Details
    fetch(`/files/api/file-details/${fileId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const file = data.file;
                const versions = data.versions;
                const actions = data.actions;
                
                const sideMenuLabels = FILES_I18N.modals.side_menu;
                content.innerHTML = `
                    <div class="mb-4">
                        <h6>${sideMenuLabels.info_title}</h6>
                        <div class="card">
                            <div class="card-body">
                                <p><strong>${sideMenuLabels.info_labels.name}:</strong> ${file.name}</p>
                                <p><strong>${sideMenuLabels.info_labels.size}:</strong> ${file.size}</p>
                                <p><strong>${sideMenuLabels.info_labels.type}:</strong> ${file.type}</p>
                                <p><strong>${sideMenuLabels.info_labels.uploader}:</strong> ${file.uploader}</p>
                                <p><strong>${sideMenuLabels.info_labels.created}:</strong> ${file.created_at}</p>
                                <p><strong>${sideMenuLabels.info_labels.version}:</strong> ${file.version}</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <h6>${sideMenuLabels.versions_title}</h6>
                        <div id="versionsList">
                            ${versions.length > 0 ? `
                                <div class="list-group">
                                    ${versions.map(version => `
                                        <div class="list-group-item d-flex justify-content-between align-items-center">
                                            <div>
                                                <i class="bi bi-clock-history me-2"></i>
                                                ${sideMenuLabels.version_label.replace('{number}', version.version_number)}${version.is_current ? sideMenuLabels.current_suffix : ''}
                                            </div>
                                            <a href="${version.download_url}" class="btn btn-sm btn-outline-primary">
                                                <i class="bi bi-download"></i> ${sideMenuLabels.download_button}
                                            </a>
                                        </div>
                                    `).join('')}
                                </div>
                            ` : `
                                <div class="alert alert-info">
                                    <i class="bi bi-info-circle"></i>
                                    ${sideMenuLabels.no_versions}
                                </div>
                            `}
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <h6>${sideMenuLabels.actions_title}</h6>
                        <div class="d-grid gap-2">
                            <a href="${actions.download_url}" class="btn btn-outline-primary">
                                <i class="bi bi-download"></i> ${sideMenuLabels.download}
                            </a>
                            ${actions.view_url ? `
                                <a href="${actions.view_url}" class="btn btn-outline-secondary">
                                    <i class="bi bi-eye"></i> ${sideMenuLabels.view}
                                </a>
                            ` : ''}
                            ${actions.edit_url ? `
                                <a href="${actions.edit_url}" class="btn btn-outline-secondary">
                                    <i class="bi bi-pencil"></i> ${sideMenuLabels.edit}
                                </a>
                            ` : ''}
                        </div>
                    </div>
                `;
            } else {
                content.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle"></i>
                        ${FILES_I18N.messages.file_details_error}
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Error loading file details:', error);
            content.innerHTML = `
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle"></i>
                    ${FILES_I18N.messages.file_details_error}: ${error.message}
                </div>
            `;
        });
}

function closeFileDetails() {
    const sideMenu = document.getElementById('sideMenu');
    const backdrop = document.getElementById('sideMenuBackdrop');
    
    sideMenu.classList.remove('show');
    backdrop.classList.remove('show');
    document.body.style.overflow = '';
}

// Briefkasten Einstellungen
function openDropboxSettings(folderId) {
    const modal = new bootstrap.Modal(document.getElementById('dropboxSettingsModal'));
    const content = document.getElementById('dropboxSettingsContent');
    const dropboxLabels = FILES_I18N.modals.dropbox;
    
    // Show loading
    content.innerHTML = `
        <div class="text-center py-4">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">${FILES_I18N.messages.progress}</span>
            </div>
        </div>
    `;
    
    modal.show();
    
    // Load settings
    fetch(`/files/folder/${folderId}/dropbox-settings`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const folder = data.folder;
                content.innerHTML = `
                    <div class="mb-4">
                        <h6>${dropboxLabels.link_label}</h6>
                        <div class="input-group">
                            <input type="text" class="form-control" id="dropboxUrl" value="${folder.dropbox_url}" readonly>
                            <button class="btn btn-outline-secondary" type="button" onclick="copyDropboxUrl()">
                                <i class="bi bi-clipboard"></i> ${dropboxLabels.copy_button}
                            </button>
                        </div>
                        <div class="form-text">${dropboxLabels.info_text}</div>
                    </div>
                    
                    <div class="mb-4">
                        <h6>${dropboxLabels.password_section}</h6>
                        ${folder.has_password ? `
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle"></i> ${dropboxLabels.password_enabled}
                            </div>
                            <form method="POST" action="/files/folder/${folderId}/dropbox-settings" class="mb-2">
                                <input type="hidden" name="action" value="remove_password">
                                <button type="submit" class="btn btn-outline-danger">
                                    <i class="bi bi-x-circle"></i> ${dropboxLabels.password_remove}
                                </button>
                            </form>
                        ` : ''}
                        <form method="POST" action="/files/folder/${folderId}/dropbox-settings">
                            <input type="hidden" name="action" value="set_password">
                            <div class="mb-3">
                                <label for="dropboxPassword" class="form-label">${folder.has_password ? dropboxLabels.password_label_change : dropboxLabels.password_label_set}</label>
                                <input type="password" class="form-control" id="dropboxPassword" name="password" placeholder="${dropboxLabels.password_keep_hint}">
                            </div>
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-key"></i> ${folder.has_password ? dropboxLabels.password_change : dropboxLabels.password_set}
                            </button>
                        </form>
                    </div>
                    
                    <div class="mb-4">
                        <h6>${dropboxLabels.regenerate_title}</h6>
                        <form method="POST" action="/files/folder/${folderId}/dropbox-settings">
                            <input type="hidden" name="action" value="regenerate_token">
                            <button type="submit" class="btn btn-outline-warning">
                                <i class="bi bi-arrow-clockwise"></i> ${dropboxLabels.regenerate}
                            </button>
                        </form>
                        <div class="form-text text-warning">${dropboxLabels.regenerate_hint}</div>
                    </div>
                    
                    <div class="mb-4">
                        <h6>${dropboxLabels.disable_title}</h6>
                        <form method="POST" action="/files/folder/${folderId}/disable-dropbox">
                            <button type="submit" class="btn btn-outline-danger" data-confirm-delete="${FILES_I18N.alerts.dropbox_disable}">
                                <i class="bi bi-x-circle"></i> ${dropboxLabels.disable}
                            </button>
                        </form>
                    </div>
                `;
            } else {
                content.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle"></i>
                        ${FILES_I18N.messages.settings_error}
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Error loading dropbox settings:', error);
            content.innerHTML = `
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle"></i>
                    ${FILES_I18N.messages.settings_error}: ${error.message}
                </div>
            `;
        });
}

function copyDropboxUrl() {
    const urlInput = document.getElementById('dropboxUrl');
    urlInput.select();
    document.execCommand('copy');
    
    // Show feedback
    const btn = event.target.closest('button');
    const originalHTML = btn.innerHTML;
    btn.innerHTML = `<i class="bi bi-check"></i> ${FILES_I18N.modals.dropbox.copy_success}`;
    btn.classList.add('btn-success');
    btn.classList.remove('btn-outline-secondary');
    
    setTimeout(() => {
        btn.innerHTML = originalHTML;
        btn.classList.remove('btn-success');
        btn.classList.add('btn-outline-secondary');
    }, 2000);
}

// ===== Umbenennen & Freigaben =====
function openShareDialog(type, id) {
    const shareLabels = FILES_I18N.modals.share;
    const title = type === 'file' ? shareLabels.title_file : shareLabels.title_folder;
    const formAction = type === 'file' ? `/files/file/${id}/share` : `/files/folder/${id}/share`;
    const html = `
        <form method="POST" action="${formAction}">
            <div class="mb-3">
                <label class="form-label">${shareLabels.password_label}</label>
                <input type="password" name="password" class="form-control">
                <div class="form-text">${shareLabels.password_help}</div>
            </div>
            <div class="mb-3">
                <label class="form-label">${shareLabels.expires_label}</label>
                <input type="datetime-local" name="expires_at" class="form-control">
                <div class="form-text">${shareLabels.expires_help}</div>
            </div>
            <div class="alert alert-info">
                <i class="bi bi-info-circle"></i> ${shareLabels.info_text}
            </div>
            <div class="d-flex gap-2">
                <button type="submit" class="btn btn-primary"><i class="bi bi-share"></i> ${shareLabels.create_button}</button>
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">${shareLabels.close_button}</button>
            </div>
        </form>`;
    showSimpleModal(title, html);
}

function openShareSettings(type, id) {
    const shareLabels = FILES_I18N.modals.share;
    const endpoint = type === 'file' ? `/files/file/${id}/share-settings` : `/files/folder/${id}/share-settings`;
    fetch(endpoint)
        .then(r => r.json())
        .then(data => {
            if (!data.success) { return; }
            const item = data.item;
            const formAction = type === 'file' ? `/files/file/${id}/share-settings` : `/files/folder/${id}/share-settings`;
            const html = `
                <div class="mb-3">
                    <label class="form-label">${shareLabels.link_label}</label>
                    <div class="input-group">
                        <input type="text" class="form-control" value="${item.share_url}" readonly>
                        <button class="btn btn-outline-secondary" type="button" onclick="navigator.clipboard.writeText('${item.share_url}')"><i class="bi bi-clipboard"></i></button>
                    </div>
                </div>
                <form method="POST" action="${formAction}">
                    <div class="mb-3">
                        <label class="form-label">${shareLabels.password_keep_label}</label>
                        <input type="password" class="form-control" name="password">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">${shareLabels.expires_label_compact}</label>
                        <input type="datetime-local" class="form-control" name="expires_at" value="${item.expires_at ? item.expires_at.substring(0,16) : ''}">
                    </div>
                    ${item.share_name ? `<div class="alert alert-info mb-3"><i class="bi bi-info-circle"></i> ${shareLabels.guest_info.replace('{name}', item.share_name)}</div>` : ''}
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary"><i class="bi bi-save"></i> ${shareLabels.save_button}</button>
                        <button type="submit" name="action" value="disable" class="btn btn-outline-danger"><i class="bi bi-slash-circle"></i> ${shareLabels.disable_button}</button>
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">${shareLabels.close_button}</button>
                    </div>
                </form>`;
            showSimpleModal(shareLabels.edit_title, html);
        });
}

function showSimpleModal(title, bodyHtml) {
    let modal = document.getElementById('simpleModal');
    if (!modal) {
        const tpl = document.createElement('div');
        tpl.innerHTML = `
        <div class="modal fade" id="simpleModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title"></h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body"></div>
                </div>
            </div>
        </div>`;
        document.body.appendChild(tpl.firstElementChild);
        modal = document.getElementById('simpleModal');
    }
    modal.querySelector('.modal-title').innerText = title;
    modal.querySelector('.modal-body').innerHTML = bodyHtml;
    const bsModal = new bootstrap.Modal(modal);
    bsModal.show();
}
</script>
{% endblock %}



